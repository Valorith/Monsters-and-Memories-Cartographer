<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Settings - MMC</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    #app {
      display: flex;
      flex-direction: column;
    }
    
    /* Avatar upload progress animation */
    #upload-progress-bar {
      background: linear-gradient(90deg, #4a7c59, #5fa772, #4a7c59);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .account-header {
      background: #2d2d2d;
      color: white;
      padding: 1rem 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      width: 100%;
    }
    
    .header-content {
      width: 100%;
      margin: 0;
      padding: 0 2rem;
      box-sizing: border-box;
    }
    
    .back-link {
      color: #FFD700;
      text-decoration: none;
      font-size: 0.9rem;
      display: inline-block;
      margin-bottom: 0.5rem;
    }
    
    .back-link:hover {
      color: #FFA500;
    }
    
    .account-header h1 {
      margin: 0;
      font-size: 2rem;
      font-family: 'Cinzel', serif;
      background: linear-gradient(135deg, #FFD700, #FFA500, #FF8C00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .account-container {
      width: 100%;
      margin: 0;
      padding: 2rem;
      display: flex;
      gap: 2rem;
      box-sizing: border-box;
      align-items: flex-start;
      min-height: 0;
    }
    
    .account-sidebar {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 1rem;
      height: fit-content;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 2rem;
      max-height: calc(100vh - 4rem);
      overflow-y: auto;
      width: 250px;
      flex-shrink: 0;
      align-self: flex-start;
    }
    
    .nav-item {
      display: block;
      padding: 0.75rem 1rem;
      color: #ccc;
      text-decoration: none;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 1rem;
    }
    
    .nav-item:hover {
      background: #3a3a3a;
      color: white;
    }
    
    .nav-item.active {
      background: #4a7c59;
      color: white;
    }
    
    .account-content {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      min-width: 0;
      overflow-x: auto;
      width: 100%;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
      margin-top: 0;
      margin-bottom: 0;
    }
    
    .tab-content {
      display: none;
      width: 100%;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Message div */
    #message {
      width: 100%;
      margin-bottom: 1rem;
    }
    
    /* Tab headings */
    .tab-content > h2 {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    /* Admin tab specific */
    #admin-tab > * {
      max-width: 100%;
      width: 100%;
    }
    
    /* Dynamic width classes for when editors are active */
    .account-content {
      transition: max-width 0.3s ease;
    }
    
    .account-content.editor-active {
      max-width: calc(100vw - 350px) !important;
      padding: 1rem !important;
    }
    
    .account-content.both-editors-active {
      max-width: calc(100vw - 350px) !important;
      padding: 1rem !important;
    }
    
    /* Profile card */
    .profile-card {
      background: #3a3a3a;
      border-radius: 8px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    /* Settings sections */
    .settings-section,
    .preference-section {
      max-width: 800px;
      width: 100%;
      margin-bottom: 2rem;
    }
    
    .profile-xp-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid #555;
    }
    
    .xp-level-display {
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    
    .level-badge-large {
      background: radial-gradient(circle, #FFD700, #FFA500);
      border: 3px solid #8B4513;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    
    .level-badge-large .level-number {
      font-size: 32px;
      font-weight: bold;
      color: #2a1810;
      font-family: 'Cinzel', serif;
    }
    
    .level-badge-large .level-label {
      font-size: 12px;
      color: #2a1810;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
    }
    
    .xp-info-display {
      flex: 1;
    }
    
    .xp-info-display .xp-text {
      display: flex;
      align-items: baseline;
      gap: 6px;
      color: #FFD700;
      font-family: 'Cinzel', serif;
      margin-bottom: 0.5rem;
    }
    
    .xp-info-display .current-xp {
      font-size: 24px;
      font-weight: bold;
    }
    
    .xp-info-display .separator {
      font-size: 20px;
      color: #FFA500;
    }
    
    .xp-info-display .next-level-xp {
      font-size: 20px;
      color: #FFA500;
    }
    
    .xp-info-display .xp-label {
      font-size: 16px;
      margin-left: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .xp-info-display .xp-bar-wrapper {
      width: 100%;
      height: 24px;
      margin-bottom: 0.5rem;
    }
    
    .xp-info-display .xp-bar-background {
      width: 100%;
      height: 100%;
      background: #1a1a1a;
      border: 2px solid #8B4513;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .xp-info-display .xp-bar-fill {
      height: 100%;
      background: linear-gradient(to right, #FF6B35, #FFD700, #FFA500);
      transition: width 0.3s ease;
    }
    
    .xp-rank {
      color: #999;
      font-size: 0.9rem;
    }
    
    .profile-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: #3a3a3a;
      border-radius: 8px;
      padding: 1.5rem;
      border: 1px solid #444;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      background: #424242;
      border-color: #555;
      transform: translateY(-2px);
    }
    
    .stat-icon {
      font-size: 2.5rem;
      opacity: 0.8;
    }
    
    .stat-info {
      flex: 1;
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #FFD700;
      font-family: 'Cinzel', serif;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    @media (max-width: 768px) {
      .profile-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .xp-level-display {
        flex-direction: column;
        text-align: center;
      }
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #4a7c59;
    }
    
    .admin-badge {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 6px 16px;
      border-radius: 4px;
      font-size: 0.85rem;
      align-self: flex-start;
      white-space: nowrap;
    }
    
    .preference-section {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #444;
    }
    
    .preference-section:last-child {
      border-bottom: none;
    }
    
    .preference-item {
      margin-bottom: 1rem;
    }
    
    .preference-item label {
      display: block;
      color: #ccc;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .preference-item select {
      width: 100%;
      max-width: 300px;
      padding: 0.75rem;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 1rem;
      background: #3a3a3a;
      color: #e0e0e0;
    }
    
    .btn {
      background: #4a7c59;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    
    .btn:hover {
      background: #3a6249;
    }
    
    .secondary-btn {
      background: #6c757d;
    }
    
    .secondary-btn:hover {
      background: #5a6268;
    }
    
    .danger-btn {
      background: #dc3545;
    }
    
    .danger-btn:hover {
      background: #c82333;
    }
    
    .loading {
      text-align: center;
      padding: 4rem;
      color: #ccc;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    .admin-table th {
      background: #3a3a3a;
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      color: #e0e0e0;
      border-bottom: 2px solid #444;
    }
    
    .admin-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #444;
      color: #ccc;
      vertical-align: middle;
    }
    
    .admin-table td img {
      display: block;
      margin: 0 auto;
      object-fit: cover;
    }
    
    .admin-table tr:hover {
      background: #333;
    }
    
    .sub-header {
      font-size: 1.2rem;
      font-weight: 600;
      color: #FFD700;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #444;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
      padding: 1rem 0;
    }
    
    .pagination-btn {
      background: #4a7c59;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s;
    }
    
    .pagination-btn:hover:not(:disabled) {
      background: #5a8d69;
    }
    
    .pagination-btn:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    
    .pagination-info {
      color: #ccc;
      font-size: 0.9rem;
    }
    
    .vote-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
    }
    
    .vote-btn {
      background: #444;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
      min-width: 35px;
    }
    
    .vote-btn:hover {
      background: #555;
    }
    
    .vote-btn.upvote {
      background: #444;
    }
    
    .vote-btn.upvote.active {
      background: #4CAF50;
    }
    
    .vote-btn.downvote {
      background: #444;
    }
    
    .vote-btn.downvote.active {
      background: #f44336;
    }
    
    .vote-score {
      font-weight: bold;
      color: #FFD700;
      min-width: 40px;
      text-align: center;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s;
      overflow-y: auto;
      align-items: flex-start;
      justify-content: center;
      padding: 2rem 0;
    }
    
    .modal-content {
      background-color: #2a2a2a;
      margin: auto;
      padding: 0;
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 12px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      animation: slideIn 0.3s;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #444;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05));
      border-radius: 12px 12px 0 0;
    }
    
    .modal-header h2 {
      margin: 0;
      color: #FFD700;
      font-size: 1.5rem;
      font-family: 'Cinzel', serif;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-body h3 {
      color: #FFD700;
      margin-bottom: 0.5rem;
    }
    
    .modal-body p {
      color: #ccc;
      margin-bottom: 1rem;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #ccc;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .close-btn:hover {
      background: #444;
      color: white;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { 
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .small-btn {
      background: #4a7c59;
      color: white;
      border: none;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    
    .small-btn:hover {
      background: #3a6249;
    }
    
    .small-btn.secondary-btn {
      background: #6c757d;
    }
    
    .small-btn.secondary-btn:hover {
      background: #5a6268;
    }
    
    .small-btn.danger-btn {
      background: #dc3545;
    }
    
    .small-btn.danger-btn:hover {
      background: #c82333;
    }
    
    .small-btn.warning-btn {
      background: #FF6B35;
    }
    
    .small-btn.warning-btn:hover {
      background: #FF5722;
    }
    
    .small-btn.info-btn {
      background: #17a2b8;
    }
    
    .small-btn.info-btn:hover {
      background: #138496;
    }
    
    .small-btn.success-btn {
      background: #28a745;
    }
    
    .small-btn.success-btn:hover {
      background: #218838;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-start;
      align-items: center;
    }
    
    .action-group {
      display: flex;
      gap: 0.25rem;
    }
    
    .admin-actions {
      border-left: 2px solid #444;
      padding-left: 0.5rem;
      margin-left: 0.25rem;
    }
    
    .btn-icon {
      margin-right: 0.25rem;
      display: inline-block;
    }
    /* Voting Status Bar Styles */
    .vote-status-row {
      background: transparent !important;
    }
    
    .vote-status-row:hover {
      background: transparent !important;
    }
    
    .vote-status-row td {
      border: none !important;
      border-top: none !important;
      padding-top: 0 !important;
      padding-bottom: 0.75rem !important;
      background: transparent !important;
    }
    
    /* Remove bottom border from POI data rows when followed by status bar */
    .admin-table tbody tr:has(+ .vote-status-row) td {
      border-bottom: none !important;
    }
    
    /* Fallback for browsers without :has() support */
    .admin-table tbody tr.poi-data-row td {
      border-bottom: none !important;
    }
    
    /* Restore border for status rows followed by data rows */
    .admin-table tbody tr.vote-status-row + tr.poi-data-row td {
      border-top: 1px solid #dee2e6 !important;
    }
    
    .vote-status-bar {
      width: 100%;
      padding: 0 1rem;
    }
    
    .vote-bar-track {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
    }
    
    .vote-bar-container {
      flex: 1;
      height: 16px;
      background: #f8f8f8;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      border: 1px solid #ddd;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .vote-bar-fill {
      position: absolute;
      height: 100%;
      transition: all 0.3s ease;
      opacity: 0.9;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
      z-index: 0;
    }
    
    .vote-bar-marker {
      position: absolute;
      width: 2px;
      height: 100%;
      background: #333;
      top: 0;
      transform: translateX(-50%);
      z-index: 2;
      box-shadow: 0 0 2px rgba(0,0,0,0.3);
    }
    
    .vote-bar-center {
      position: absolute;
      width: 2px;
      height: 100%;
      background: #333;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
      z-index: 1;
      box-shadow: 0 0 1px rgba(0,0,0,0.5);
    }
    
    .vote-label {
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      min-width: 85px;
      text-align: center;
    }
    
    .vote-label.reject {
      color: #dc3545;
    }
    
    .vote-label.approve {
      color: #28a745;
    }
    
    .xp-input {
      width: 80px;
      padding: 0.25rem 0.5rem;
      border: 1px solid #555;
      border-radius: 4px;
      font-size: 1rem;
      text-align: center;
      background: #2d2d2d;
      color: #e0e0e0;
    }
    
    .xp-input:focus {
      outline: none;
      border-color: #4a7c59;
      background: #1a1a1a;
      box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.3);
    }
    
    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }
    
    .admin-section {
      background: #3a3a3a;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid #444;
      width: 100%;
      max-width: 100%;
    }
    
    .admin-section h3 {
      margin: 0 0 0.5rem 0;
      color: #FFD700;
      font-size: 1.3rem;
    }
    
    #toggle-admin-btn.small-btn {
      background: #6f42c1;
    }
    
    #toggle-admin-btn.small-btn:hover {
      background: #5930a1;
    }
    
    /* Button styles for POI type management */
    .primary-btn {
      background: #4a7c59;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .primary-btn:hover:not(:disabled) {
      background: #5a8d69;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(74, 124, 89, 0.3);
    }
    
    .primary-btn:disabled,
    .secondary-btn:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }
    
    .secondary-btn {
      background: #555;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s;
    }
    
    .secondary-btn:hover {
      background: #666;
    }
    
    /* Form styles */
    .form-group {
      margin-bottom: 1.5rem;
      max-width: 600px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #e0e0e0;
      font-weight: 500;
    }
    
    .form-group input[type="text"],
    .form-group input[type="file"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #555;
      border-radius: 4px;
      background: #1a1a1a;
      color: #e0e0e0;
      font-size: 1rem;
    }
    
    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #4a7c59;
      box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.2);
    }
    
    .radio-group {
      display: flex;
      gap: 1.5rem;
    }
    
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      margin-bottom: 0;
    }
    
    .radio-group input[type="radio"] {
      cursor: pointer;
    }
    
    .help-text {
      font-size: 0.85rem;
      color: #999;
      margin-top: 0.25rem;
    }
    
    .help-text a {
      color: #4a7c59;
      text-decoration: none;
    }
    
    .help-text a:hover {
      text-decoration: underline;
    }
    
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }
    
    /* Emoji picker styles */
    .emoji-category-btn {
      background: #2d2d2d;
      border: 1px solid #444;
      font-size: 1.5rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
      min-width: 50px;
    }
    
    .emoji-category-btn:hover {
      background: #3d3d3d;
      border-color: #FFD700;
      transform: translateY(-1px);
    }
    
    .emoji-category-btn.active {
      background: #4a7c59;
      border-color: #FFD700;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }
    
    /* POI Type Modal specific styles */
    #poi-type-modal .modal-content {
      max-width: 800px !important;
      width: 90% !important;
    }
    
    #emoji-picker {
      margin-top: 1rem;
      border: 1px solid #555;
      border-radius: 8px;
      background: #2d2d2d;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    #emoji-grid {
      display: grid !important;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)) !important;
      gap: 0.5rem !important;
      padding: 1rem !important;
      max-height: 400px !important;
      overflow-y: auto !important;
      background: #1a1a1a !important;
    }
    
    /* Icon set buttons */
    .icon-set-btn {
      background: #444;
      color: #e0e0e0;
      border: 1px solid #555;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .icon-set-btn:hover {
      background: #555;
      border-color: #666;
    }
    
    .icon-set-btn.active {
      background: #4a7c59;
      border-color: #5a8d69;
    }
    
    /* Iconify icon grid items */
    .iconify-icon-item {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem;
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
    }
    
    .iconify-icon-item:hover {
      background: #444;
      border-color: #555;
    }
    
    .iconify-icon-item.selected {
      background: #4a7c59;
      border-color: #5a8d69;
    }
    
    /* Ensure SVG icons display properly */
    .iconify-icon-item svg {
      width: 24px;
      height: 24px;
    }
    
    .iconify-icon-item:hover {
      transform: scale(1.1);
    }
    
    .iconify-icon-item.selected {
      transform: scale(1.1);
    }
    
    /* Pagination Styles */
    .pagination-btn {
      padding: 0.5rem 0.75rem;
      margin: 0 0.25rem;
      border: 1px solid #444;
      background: #2d2d2d;
      color: #e0e0e0;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.875rem;
      transition: all 0.2s;
      min-width: 36px;
    }
    
    .pagination-btn:hover:not(:disabled) {
      background: #3d3d3d;
      border-color: #666;
    }
    
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination-btn.active {
      background: #FFD700;
      color: #2a1810;
      border-color: #FFD700;
    }
    
    /* Collapsible Section Styles */
    .admin-section {
      margin-bottom: 1.5rem;
      border: 1px solid #444;
      border-radius: 8px;
      overflow: hidden;
      width: 100%;
    }
    
    .admin-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background: #2d2d2d;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }
    
    .admin-section-header:hover {
      background: #3d3d3d;
    }
    
    .admin-section-header h3 {
      margin: 0;
      color: #FFD700;
    }
    
    .admin-section-header .collapse-icon {
      font-size: 1.2rem;
      transition: transform 0.3s;
      color: #FFD700;
    }
    
    .admin-section.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .admin-section-content {
      padding: 1rem;
      background: #1a1a1a;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
      overflow: hidden;
    }
    
    .admin-section.collapsed .admin-section-content {
      max-height: 0;
      padding: 0 1rem;
    }
    
    /* POI Editor Styles */
    .poi-editor-table {
      font-size: 0.9rem;
      width: 100%;
    }
    
    /* Ensure table containers use full width */
    .table-container {
      width: 100%;
      overflow-x: auto;
    }
    
    #poi-editor-content,
    #item-editor-content {
      width: 100%;
    }
    
    .poi-editor-table td {
      padding: 0.5rem;
      position: relative;
    }
    
    .poi-editor-table input[type="text"],
    .poi-editor-table input[type="number"],
    .poi-editor-table textarea,
    .poi-editor-table select {
      width: 100%;
      padding: 0.35rem 0.5rem;
      border: 1px solid transparent;
      background: transparent;
      color: #e0e0e0;
      font-size: 0.9rem;
      transition: all 0.2s;
      box-sizing: border-box;
      min-width: 0; /* Allow select to shrink properly */
    }
    
    /* Item Editor Styles - matching POI Editor */
    .item-editor-table {
      font-size: 0.9rem;
      width: 100%;
    }
    
    .item-editor-table td {
      padding: 0.5rem;
      position: relative;
      border-bottom: 1px solid #3a3a3a;
    }
    
    .item-editor-table input[type="text"],
    .item-editor-table input[type="number"],
    .item-editor-table textarea,
    .item-editor-table select {
      width: 100%;
      padding: 0.35rem 0.5rem;
      border: 1px solid transparent;
      background: transparent;
      color: #e0e0e0;
      font-size: 0.9rem;
      transition: all 0.2s;
      box-sizing: border-box;
      min-width: 0;
    }
    
    /* Add hover effect to item editor table rows */
    .item-editor-table tr:hover {
      background: #333;
    }
    
    /* Cell hover effect for both editors */
    .poi-editor-table td:hover,
    .item-editor-table td:hover {
      outline: 2px solid #4a7c59;
      outline-offset: -2px;
      background: rgba(74, 124, 89, 0.1);
    }
    
    /* Match POI editor focus styles */
    .item-editor-table input[type="text"]:focus,
    .item-editor-table input[type="number"]:focus,
    .item-editor-table textarea:focus,
    .item-editor-table select:focus {
      outline: none;
      border-color: #4a7c59;
      background: #2d2d2d;
    }
    
    .poi-editor-table input[type="number"] {
      text-align: center;
      width: 100%;
    }
    
    .item-editor-table input[type="number"] {
      text-align: center;
      width: 100% !important;
      box-sizing: border-box;
    }
    
    .poi-editor-table input[type="text"]:focus,
    .poi-editor-table input[type="number"]:focus,
    .poi-editor-table textarea:focus,
    .poi-editor-table select:focus {
      outline: none;
      border-color: #4a7c59;
      background: #2d2d2d;
    }
    
    .poi-editor-table textarea {
      resize: vertical;
      min-height: 50px;
    }
    
    .poi-editor-table input[type="checkbox"] {
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    
    .poi-editor-table .cell-changed {
      background: rgba(255, 215, 0, 0.1) !important;
      border: 1px solid rgba(255, 215, 0, 0.3) !important;
      position: relative;
    }
    
    .poi-editor-table .cell-changed::after {
      content: '';
      position: absolute;
      top: -1px;
      right: -1px;
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-top: 10px solid #FFD700;
    }
    
    .poi-editor-table tr.marked-for-deletion {
      background: rgba(255, 0, 0, 0.2) !important;
      opacity: 0.8;
    }
    
    .poi-editor-table tr.highlighted-poi {
      position: relative;
      animation: highlightPulse 2s ease-in-out;
    }
    
    .poi-editor-table tr.highlighted-poi td {
      border-top: 3px solid #FFD700 !important;
      border-bottom: 3px solid #FFD700 !important;
      position: relative;
    }
    
    .poi-editor-table tr.highlighted-poi td:first-child {
      border-left: 3px solid #FFD700 !important;
    }
    
    .poi-editor-table tr.highlighted-poi td:last-child {
      border-right: 3px solid #FFD700 !important;
    }
    
    /* Keep the border visible after animation */
    .poi-editor-table tr.highlighted-poi::after {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      border: 3px solid #FFD700;
      pointer-events: none;
      border-radius: 4px;
    }
    
    @keyframes highlightPulse {
      0% { 
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
      }
      50% { 
        box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
      }
      100% { 
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
      }
    }
    
    .poi-editor-table tr.marked-for-deletion td {
      text-decoration: line-through;
      color: #ff6666 !important;
    }
    
    .poi-editor-table tr.marked-for-deletion input,
    .poi-editor-table tr.marked-for-deletion textarea,
    .poi-editor-table tr.marked-for-deletion select,
    .poi-editor-table tr.marked-for-deletion .custom-select-display {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Item Editor Styles */
    .item-editor-table input.inline-edit,
    .item-editor-table select.inline-edit {
      background: transparent;
      border: 1px solid transparent;
      color: inherit;
      font-family: inherit;
      font-size: inherit;
      padding: 0.25rem 0.5rem;
      transition: border-color 0.2s;
    }
    
    .item-editor-table input.inline-edit:focus,
    .item-editor-table select.inline-edit:focus {
      outline: none;
      border-color: #FFD700;
      background: #2d2d2d;
    }
    
    .item-editor-table .cell-changed {
      background: rgba(255, 215, 0, 0.1) !important;
      border: 1px solid rgba(255, 215, 0, 0.3) !important;
      position: relative;
    }
    
    .item-editor-table .cell-changed::after {
      content: '';
      position: absolute;
      top: -1px;
      right: -1px;
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-top: 10px solid #FFD700;
    }
    
    .item-editor-table tr.marked-for-deletion {
      background: rgba(255, 0, 0, 0.2) !important;
      opacity: 0.8;
    }
    
    /* NPC Editor Styles - matching Item Editor */
    .npc-editor-table {
      font-size: 0.9rem;
      width: 100%;
    }
    
    .npc-editor-table td {
      padding: 0.5rem;
      position: relative;
      border-bottom: 1px solid #3a3a3a;
    }
    
    .npc-editor-table input[type="text"],
    .npc-editor-table input[type="number"],
    .npc-editor-table textarea,
    .npc-editor-table select {
      width: 100%;
      padding: 0.35rem 0.5rem;
      border: 1px solid transparent;
      background: transparent;
      color: #e0e0e0;
      font-size: 0.9rem;
      transition: all 0.2s;
      box-sizing: border-box;
      min-width: 0;
    }
    
    /* Add hover effect to NPC editor table rows */
    .npc-editor-table tr:hover {
      background: #333;
    }
    
    /* Cell hover effect for NPC editor */
    .npc-editor-table td:hover {
      outline: 2px solid #4a7c59;
      outline-offset: -2px;
      background: rgba(74, 124, 89, 0.1);
    }
    
    /* Match Item editor focus styles */
    .npc-editor-table input[type="text"]:focus,
    .npc-editor-table input[type="number"]:focus,
    .npc-editor-table textarea:focus,
    .npc-editor-table select:focus {
      outline: none;
      border-color: #4a7c59;
      background: #2d2d2d;
    }
    
    .npc-editor-table input[type="number"] {
      text-align: center;
      width: 100% !important;
      box-sizing: border-box;
    }
    
    .npc-editor-table input.inline-edit,
    .npc-editor-table select.inline-edit {
      background: transparent;
      border: 1px solid transparent;
      color: inherit;
      font-family: inherit;
      font-size: inherit;
      padding: 0.25rem 0.5rem;
      transition: border-color 0.2s;
    }
    
    .npc-editor-table input.inline-edit:focus,
    .npc-editor-table select.inline-edit:focus {
      outline: none;
      border-color: #FFD700;
      background: #2d2d2d;
    }
    
    .npc-editor-table .cell-changed {
      background: rgba(255, 215, 0, 0.1) !important;
      border: 1px solid rgba(255, 215, 0, 0.3) !important;
      position: relative;
    }
    
    .npc-editor-table .cell-changed::after {
      content: '';
      position: absolute;
      top: -1px;
      right: -1px;
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-top: 10px solid #FFD700;
    }
    
    .npc-editor-table tr.marked-for-deletion {
      background: rgba(255, 0, 0, 0.2) !important;
      opacity: 0.8;
    }
    
    /* NPC and Item stats styling */
    .npc-stats,
    .item-stats {
      display: flex;
      gap: 2rem;
      padding: 1rem;
      background: #1a1a1a;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .npc-stat,
    .item-stat {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .npc-stat-value,
    .item-stat-value {
      font-weight: bold;
      color: #FFD700;
    }
    
    .item-editor-table tr.marked-for-deletion input,
    .item-editor-table tr.marked-for-deletion select {
      text-decoration: line-through;
      opacity: 0.6;
      pointer-events: none;
    }
    
    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    
    .delete-btn:hover {
      background: #c82333;
    }
    
    .delete-btn.undo {
      background: #28a745;
    }
    
    .delete-btn.undo:hover {
      background: #218838;
    }
    
    .poi-editor-table tbody tr:hover {
      background: rgba(74, 124, 89, 0.05);
    }
    
    .poi-editor-table td {
      transition: background 0.2s;
    }
    
    .poi-editor-table input:hover:not(:focus),
    .poi-editor-table textarea:hover:not(:focus),
    .poi-editor-table select:hover:not(:focus) {
      background: rgba(74, 124, 89, 0.05);
      border-color: rgba(74, 124, 89, 0.3);
    }
    
    .poi-editor-table .invalid-type {
      background: rgba(255, 0, 0, 0.2) !important;
      border: 1px solid rgba(255, 0, 0, 0.5) !important;
    }
    
    .poi-type-select {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .poi-type-icon {
      font-size: 1.2rem;
      text-align: center;
      vertical-align: middle;
    }
    
    .poi-type-icon span {
      display: inline-block;
      line-height: 1;
    }
    
    .poi-type-icon img {
      display: inline-block;
      vertical-align: middle;
    }
    
    /* POI Editor enhancements */
    .poi-editor-search {
      flex: 1;
      max-width: 300px;
      padding: 0.5rem 1rem;
      border: 1px solid #555;
      border-radius: 4px;
      background: #2d2d2d;
      color: #e0e0e0;
      font-size: 0.9rem;
    }
    
    .poi-editor-search:focus {
      outline: none;
      border-color: #4a7c59;
    }
    
    .poi-editor-table th {
      cursor: pointer;
      user-select: none;
      position: relative;
      transition: background 0.2s;
    }
    
    .poi-editor-table th:hover {
      background: rgba(74, 124, 89, 0.2);
    }
    
    .poi-editor-table th.sorted-asc::after,
    .poi-editor-table th.sorted-desc::after {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
    }
    
    .poi-editor-table th.sorted-asc::after {
      content: '▲';
    }
    
    .poi-editor-table th.sorted-desc::after {
      content: '▼';
    }
    
    .export-btn {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.2s;
    }
    
    .export-btn:hover {
      background: #138496;
    }
    
    .poi-stats {
      display: flex;
      gap: 1rem;
      align-items: center;
      color: #999;
      font-size: 0.875rem;
    }
    
    .poi-stat {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .poi-stat-value {
      font-weight: bold;
      color: #e0e0e0;
    }
    
    /* Loading animation for reload button */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    /* Voting Tab Styles */
    .voting-stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    
    .voting-stat-card {
      background: #3a3a3a;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .voting-stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .voting-stat-card.active {
      border-color: #FFD700;
      background: #4a4a4a;
    }
    
    .voting-stat-card .stat-main {
      padding: 1rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
    }
    
    .voting-stat-card .stat-icon {
      font-size: 1.5rem;
    }
    
    .voting-stat-card .stat-info {
      text-align: center;
      width: 100%;
    }
    
    .voting-stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #FFD700;
      line-height: 1;
    }
    
    .voting-stat-card .stat-label {
      font-size: 0.8rem;
      color: #ccc;
      margin-top: 0.2rem;
    }
    
    .voting-stat-card .stat-pending {
      background: #FF6B00;
      color: white;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: bold;
      text-align: center;
      width: 100%;
    }
    
    .voting-stat-card .stat-pending.none {
      background: #2d5a2d;
      color: #a8d5a8;
    }
    
    .voting-controls {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .filter-group label {
      font-size: 0.875rem;
      color: #999;
    }
    
    .proposals-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .proposal-card {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 1.5rem;
      border: 1px solid #444;
      transition: all 0.2s;
    }
    
    .proposal-card:hover {
      border-color: #4a7c59;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .proposal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    
    .proposal-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #FFD700;
      margin-bottom: 0.5rem;
    }
    
    .proposal-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.875rem;
      color: #999;
    }
    
    .proposal-type {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: rgba(74, 124, 89, 0.2);
      color: #4a7c59;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .proposal-content {
      margin-bottom: 1rem;
    }
    
    .proposal-voting {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #444;
    }
    
    .vote-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .vote-btn {
      background: #3a3a3a;
      border: 1px solid #555;
      color: #e0e0e0;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }
    
    .vote-btn:hover {
      background: #444;
    }
    
    .vote-btn.upvote {
      color: #4CAF50;
    }
    
    .vote-btn.upvote.active {
      background: rgba(76, 175, 80, 0.2);
      border-color: #4CAF50;
    }
    
    .vote-btn.downvote {
      color: #f44336;
    }
    
    .vote-btn.downvote.active {
      background: rgba(244, 67, 54, 0.2);
      border-color: #f44336;
    }
    
    .vote-score {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .vote-score.positive {
      color: #4CAF50;
    }
    
    .vote-score.negative {
      color: #f44336;
    }
    
    .proposal-actions {
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
    }
    
    .proposal-status {
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: bold;
    }
    
    .proposal-status.pending {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }
    
    .proposal-status.approved {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    .proposal-status.rejected {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }
    
    .proposal-status.withdrawn {
      background: rgba(158, 158, 158, 0.2);
      color: #9e9e9e;
    }
    
    /* Modal form styling */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #e0e0e0;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 0.5rem;
      background: #1a1a1a;
      border: 1px solid #555;
      border-radius: 4px;
      color: #e0e0e0;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #4a7c59;
      box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.2);
    }
    
    .form-control:disabled {
      background: #2d2d2d;
      color: #999;
      cursor: not-allowed;
    }
    
    select.form-control {
      cursor: pointer;
    }
    
    select.form-control option {
      background: #1a1a1a;
      color: #e0e0e0;
    }
    
    textarea.form-control {
      resize: vertical;
      min-height: 60px;
    }
    
    /* Radio group styling */
    .radio-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0;
      cursor: pointer;
      color: #ccc;
    }
    
    .radio-group input[type="radio"] {
      cursor: pointer;
    }
    
    .radio-group label:hover {
      color: #e0e0e0;
    }
    
    /* Number input styling */
    input[type="number"].form-control {
      -moz-appearance: textfield;
    }
    
    input[type="number"].form-control::-webkit-outer-spin-button,
    input[type="number"].form-control::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Grid layout for stat inputs */
    .stat-inputs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.5rem;
    }
    
    /* Placeholder styling */
    .form-control::placeholder {
      color: #666;
      opacity: 1;
    }
    
    /* Focus states for better accessibility */
    .form-control:focus,
    .vote-btn:focus,
    .btn:focus {
      outline: 2px solid #4a7c59;
      outline-offset: 2px;
    }
    
    /* Proposal form specific styles */
    #proposal-form-content {
      background: #2d2d2d;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    
    #proposal-notes {
      background: #1a1a1a;
      border: 1px solid #444;
    }
    
    #proposal-notes:focus {
      border-color: #4a7c59;
    }
    
    /* Table loading state */
    .poi-editor-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: 8px;
    }
    
    .poi-editor-table-container {
      position: relative;
    }
    
    /* Custom POI Type Select Styles */
    .custom-poi-type-select {
      position: relative;
    }
    
    .custom-select-display {
      transition: all 0.2s;
    }
    
    .custom-select-display:hover {
      background: rgba(74, 124, 89, 0.05) !important;
      border-color: rgba(74, 124, 89, 0.3) !important;
    }
    
    .custom-select-dropdown {
      scrollbar-width: thin;
      scrollbar-color: #555 #2d2d2d;
    }
    
    .custom-select-dropdown::-webkit-scrollbar {
      width: 8px;
    }
    
    .custom-select-dropdown::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    
    .custom-select-dropdown::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }
    
    .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
    
    /* Resizable columns for POI Editor */
    .poi-editor-table {
      table-layout: fixed;
    }
    
    .poi-editor-table th {
      position: relative;
      user-select: none;
    }
    
    .column-resizer {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      background: transparent;
      z-index: 10;
    }
    
    .column-resizer:hover,
    .column-resizer.resizing {
      background: #4a7c59;
    }
    
    .poi-editor-table th.resizing {
      background: #3a3a3a;
    }
    
    /* Twemoji styling */
    img.twemoji-icon {
      height: 1.2em;
      width: 1.2em;
      margin: 0 .05em 0 .1em;
      vertical-align: -0.1em;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .account-container {
        flex-direction: column;
        padding: 1rem;
      }
      
      .account-sidebar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem;
        position: static;
      }
      
      .nav-item {
        flex: 1;
        min-width: 120px;
        padding: 0.5rem;
        font-size: 0.9rem;
      }
      
      .account-content {
        padding: 1rem;
      }
      
      .admin-section-content {
        padding: 1rem;
      }
      
      .tab-content {
        max-width: 100%;
      }
    }
    
    /* Ensure tables don't break layout */
    .admin-table {
      width: 100%;
      table-layout: auto;
    }
    
    /* Table containers should handle overflow */
    .poi-editor-table-container,
    .item-editor-table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Prevent content from overflowing */
    .admin-section-content {
      overflow-x: auto;
    }
    
    /* Fix button groups on small screens */
    @media (max-width: 1024px) {
      .poi-editor-search,
      .item-editor-search {
        max-width: 200px;
      }
      
      .export-btn span {
        display: none;
      }
      
      .export-btn::after {
        content: 'CSV';
      }
    }
    
    /* Ensure all inputs are properly contained */
    input, select, textarea {
      max-width: 100%;
      box-sizing: border-box;
    }
    
    /* Fix search bar layouts */
    #poi-search, #item-search {
      flex: 1;
      min-width: 0;
      max-width: 100%;
    }
    
    /* Admin section headers should not overflow */
    .admin-section-header h3 {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    /* Admin tab full width */
    #admin-tab {
      padding: 0;
    }
    
    #admin-tab > * {
      width: 100%;
    }
    
    /* Ensure flex containers wrap properly */
    .admin-section-content > div:first-child {
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    /* Fix button groups */
    div[style*="display: flex"][style*="gap"] {
      flex-wrap: wrap;
    }
    
    
    /* Stats cards container */
    .profile-stats {
      max-width: 800px;
      width: 100%;
    }
    
    /* Fix proposal diff overflow */
    .proposal-content {
      overflow: hidden;
      width: 100%;
    }
    
    .proposal-diff-grid {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      gap: 1rem !important;
      overflow: hidden;
      width: 100%;
    }
    
    .proposal-diff-grid > div {
      min-width: 0;
      overflow: hidden;
      padding: 0.75rem !important;
      border-radius: 4px;
      word-break: break-word;
    }
    
    /* Ensure list items in proposals wrap properly */
    .proposal-content ul {
      padding-left: 1.5rem;
      margin: 0;
    }
    
    .proposal-content li {
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      margin-bottom: 0.5rem;
    }
    
    /* Fix flex items in proposal headers */
    .proposal-content div[style*="display: flex"] {
      flex-wrap: wrap;
    }
    
    .proposal-content span[style*="margin-right"] {
      white-space: nowrap;
    }
    
    .proposal-content p {
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      hyphens: auto;
      margin: 0.5rem 0;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* For very long unbreakable strings */
    .proposal-content p:hover {
      overflow: visible;
      word-break: break-all;
    }
    
    .proposal-content strong {
      display: inline-block;
      min-width: fit-content;
      margin-right: 0.5rem;
    }
    
    /* Equal spacing for diff sections */
    .proposal-card {
      container-type: inline-size;
    }
    
    .proposal-diff-grid > div:first-child {
      background: rgba(255, 0, 0, 0.1) !important;
    }
    
    .proposal-diff-grid > div:last-child {
      background: rgba(0, 255, 0, 0.1) !important;
    }
    
    /* Vote status bar */
    .vote-status-bar {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #444;
    }
    
    .vote-bar-container {
      position: relative;
      height: 28px;
      background: #1a1a1a;
      border-radius: 14px;
      overflow: hidden;
      border: 2px solid #333;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      margin: 0 2px;
    }
    
    
    .vote-bar-track {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      overflow: hidden;
    }
    
    .vote-bar-left,
    .vote-bar-right {
      flex: 1;
      position: relative;
      background: #2a2a2a;
    }
    
    .vote-bar-left {
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), rgba(0, 0, 0, 0));
    }
    
    .vote-bar-right {
      background: linear-gradient(90deg, rgba(0, 0, 0, 0), rgba(74, 222, 128, 0.1));
    }
    
    
    .vote-bar-fill {
      position: absolute;
      top: 0;
      bottom: 0;
      transition: all 0.3s ease;
      height: 100%;
      z-index: 1;
    }
    
    .vote-bar-fill.positive {
      left: 50%;
      background: linear-gradient(90deg, #4ade80, #22c55e);
      border-radius: 0;
      box-shadow: 0 0 8px rgba(74, 222, 128, 0.5);
    }
    
    .vote-bar-fill.negative {
      right: 50%;
      background: linear-gradient(90deg, #dc2626, #ef4444);
      border-radius: 0;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }
    
    .vote-bar-labels {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    
    .vote-bar-labels .label-left {
      color: #ef4444;
      font-weight: 600;
    }
    
    .vote-bar-labels .label-center {
      color: #999;
      font-size: 0.75rem;
    }
    
    .vote-bar-labels .label-right {
      color: #4ade80;
      font-weight: 600;
    }
    
    .vote-bar-markers {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 5;
    }
    
    .vote-bar-marker {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: #fff;
      font-weight: 700;
      z-index: 10;
      line-height: 1;
      font-family: 'Arial', sans-serif;
      letter-spacing: 0.5px;
      background: rgba(0, 0, 0, 0.95);
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      height: 20px;
      backdrop-filter: blur(4px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }
    
    .vote-bar-marker.left {
      left: 12px;
    }
    
    .vote-bar-marker.center {
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      z-index: 15;
    }
    
    .vote-bar-marker.right {
      right: 12px;
    }
    
    
    /* Pulsing effect for near-threshold scores */
    .vote-bar-fill.near-threshold {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% {
        opacity: 1;
        box-shadow: none;
      }
      50% {
        opacity: 0.8;
        box-shadow: 0 0 20px currentColor;
      }
    }
    
    .vote-status-text {
      display: flex;
      justify-content: center;
      margin-top: 0.75rem;
    }
    
    .vote-status-text .vote-score {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    
    .vote-status-text .vote-score.positive {
      color: #4ade80;
    }
    
    .vote-status-text .vote-score.negative {
      color: #ef4444;
    }
    
    .vote-status-text .vote-score.neutral {
      color: #999;
    }
    
    /* Responsive proposal diffs */
    @media (max-width: 768px) {
      .proposal-diff-grid {
        grid-template-columns: 1fr !important;
      }
      
      .proposal-card {
        padding: 1rem;
      }
    }
    
    /* Custom Confirmation Dialog */
    .confirm-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease-out;
    }
    
    .confirm-dialog {
      background: #2d2d2d;
      border: 2px solid #4a7c59;
      border-radius: 8px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.3s ease-out;
    }
    
    .confirm-dialog-title {
      color: #FFD700;
      margin: 0 0 1rem 0;
      font-size: 1.5rem;
      font-family: 'Cinzel', serif;
    }
    
    .confirm-dialog-message {
      color: #e0e0e0;
      margin: 0 0 1.5rem 0;
      line-height: 1.5;
    }
    
    .confirm-dialog-buttons {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
    
    .confirm-dialog-btn {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .confirm-dialog-btn-cancel {
      background: #555;
      color: #fff;
    }
    
    .confirm-dialog-btn-cancel:hover {
      background: #666;
    }
    
    .confirm-dialog-btn-confirm {
      background: #dc3545;
      color: #fff;
    }
    
    .confirm-dialog-btn-confirm:hover {
      background: #c82333;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { 
        transform: translateY(-20px);
        opacity: 0;
      }
      to { 
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
  <script src="/safe-html.js"></script>
  <script src="/csrf-helper.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@2.1.0/dist/iconify-icon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/twemoji@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div id="app">
    <header class="account-header">
      <div class="header-content">
        <a href="/" class="back-link">← Back to Maps</a>
        <h1>Account Settings</h1>
      </div>
    </header>

    <div class="account-container" id="account-content" style="display: none;">
      <div class="account-sidebar">
        <button class="nav-item active">👤 Profile</button>
        <button class="nav-item">⚙️ Preferences</button>
        <button class="nav-item">🔒 Privacy & Security</button>
        <button class="nav-item">📍 Custom POIs</button>
        <button class="nav-item" id="voting-tab-btn">🗳️ Voting</button>
        <button class="nav-item" id="admin-tab-btn" style="display: none;">👑 Admin</button>
      </div>

      <div class="account-content">
        <div id="message"></div>
        
        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content active">
          <h2>Profile Information</h2>
          
          <!-- Main Profile Card -->
          <div class="profile-card">
            <div class="profile-header">
              <img id="user-avatar" class="profile-avatar" alt="">
              <div style="flex: 1;">
                <h3 id="user-name"></h3>
                <p id="user-email"></p>
              </div>
              <span id="admin-badge" class="admin-badge" style="display: none;">Administrator</span>
            </div>
            
            <!-- XP and Level Info -->
            <div class="profile-xp-section">
              <div class="xp-level-display">
                <div class="level-badge-large">
                  <div class="level-number" id="user-level">1</div>
                  <div class="level-label">Level</div>
                </div>
                <div class="xp-info-display">
                  <div class="xp-text">
                    <span class="current-xp" id="user-current-xp">0</span>
                    <span class="separator">/</span>
                    <span class="next-level-xp" id="user-next-level-xp">100</span>
                    <span class="xp-label">XP</span>
                  </div>
                  <div class="xp-bar-wrapper">
                    <div class="xp-bar-background">
                      <div class="xp-bar-fill" id="user-xp-bar" style="width: 0%;"></div>
                    </div>
                  </div>
                  <div class="xp-rank" id="user-rank">Rank: #--</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Statistics Section -->
          <div class="profile-stats-grid">
            <div class="stat-card">
              <div class="stat-icon">📍</div>
              <div class="stat-info">
                <div class="stat-value" id="total-pois">0</div>
                <div class="stat-label">POIs Created</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">✅</div>
              <div class="stat-info">
                <div class="stat-value" id="approved-pois">0</div>
                <div class="stat-label">Approved POIs</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">🗳️</div>
              <div class="stat-info">
                <div class="stat-value" id="total-votes">0</div>
                <div class="stat-label">Votes Cast</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Preferences Tab -->
        <div id="preferences-tab" class="tab-content">
          <h2>Preferences</h2>
          
          <div class="preference-section">
            <h3>Profile Customization</h3>
            
            <!-- Profile Picture -->
            <div style="margin-bottom: 2rem;">
              <h4 style="color: #FFD700; margin-bottom: 1rem;">Profile Picture</h4>
              <div style="display: flex; align-items: center; gap: 2rem;">
                <div style="position: relative;">
                  <img id="preview-avatar" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid #4a7c59; object-fit: cover;">
                  <div id="avatar-loading" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); border-radius: 50%; align-items: center; justify-content: center; flex-direction: column;">
                    <div style="color: white; font-size: 0.9rem; margin-bottom: 8px;">Uploading...</div>
                    <div style="width: 80%; background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden;">
                      <div id="upload-progress-bar" style="width: 0%; height: 100%; background: #4a7c59; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="upload-status" style="color: white; font-size: 0.8rem; margin-top: 8px;"></div>
                  </div>
                </div>
                <div style="flex: 1;">
                  <p style="color: #999; margin-bottom: 1rem; font-size: 0.9rem;">
                    Upload a custom profile picture. Images will be resized to 200x200 pixels.
                  </p>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <label for="avatar-upload" class="btn btn-sm" style="cursor: pointer;">
                      📷 Upload New Picture
                    </label>
                    <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                    <button id="reset-avatar-btn" class="btn secondary-btn btn-sm" style="display: none;">
                      ↩️ Reset to Google Picture
                    </button>
                  </div>
                  <p style="color: #666; margin-top: 0.5rem; font-size: 0.85rem;">
                    Maximum file size: 5MB. Supported formats: JPG, PNG, GIF, WebP
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Nickname -->
            <div style="margin-bottom: 2rem;">
              <h4 style="color: #FFD700; margin-bottom: 1rem;">Display Name (Nickname)</h4>
              <p style="color: #999; margin-bottom: 1rem; font-size: 0.9rem;">
                Set a nickname that will be displayed instead of your real name throughout the application.
              </p>
              <div style="display: flex; gap: 1rem; align-items: center; max-width: 500px;">
                <input type="text" id="nickname-input" placeholder="Enter nickname (optional)" maxlength="50" 
                       style="flex: 1; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; 
                              background: #2d2d2d; color: #e0e0e0;">
                <button class="btn btn-sm" id="save-nickname-btn">Save</button>
              </div>
              <p style="color: #666; margin-top: 0.5rem; font-size: 0.85rem;">
                Leave empty to use your real name. 3-50 characters, letters, numbers, spaces, underscores, and hyphens only.
              </p>
              <p id="nickname-error" style="color: #dc3545; margin-top: 0.5rem; font-size: 0.85rem; display: none;"></p>
            </div>
          </div>
          
          <div class="preference-section">
            <h3>Display Settings</h3>
            <div style="text-align: center; padding: 2rem;">
              <div style="display: inline-block; background: #4a7c59; color: white; padding: 0.75rem 2rem; border-radius: 30px; font-size: 1.1rem; font-weight: 500; box-shadow: 0 4px 12px rgba(74, 124, 89, 0.3);">
                ✨ More Options Coming Soon
              </div>
              <p style="margin-top: 1rem; color: #999; font-size: 0.95rem;">
                Theme customization and other display options will be available in a future update.
              </p>
            </div>
          </div>
        </div>

        <!-- Privacy Tab -->
        <div id="privacy-tab" class="tab-content">
          <h2>Privacy & Security</h2>
          <div class="preference-section">
            <h3>Data & Privacy</h3>
            <p>Your data is stored securely and is never shared with third parties.</p>
            <button class="btn danger-btn" id="delete-account-btn">Delete Account</button>
          </div>
          
          <div class="preference-section">
            <h3>Active Sessions</h3>
            <p>Manage your active login sessions across devices.</p>
            <button class="btn secondary-btn" id="logout-all-btn">Log Out All Devices</button>
          </div>
        </div>

        <!-- Custom POIs Tab -->
        <div id="custom-pois-tab" class="tab-content">
          <h2 style="color: #FFD700;">Custom Points of Interest (POI)</h2>
          <p style="color: #999; margin-bottom: 2rem;">Create personal markers on maps that only you can see. Share them with friends or keep them private.</p>
          
          <div id="custom-pois-loading" style="text-align: center; padding: 2rem;">
            Loading custom POIs...
          </div>
          
          <div id="custom-pois-content" style="display: none;">
            <h3 class="sub-header">My POIs</h3>
            
            <table id="custom-pois-table" class="admin-table">
              <thead>
                <tr>
                  <th>Icon</th>
                  <th>Name</th>
                  <th>Map</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Shared</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="custom-pois-tbody"></tbody>
            </table>
            
            <!-- My POIs Pagination -->
            <div id="my-pois-pagination" class="pagination" style="display: none;">
              <button class="pagination-btn" id="my-pois-prev">Previous</button>
              <span class="pagination-info" id="my-pois-page-info">Page 1 of 1</span>
              <button class="pagination-btn" id="my-pois-next">Next</button>
            </div>
            
            <!-- Shared POIs Section -->
            <div id="shared-pois-section" style="display: block; margin-top: 3rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                  <h3 class="sub-header" style="margin-bottom: 0.5rem;">Shared POIs</h3>
                  <p style="color: #999; font-size: 0.9rem; margin: 0;">POIs that other users have shared with you.</p>
                </div>
                <button class="btn btn-sm" onclick="showAddSharedPOIModal()" style="background: #4a7c59;">
                  <span style="margin-right: 0.5rem;">➕</span>Add Shared POI
                </button>
              </div>
              
              <table id="shared-pois-table" class="admin-table">
                <thead>
                  <tr>
                    <th>Icon</th>
                    <th>Name</th>
                    <th>Map</th>
                    <th>Shared By</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="shared-pois-tbody"></tbody>
              </table>
              
              <!-- Shared POIs Pagination -->
              <div id="shared-pois-pagination" class="pagination" style="display: none;">
                <button class="pagination-btn" id="shared-pois-prev">Previous</button>
                <span class="pagination-info" id="shared-pois-page-info">Page 1 of 1</span>
                <button class="pagination-btn" id="shared-pois-next">Next</button>
              </div>
            </div>
            
          </div>
        </div>

        <!-- Voting Tab -->
        <div id="voting-tab" class="tab-content">
          <h2 style="color: #FFD700;">Community Voting</h2>
          <p style="color: #999; margin-bottom: 2rem;">Vote on proposed changes to POIs, NPCs, and Items. Changes with +10 votes are automatically approved!</p>
          
          <!-- Voting Stats -->
          <div class="voting-stats-container">
            <div class="voting-stat-card" onclick="filterByCard('mine')" data-filter-type="mine" style="padding-bottom: 1rem;">
              <div class="stat-main">
                <div class="stat-icon">🗳️</div>
                <div class="stat-info">
                  <div class="stat-value" id="my-proposals-count">0</div>
                  <div class="stat-label">My Proposals</div>
                </div>
              </div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('add_poi')" data-filter-type="add_poi">
              <div class="stat-main">
                <div class="stat-icon">📍</div>
                <div class="stat-info">
                  <div class="stat-value" id="add-poi-total">0</div>
                  <div class="stat-label">New POIs</div>
                </div>
              </div>
              <div class="stat-pending" id="add-poi-pending">0 pending vote!</div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('edit_poi')" data-filter-type="edit_poi">
              <div class="stat-main">
                <div class="stat-icon">✏️</div>
                <div class="stat-info">
                  <div class="stat-value" id="edit-poi-total">0</div>
                  <div class="stat-label">POI Edits</div>
                </div>
              </div>
              <div class="stat-pending" id="edit-poi-pending">0 pending vote!</div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('move_poi')" data-filter-type="move_poi">
              <div class="stat-main">
                <div class="stat-icon">🔄</div>
                <div class="stat-info">
                  <div class="stat-value" id="move-poi-total">0</div>
                  <div class="stat-label">POI Moves</div>
                </div>
              </div>
              <div class="stat-pending" id="move-poi-pending">0 pending vote!</div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('delete_poi')" data-filter-type="delete_poi">
              <div class="stat-main">
                <div class="stat-icon">🗑️</div>
                <div class="stat-info">
                  <div class="stat-value" id="delete-poi-total">0</div>
                  <div class="stat-label">POI Deletions</div>
                </div>
              </div>
              <div class="stat-pending" id="delete-poi-pending">0 pending vote!</div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('add_npc')" data-filter-type="add_npc">
              <div class="stat-main">
                <div class="stat-icon">🐉</div>
                <div class="stat-info">
                  <div class="stat-value" id="add-npc-total">0</div>
                  <div class="stat-label">New NPCs</div>
                </div>
              </div>
              <div class="stat-pending" id="add-npc-pending">0 pending vote!</div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('edit_npc')" data-filter-type="edit_npc">
              <div class="stat-main">
                <div class="stat-icon">👾</div>
                <div class="stat-info">
                  <div class="stat-value" id="edit-npc-total">0</div>
                  <div class="stat-label">NPC Edits</div>
                </div>
              </div>
              <div class="stat-pending" id="edit-npc-pending">0 pending vote!</div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('change_loot')" data-filter-type="change_loot">
              <div class="stat-main">
                <div class="stat-icon">💎</div>
                <div class="stat-info">
                  <div class="stat-value" id="change-loot-total">0</div>
                  <div class="stat-label">Loot Changes</div>
                </div>
              </div>
              <div class="stat-pending" id="change-loot-pending">0 pending vote!</div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('add_item')" data-filter-type="add_item">
              <div class="stat-main">
                <div class="stat-icon">⚔️</div>
                <div class="stat-info">
                  <div class="stat-value" id="add-item-total">0</div>
                  <div class="stat-label">New Items</div>
                </div>
              </div>
              <div class="stat-pending" id="add-item-pending">0 pending vote!</div>
            </div>
            <div class="voting-stat-card" onclick="filterByCard('edit_item')" data-filter-type="edit_item">
              <div class="stat-main">
                <div class="stat-icon">🛡️</div>
                <div class="stat-info">
                  <div class="stat-value" id="edit-item-total">0</div>
                  <div class="stat-label">Item Edits</div>
                </div>
              </div>
              <div class="stat-pending" id="edit-item-pending">0 pending vote!</div>
            </div>
          </div>

          <!-- Filter Controls -->
          <div class="voting-controls">
            <div class="filter-group">
              <label>Type:</label>
              <select id="proposal-type-filter" class="form-control">
                <option value="">All Types</option>
                <option value="add_poi">New POI</option>
                <option value="edit_poi">Edit POI</option>
                <option value="move_poi">Move POI</option>
                <option value="delete_poi">Delete POI</option>
                <option value="add_npc">New NPC</option>
                <option value="edit_npc">Edit NPC</option>
                <option value="change_loot">Change NPC Loot</option>
                <option value="add_item">New Item</option>
                <option value="edit_item">Edit Item</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Show:</label>
              <select id="proposal-filter" class="form-control">
                <option value="all">All Proposals</option>
                <option value="mine">My Proposals</option>
                <option value="not-voted" selected>Not Voted</option>
              </select>
            </div>
            <div class="filter-group">
              <button class="btn btn-sm" onclick="refreshProposals()" style="background: #4a7c59; padding: 0.5rem 1rem;">
                <span style="margin-right: 0.5rem;">🔄</span>Refresh
              </button>
            </div>
            <div class="filter-group">
              <button class="btn btn-sm" onclick="resetProposalFilters()" style="background: #666; padding: 0.5rem 1rem;">
                <span style="margin-right: 0.5rem;">↺</span>Reset
              </button>
            </div>
          </div>

          <!-- Proposals List -->
          <div id="proposals-loading" style="text-align: center; padding: 2rem;">
            Loading proposals...
          </div>
          
          <div id="proposals-container" style="display: none;">
            <div id="proposals-list" class="proposals-list"></div>
            
            <!-- Pagination -->
            <div id="proposals-pagination" class="pagination" style="display: none;">
              <button class="pagination-btn" id="proposals-prev">Previous</button>
              <span class="pagination-info" id="proposals-page-info">Page 1 of 1</span>
              <button class="pagination-btn" id="proposals-next">Next</button>
            </div>
          </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin-tab" class="tab-content">
          <h2 style="color: #FFD700;">Admin Settings</h2>
          
          <div class="admin-section collapsed" id="xp-config-section">
            <div class="admin-section-header" onclick="toggleAdminSection('xp-config-section')">
              <div>
                <h3>XP Configuration</h3>
                <p style="color: #999; margin: 0.25rem 0 0 0; font-size: 0.9rem;">Configure experience points awarded for various actions</p>
              </div>
              <span class="collapse-icon">▼</span>
            </div>
            <div class="admin-section-content">
              <div id="xp-config-loading" style="text-align: center; padding: 2rem;">
                Loading XP configuration...
              </div>
              
              <div id="xp-config-content" style="display: none;">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>Action</th>
                      <th>Description</th>
                      <th>XP Value</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="xp-config-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
          
          <div class="admin-section collapsed" id="user-management-section">
            <div class="admin-section-header" onclick="toggleAdminSection('user-management-section')">
              <div>
                <h3>User Management</h3>
                <p style="color: #999; margin: 0.25rem 0 0 0; font-size: 0.9rem;">View and manage all user accounts</p>
              </div>
              <span class="collapse-icon">▼</span>
            </div>
            <div class="admin-section-content">
              <div id="user-management-loading" style="text-align: center; padding: 2rem;">
                Loading users...
              </div>
              
              <div id="user-management-content" style="display: none;">
                <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; align-items: stretch;">
                  <input type="text" id="user-search" placeholder="Search users by name or email..." 
                         style="width: 300px; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; 
                                background: #2d2d2d; color: #e0e0e0;"
                         onkeyup="searchUsers()">
                  <button onclick="refreshUsers()" style="background: transparent; border: none; color: #999; 
                          padding: 0.5rem; cursor: pointer; 
                          display: flex; align-items: center; justify-content: center;
                          transition: all 0.2s; height: 100%;" 
                          onmouseover="this.style.color='#FFD700'; this.style.transform='rotate(180deg)';" 
                          onmouseout="this.style.color='#999'; this.style.transform='rotate(0deg)';"
                          title="Refresh user list">
                    <span style="font-size: 1.25rem;">🔄</span>
                  </button>
                </div>
                
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>Avatar</th>
                      <th>Name</th>
                      <th>Email</th>
                      <th>XP</th>
                      <th>POIs</th>
                      <th>Status</th>
                      <th>Joined</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="users-tbody"></tbody>
                </table>
                
                <!-- Users Pagination -->
                <div id="users-pagination" class="pagination" style="display: none;">
                  <button class="pagination-btn" id="users-prev">Previous</button>
                  <span class="pagination-info" id="users-page-info">Page 1 of 1</span>
                  <button class="pagination-btn" data-action="changeUsersPage" data-args="1" id="users-next">Next</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- POI Type Management -->
          <div class="admin-section collapsed" id="poi-type-management-section">
            <div class="admin-section-header" onclick="toggleAdminSection('poi-type-management-section')">
              <div>
                <h3>POI Type Management</h3>
                <p style="color: #999; margin: 0.25rem 0 0 0; font-size: 0.9rem;">Manage POI types and their icons</p>
              </div>
              <span class="collapse-icon">▼</span>
            </div>
            <div class="admin-section-content">
              <div style="margin-bottom: 1rem;">
                <button onclick="showAddPOITypeModal()" class="primary-btn">
                  <span style="margin-right: 0.5rem;">➕</span>
                  Add POI Type
                </button>
              </div>
              
              <div id="poi-types-loading" style="text-align: center; padding: 2rem;">
                Loading POI types...
              </div>
              
              <div id="poi-types-content" style="display: none;">
                <!-- Pagination info -->
                <div id="poi-types-pagination-info" style="text-align: center; margin-bottom: 1rem; color: #666;"></div>
                
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th width="60">Icon</th>
                      <th>Name</th>
                      <th width="100">Type</th>
                      <th width="80">Default</th>
                      <th width="60">Order</th>
                      <th width="120">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="poi-types-tbody"></tbody>
                </table>
                
                <!-- Pagination controls -->
                <div id="poi-types-pagination" style="display: none; text-align: center; margin-top: 1.5rem;"></div>
              </div>
            </div>
          </div>
          
          <!-- POI Editor -->
          <div class="admin-section collapsed" id="poi-editor-section">
            <div class="admin-section-header" onclick="toggleAdminSection('poi-editor-section')">
              <div>
                <h3>POI Editor</h3>
                <p style="color: #999; margin: 0.25rem 0 0 0; font-size: 0.9rem;">Edit POI data directly in a grid view</p>
              </div>
              <span class="collapse-icon">▼</span>
            </div>
            <div class="admin-section-content">
              <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                  <label for="poi-map-filter" style="color: #e0e0e0;">Map:</label>
                  <select id="poi-map-filter" style="padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #2d2d2d; color: #e0e0e0;" onchange="filterPOIsByMap()">
                    <option value="all">All Maps</option>
                  </select>
                </div>
                <input 
                  type="text" 
                  id="poi-search" 
                  class="poi-editor-search" 
                  placeholder="Search POIs by name, description, or ID..."
                  onkeyup="searchPOIs()"
                />
                <div style="display: flex; gap: 0.5rem; margin-left: auto;">
                  <button onclick="exportPOIsToCSV()" class="export-btn" title="Export filtered POIs to CSV">
                    <span>📊</span>Export CSV
                  </button>
                  <button onclick="reloadPOIEditor()" class="secondary-btn" title="Reload from database">
                    <span style="margin-right: 0.5rem;">🔄</span>Reload
                  </button>
                  <button id="poi-reset-btn" onclick="resetPOIChanges()" class="secondary-btn" disabled title="Undo all unsaved changes">
                    <span style="margin-right: 0.5rem;">↩️</span>Reset
                  </button>
                  <button id="poi-save-btn" onclick="savePOIChanges()" class="primary-btn" disabled title="Save all changes">
                    <span style="margin-right: 0.5rem;">💾</span>Save Changes (<span id="poi-change-count">0</span>)
                  </button>
                </div>
              </div>
              
              <div class="poi-stats" style="margin-bottom: 1rem;">
                <div class="poi-stat">
                  <span>Total:</span>
                  <span class="poi-stat-value" id="poi-total-count">0</span>
                </div>
                <div class="poi-stat">
                  <span>Filtered:</span>
                  <span class="poi-stat-value" id="poi-filtered-count">0</span>
                </div>
                <div class="poi-stat">
                  <span>Pending Changes:</span>
                  <span class="poi-stat-value" id="poi-pending-count">0</span>
                </div>
              </div>
              
              <div id="poi-editor-loading" style="text-align: center; padding: 2rem;">
                Loading POIs...
              </div>
              
              <div id="poi-editor-content" style="display: none;">
                <!-- Pagination info -->
                <div id="poi-editor-pagination-info" style="text-align: center; margin-bottom: 1rem; color: #666;"></div>
                
                <div class="poi-editor-table-container" style="overflow-x: auto; border: 1px solid #444; border-radius: 8px;">
                  <table class="admin-table poi-editor-table" style="min-width: 1250px;">
                    <thead>
                      <tr>
                        <th style="width: 60px" data-sort="id">ID</th>
                        <th style="width: 200px" data-sort="name">Name</th>
                        <th style="width: 300px" data-sort="description">Description</th>
                        <th style="width: 180px" data-sort="poi_type_name">Type</th>
                        <th style="width: 60px">Icon</th>
                        <th style="width: 100px" data-sort="icon_size">Icon Size</th>
                        <th style="width: 110px" data-sort="npc_id">NPC ID</th>
                        <th style="width: 110px" data-sort="item_id">Item ID</th>
                        <th style="width: 150px" data-sort="created_by_name">Created By</th>
                        <th style="width: 120px" data-sort="map_name">Map</th>
                        <th style="width: 60px">Delete</th>
                      </tr>
                    </thead>
                    <tbody id="poi-editor-tbody"></tbody>
                  </table>
                </div>
                
                <!-- Pagination controls -->
                <div id="poi-editor-pagination" style="display: none; text-align: center; margin-top: 1.5rem;"></div>
              </div>
            </div>
          </div>
          
          <!-- Item Editor -->
          <div class="admin-section collapsed" id="item-editor-section">
            <div class="admin-section-header" onclick="toggleAdminSection('item-editor-section')">
              <div>
                <h3>Item Editor</h3>
                <p style="color: #999; margin: 0.25rem 0 0 0; font-size: 0.9rem;">Manage game items and their stats</p>
              </div>
              <span class="collapse-icon">▼</span>
            </div>
            <div class="admin-section-content">
              <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                  <label for="item-type-filter" style="color: #e0e0e0;">Type:</label>
                  <select id="item-type-filter" style="padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #2d2d2d; color: #e0e0e0;" onchange="filterItemsByType()">
                    <option value="all">All Types</option>
                    <option value="weapon">Weapons</option>
                    <option value="armor">Armor</option>
                    <option value="consumable">Consumables</option>
                    <option value="misc">Miscellaneous</option>
                  </select>
                </div>
                <input 
                  type="text" 
                  id="item-search" 
                  class="item-editor-search" 
                  placeholder="Search items by name, description, or ID..."
                  onkeyup="searchItems()"
                  style="flex: 1; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #2d2d2d; color: #e0e0e0;"
                />
                <div style="display: flex; gap: 0.5rem; margin-left: auto;">
                  <button onclick="showAddItemForm()" class="primary-btn" title="Add new item">
                    <span style="margin-right: 0.5rem;">➕</span>Add Item
                  </button>
                  <button onclick="exportItemsToCSV()" class="export-btn" title="Export items to CSV">
                    <span>📊</span>Export CSV
                  </button>
                  <button onclick="reloadItemEditor()" class="secondary-btn" title="Reload from database">
                    <span style="margin-right: 0.5rem;">🔄</span>Reload
                  </button>
                  <button id="item-reset-btn" onclick="resetItemChanges()" class="secondary-btn" disabled title="Undo all unsaved changes">
                    <span style="margin-right: 0.5rem;">↩️</span>Reset
                  </button>
                  <button id="item-save-btn" onclick="saveItemChanges()" class="primary-btn" disabled title="Save all changes">
                    <span style="margin-right: 0.5rem;">💾</span>Save Changes (<span id="item-change-count">0</span>)
                  </button>
                </div>
              </div>
              
              <div class="item-stats" style="margin-bottom: 1rem; display: flex; gap: 2rem;">
                <div class="item-stat">
                  <span>Total:</span>
                  <span class="item-stat-value" id="item-total-count">0</span>
                </div>
                <div class="item-stat">
                  <span>Filtered:</span>
                  <span class="item-stat-value" id="item-filtered-count">0</span>
                </div>
              </div>
              
              <div id="item-editor-loading" style="text-align: center; padding: 2rem;">
                Loading items...
              </div>
              
              <div id="item-editor-content" style="display: none;">
                <!-- Pagination info -->
                <div id="item-editor-pagination-info" style="text-align: center; margin-bottom: 1rem; color: #666;"></div>
                
                <div class="item-editor-table-container" style="overflow-x: auto; border: 1px solid #444; border-radius: 8px;">
                  <table class="admin-table item-editor-table" style="min-width: 1600px;">
                    <thead>
                      <tr>
                        <th style="width: 50px" data-sort="id">ID</th>
                        <th style="width: 50px">Icon</th>
                        <th style="width: 150px" data-sort="name">Name</th>
                        <th style="width: 100px" data-sort="item_type">Type</th>
                        <th style="width: 120px" data-sort="slot">Slot</th>
                        <th style="width: 60px" title="Strength">STR</th>
                        <th style="width: 60px" title="Stamina">STA</th>
                        <th style="width: 60px" title="Agility">AGI</th>
                        <th style="width: 60px" title="Dexterity">DEX</th>
                        <th style="width: 60px" title="Wisdom">WIS</th>
                        <th style="width: 60px" title="Intelligence">INT</th>
                        <th style="width: 60px" title="Charisma">CHA</th>
                        <th style="width: 80px" title="Attack Speed">AS</th>
                        <th style="width: 80px" title="Health">HP</th>
                        <th style="width: 80px" title="Mana">MP</th>
                        <th style="width: 60px" title="Armor Class">AC</th>
                        <th style="width: 250px" data-sort="description">Description</th>
                        <th style="width: 100px">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="item-editor-tbody"></tbody>
                  </table>
                </div>
                
                <!-- Pagination controls -->
                <div id="item-editor-pagination" style="display: none; text-align: center; margin-top: 1.5rem;"></div>
              </div>
            </div>
          </div>
          
          <!-- NPC Editor -->
          <div class="admin-section collapsed" id="npc-editor-section">
            <div class="admin-section-header" onclick="toggleAdminSection('npc-editor-section')">
              <div>
                <h3>NPC Editor</h3>
                <p style="color: #999; margin: 0.25rem 0 0 0; font-size: 0.9rem;">Manage NPCs, their stats, and loot tables</p>
              </div>
              <span class="collapse-icon">▼</span>
            </div>
            <div class="admin-section-content">
              <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                  <label for="npc-type-filter" style="color: #e0e0e0;">Type:</label>
                  <select id="npc-type-filter" style="padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #2d2d2d; color: #e0e0e0;" onchange="filterNPCsByType()">
                    <option value="all">All Types</option>
                    <option value="humanoid">Humanoid</option>
                    <option value="beast">Beast</option>
                    <option value="undead">Undead</option>
                    <option value="elemental">Elemental</option>
                    <option value="dragon">Dragon</option>
                    <option value="demon">Demon</option>
                    <option value="construct">Construct</option>
                    <option value="aberration">Aberration</option>
                    <option value="plant">Plant</option>
                    <option value="fey">Fey</option>
                  </select>
                </div>
                <input 
                  type="text" 
                  id="npc-search" 
                  class="npc-editor-search" 
                  placeholder="Search NPCs by name, description, or ID..."
                  onkeyup="searchNPCs()"
                  style="flex: 1; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #2d2d2d; color: #e0e0e0;"
                />
                <div style="display: flex; gap: 0.5rem; margin-left: auto;">
                  <button onclick="showAddNPCForm()" class="primary-btn" title="Add new NPC">
                    <span style="margin-right: 0.5rem;">➕</span>Add NPC
                  </button>
                  <button onclick="exportNPCsToCSV()" class="export-btn" title="Export NPCs to CSV">
                    <span>📊</span>Export CSV
                  </button>
                  <button onclick="reloadNPCEditor()" class="secondary-btn" title="Reload from database">
                    <span style="margin-right: 0.5rem;">🔄</span>Reload
                  </button>
                  <button id="npc-reset-btn" onclick="resetNPCChanges()" class="secondary-btn" disabled title="Undo all unsaved changes">
                    <span style="margin-right: 0.5rem;">↩️</span>Reset
                  </button>
                  <button id="npc-save-btn" onclick="saveNPCChanges()" class="primary-btn" disabled title="Save all changes">
                    <span style="margin-right: 0.5rem;">💾</span>Save Changes (<span id="npc-change-count">0</span>)
                  </button>
                </div>
              </div>
              
              <div class="npc-stats" style="margin-bottom: 1rem;">
                <div class="npc-stat">
                  <span>Total:</span>
                  <span class="npc-stat-value" id="npc-total-count">0</span>
                </div>
                <div class="npc-stat">
                  <span>Filtered:</span>
                  <span class="npc-stat-value" id="npc-filtered-count">0</span>
                </div>
                <div class="npc-stat">
                  <span>Pending Changes:</span>
                  <span class="npc-stat-value" id="npc-pending-count">0</span>
                </div>
              </div>
              
              <div id="npc-editor-loading" style="text-align: center; padding: 2rem;">
                Loading NPCs...
              </div>
              
              <div id="npc-editor-content" style="display: none;">
                <!-- Pagination info -->
                <div id="npc-editor-pagination-info" style="text-align: center; margin-bottom: 1rem; color: #666;"></div>
                
                <div class="npc-editor-table-container" style="overflow-x: auto; border: 1px solid #444; border-radius: 8px;">
                  <table class="admin-table npc-editor-table" style="min-width: 2100px;">
                    <thead>
                      <tr>
                        <th style="width: 50px" data-sort="id">ID</th>
                        <th style="width: 80px" data-sort="npcid">NPC ID</th>
                        <th style="width: 120px" data-sort="npc_type">Type</th>
                        <th style="width: 200px" data-sort="name">Name</th>
                        <th style="width: 300px" data-sort="description">Description</th>
                        <th style="width: 200px">Loot</th>
                        <th style="width: 60px" title="Hit Points">HP</th>
                        <th style="width: 60px" title="Mana Points">MP</th>
                        <th style="width: 60px" title="Armor Class">AC</th>
                        <th style="width: 60px" title="Strength">STR</th>
                        <th style="width: 60px" title="Stamina">STA</th>
                        <th style="width: 60px" title="Agility">AGI</th>
                        <th style="width: 60px" title="Dexterity">DEX</th>
                        <th style="width: 60px" title="Wisdom">WIS</th>
                        <th style="width: 60px" title="Intelligence">INT</th>
                        <th style="width: 60px" title="Charisma">CHA</th>
                        <th style="width: 80px" title="Attack Speed">AS</th>
                        <th style="width: 80px" title="Minimum Damage">Min</th>
                        <th style="width: 80px" title="Maximum Damage">Max</th>
                        <th style="width: 60px" data-sort="level">Level</th>
                        <th style="width: 100px">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="npc-editor-tbody"></tbody>
                  </table>
                </div>
                
                <!-- Pagination controls -->
                <div id="npc-editor-pagination" style="display: none; text-align: center; margin-top: 1.5rem;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">
      Loading account information...
    </div>

    <div id="not-authenticated" class="account-container" style="display: none;">
      <div class="account-content">
        <h2>Not Authenticated</h2>
        <p>Please sign in to access your account settings.</p>
        <a href="/" class="btn">Return to Maps</a>
      </div>
    </div>
  </div>

  <!-- Vote Inspect Modal -->

  <!-- XP Adjustment Modal -->
  <div id="xp-adjustment-modal" class="modal" style="display: none; z-index: 1001;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Adjust Experience Points</h2>
        <button class="close-btn" data-action="closeXPModal">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <img id="xp-user-avatar" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #FFD700; margin-bottom: 0.5rem;">
          <h3 id="xp-user-name" style="margin: 0; color: #FFD700;"></h3>
          <p style="color: #999; margin: 0.5rem 0;">Current XP: <span id="xp-current" style="color: #FFD700; font-weight: bold;"></span></p>
        </div>
        
        <div style="background: #2d2d2d; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; color: #e0e0e0;">New XP Value:</label>
          <input type="number" id="xp-new-value" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #1a1a1a; color: #e0e0e0; font-size: 1.1rem;">
          
          <label style="display: block; margin-top: 1rem; margin-bottom: 0.5rem; color: #e0e0e0;">Reason (optional):</label>
          <input type="text" id="xp-reason" placeholder="e.g., Bonus for exceptional contribution" style="width: 100%; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #1a1a1a; color: #e0e0e0;">
        </div>
        
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button class="btn secondary-btn" data-action="closeXPModal">Cancel</button>
          <button class="btn" data-action="updateUserXP" style="background: #FFD700; color: #2a1810;">Update XP</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Detail Modal -->
  <div id="user-detail-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>User Details</h2>
        <button class="close-btn" data-action="closeUserModal">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
              <img id="detail-user-avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4a7c59;">
              <div>
                <h3 id="detail-user-name" style="margin: 0; color: #FFD700;"></h3>
                <p id="detail-user-email" style="margin: 0.25rem 0; color: #999;"></p>
                <span id="detail-user-status" style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.85rem;"></span>
              </div>
            </div>
            
            <div style="background: #2d2d2d; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <h4 style="color: #FFD700; margin-top: 0;">Account Information</h4>
              <p><strong>User ID:</strong> <span id="detail-user-id"></span></p>
              <p><strong>Joined:</strong> <span id="detail-user-joined"></span></p>
              <p><strong>Last Active:</strong> <span id="detail-user-last-active"></span></p>
              <p style="display: flex; justify-content: space-between; align-items: center;">
                <strong>XP:</strong> 
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                  <span id="detail-user-xp" style="color: #FFD700; font-weight: bold;"></span>
                  <button class="small-btn" data-action="showXPAdjustment" style="padding: 0.2rem 0.5rem; font-size: 0.75rem; background: #FFD700; color: #2a1810;">
                    <span class="btn-icon">✏️</span>Edit
                  </button>
                </span>
              </p>
              <p><strong>Admin:</strong> <span id="detail-user-admin"></span></p>
            </div>
          </div>
          
          <div style="flex: 1;">
            <div style="background: #2d2d2d; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <h4 style="color: #FFD700; margin-top: 0;">Activity Statistics</h4>
              <p><strong>Total POIs Created:</strong> <span id="detail-user-total-pois"></span></p>
              <p><strong>Published POIs:</strong> <span id="detail-user-published-pois"></span></p>
              <p><strong>Votes Cast:</strong> <span id="detail-user-votes"></span></p>
            </div>
            
            <div style="background: #2d2d2d; padding: 1rem; border-radius: 8px;">
              <h4 style="color: #FFD700; margin-top: 0;">Admin Actions</h4>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <button id="ban-user-btn" class="small-btn danger-btn" data-action="banUser">
                  <span class="btn-icon">🚫</span>Ban User
                </button>
                <button id="unban-user-btn" class="small-btn success-btn" data-action="unbanUser" style="display: none;">
                  <span class="btn-icon">✅</span>Unban User
                </button>
                <button class="small-btn warning-btn" data-action="warnUser">
                  <span class="btn-icon">⚠️</span>Warn User
                </button>
                <button class="small-btn secondary-btn" data-action="logoutUser">
                  <span class="btn-icon">🚪</span>Force Logout
                </button>
                <button class="small-btn info-btn" data-action="viewUserPois">
                  <span class="btn-icon">📍</span>View POIs
                </button>
                <button id="toggle-admin-btn" class="small-btn" data-action="toggleAdminStatus">
                  <span class="btn-icon">👑</span><span id="toggle-admin-text">Make Admin</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div id="user-warnings-section" style="display: none;">
          <h4 style="color: #FFD700;">Previous Warnings</h4>
          <div id="user-warnings-list" style="background: #2d2d2d; padding: 1rem; border-radius: 8px; max-height: 200px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- POI Type Modal -->
  <div id="poi-type-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="poi-type-modal-title">Add POI Type</h2>
        <button class="close-btn" onclick="closePOITypeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="poi-type-form" onsubmit="savePOIType(event)">
          <div class="form-group">
            <label for="poi-type-name">Name *</label>
            <input type="text" id="poi-type-name" required placeholder="e.g., Tavern, Quest Giver, Dungeon">
          </div>
          
          <div class="form-group">
            <label>Icon Type *</label>
            <div class="radio-group">
              <label>
                <input type="radio" name="icon-type" value="emoji" checked onchange="updateIconTypeDisplay()">
                Emoji
              </label>
              <label>
                <input type="radio" name="icon-type" value="iconify" onchange="updateIconTypeDisplay()">
                Icon Library
              </label>
              <label>
                <input type="radio" name="icon-type" value="upload" onchange="updateIconTypeDisplay()">
                Upload Image
              </label>
            </div>
          </div>
          
          <!-- Emoji Input -->
          <div id="emoji-input-group" class="form-group">
            <label for="poi-type-emoji">Emoji *</label>
            <div style="display: flex; gap: 0.5rem;">
              <input type="text" id="poi-type-emoji" placeholder="Enter emoji or click to select" maxlength="4">
              <button type="button" onclick="toggleEmojiPicker()" class="secondary-btn">😀</button>
            </div>
            
            <div id="emoji-picker" style="display: none;">
              <div style="display: flex; gap: 0.5rem; padding: 0.75rem; border-bottom: 1px solid #555; flex-wrap: wrap; background: #232323; border-radius: 8px 8px 0 0;">
                <button type="button" onclick="selectEmojiCategory('harvest')" class="emoji-category-btn active" title="Harvesting/Materials">🪵</button>
                <button type="button" onclick="selectEmojiCategory('plants')" class="emoji-category-btn" title="Plants/Herbs">🌿</button>
                <button type="button" onclick="selectEmojiCategory('rpg')" class="emoji-category-btn" title="RPG/Weapons">⚔️</button>
                <button type="button" onclick="selectEmojiCategory('locations')" class="emoji-category-btn" title="Locations/Buildings">🏰</button>
                <button type="button" onclick="selectEmojiCategory('map')" class="emoji-category-btn" title="Map/Navigation">🗺️</button>
                <button type="button" onclick="selectEmojiCategory('creatures')" class="emoji-category-btn" title="Creatures/Monsters">🐉</button>
                <button type="button" onclick="selectEmojiCategory('weather')" class="emoji-category-btn" title="Weather/Environment">🌤️</button>
                <button type="button" onclick="selectEmojiCategory('items')" class="emoji-category-btn" title="Items/Treasures">💰</button>
                <button type="button" onclick="selectEmojiCategory('food')" class="emoji-category-btn" title="Food/Consumables">🍖</button>
                <button type="button" onclick="selectEmojiCategory('symbols')" class="emoji-category-btn" title="Symbols/UI">⭐</button>
              </div>
              <div id="emoji-grid">
                <!-- Emojis will be populated here -->
              </div>
              <div style="padding: 0.75rem; border-top: 1px solid #555; text-align: center; background: #232323; border-radius: 0 0 8px 8px;">
                <a href="https://emojipedia.org/" target="_blank" style="color: #FFD700; text-decoration: none; font-size: 0.9rem; font-weight: 500;">
                  🔍 Browse more emojis on Emojipedia →
                </a>
              </div>
            </div>
          </div>
          
          <!-- Iconify Input -->
          <div id="iconify-input-group" class="form-group" style="display: none;">
            <label for="poi-type-iconify">Icon *</label>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
              <input type="text" id="poi-type-iconify" placeholder="Search for icons..." onkeyup="searchIconifyIcons(this.value)">
              <input type="hidden" id="poi-type-iconify-value" value="">
              <div id="selected-iconify-preview" style="width: 40px; height: 40px; border: 1px solid #555; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #2d2d2d;">
                <span style="color: #666;">?</span>
              </div>
            </div>
            
            <!-- Popular icon sets -->
            <div style="margin-bottom: 1rem;">
              <label style="font-size: 0.85rem; color: #999;">Popular icon sets:</label>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                <button type="button" class="icon-set-btn" onclick="loadIconifySet('game-icons')">🎮 Game Icons (RPG)</button>
                <button type="button" class="icon-set-btn" onclick="loadIconifySet('mdi')">Material Design</button>
                <button type="button" class="icon-set-btn" onclick="loadIconifySet('tabler')">Tabler Icons</button>
                <button type="button" class="icon-set-btn" onclick="loadIconifySet('lucide')">Lucide</button>
                <button type="button" class="icon-set-btn" onclick="loadIconifySet('ri')">Remix Icons</button>
                <button type="button" class="icon-set-btn" onclick="loadIconifySet('heroicons')">Hero Icons</button>
              </div>
            </div>
            
            <div id="iconify-picker" style="border: 1px solid #555; border-radius: 4px; background: #2d2d2d; max-height: 300px; overflow-y: auto; display: none;">
              <div id="iconify-search-results" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.5rem; padding: 1rem;">
                <!-- Icons will be populated here -->
              </div>
            </div>
            
            <p class="help-text">Search for RPG-related terms like "sword", "potion", "dragon", etc. Game Icons set has thousands of colored RPG icons! Over 200,000 free icons available.</p>
          </div>
          
          <!-- Upload Input -->
          <div id="upload-input-group" class="form-group" style="display: none;">
            <label for="poi-type-upload">Icon Image *</label>
            <input type="file" id="poi-type-upload" accept="image/*">
            <p class="help-text">Max size: 1MB. Supported formats: PNG, JPG, GIF, SVG</p>
            <div id="icon-preview" style="margin-top: 1rem; text-align: center;"></div>
          </div>
          
          <div class="modal-actions">
            <button type="button" onclick="closePOITypeModal()" class="secondary-btn">Cancel</button>
            <button type="submit" class="primary-btn">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Item Modal removed - using inline editing -->
  <script>
    let currentUser = null;
    let preferences = {};
    
    // Use the global CSRF helper from csrf-helper.js
    // Note: fetchWithCSRF and getCSRFToken are available via window.csrfHelper

    // Helper functions for safe table cell creation
    function createTextCell(text) {
      const td = document.createElement('td');
      td.textContent = text;
      return td;
    }
    
    function createImageCell(src, alt) {
      const td = document.createElement('td');
      td.style.textAlign = 'center';
      const img = document.createElement('img');
      img.src = src;
      img.alt = alt;
      img.style.width = '32px';
      img.style.height = '32px';
      img.style.borderRadius = '50%';
      img.style.objectFit = 'cover';
      img.style.display = 'block';
      img.style.margin = '0 auto';
      td.appendChild(img);
      return td;
    }
    
    function createXPCell(xp) {
      const td = document.createElement('td');
      td.style.color = '#FFD700';
      td.style.fontWeight = 'bold';
      td.textContent = xp;
      return td;
    }
    
    function createHTMLCell(html) {
      const td = document.createElement('td');
      if (window.safeHTML) {
        td.innerHTML = window.safeHTML(html);
      } else {
        td.textContent = html.replace(/<[^>]*>/g, ''); // Strip HTML if no sanitizer
      }
      return td;
    }
    
    function createButtonCell(userId, buttonText = 'Details', iconText = '👁️') {
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'small-btn info-btn';
      btn.onclick = () => viewUserDetails(userId);
      const icon = document.createElement('span');
      icon.className = 'btn-icon';
      icon.textContent = iconText;
      btn.appendChild(icon);
      btn.appendChild(document.createTextNode(buttonText));
      td.appendChild(btn);
      return td;
    }
    
    // Helper functions for POI table cells
    function createPOIRow(poi, actions, isOwner = true) {
      const row = document.createElement('tr');
      
      // Icon cell
      const iconCell = document.createElement('td');
      iconCell.style.textAlign = 'center';
      iconCell.style.fontSize = '1.5rem';
      iconCell.textContent = poi.icon;
      row.appendChild(iconCell);
      
      // Name cell
      row.appendChild(createTextCell(poi.name));
      
      // Map name cell
      row.appendChild(createTextCell(poi.map_name));
      
      if (isOwner) {
        // Created date cell
        row.appendChild(createTextCell(new Date(poi.created_at).toLocaleDateString()));
        
        // Status cell
        const statusCell = document.createElement('td');
        if (window.safeHTML) {
          statusCell.innerHTML = window.safeHTML(getStatusBadge(poi.status));
        } else {
          statusCell.textContent = poi.status;
        }
        row.appendChild(statusCell);
        
        // Shared count cell
        const sharedCell = document.createElement('td');
        const sharedCount = poi.shared_count || 0;
        
        const sharedLink = document.createElement('a');
        sharedLink.href = '#';
        sharedLink.style.color = sharedCount > 0 ? '#4dff4d' : '#999';
        sharedLink.style.textDecoration = 'none';
        sharedLink.style.cursor = 'pointer';
        sharedLink.style.transition = 'all 0.2s';
        sharedLink.textContent = `${sharedCount} user${sharedCount !== 1 ? 's' : ''}`;
        
        // Add glow effect for counts > 0
        if (sharedCount > 0) {
          sharedLink.style.textShadow = '0 0 8px rgba(77, 255, 77, 0.6), 0 0 12px rgba(77, 255, 77, 0.4)';
        }
        
        sharedLink.onmouseover = () => {
          sharedLink.style.textDecoration = 'underline';
          if (sharedCount > 0) {
            sharedLink.style.textShadow = '0 0 10px rgba(77, 255, 77, 0.8), 0 0 15px rgba(77, 255, 77, 0.6)';
          }
        };
        sharedLink.onmouseout = () => {
          sharedLink.style.textDecoration = 'none';
          if (sharedCount > 0) {
            sharedLink.style.textShadow = '0 0 8px rgba(77, 255, 77, 0.6), 0 0 12px rgba(77, 255, 77, 0.4)';
          }
        };
        sharedLink.onclick = (e) => {
          e.preventDefault();
          viewSharedUsers(poi.id);
        };
        sharedCell.appendChild(sharedLink);
        row.appendChild(sharedCell);
      } else {
        // Shared by cell
        row.appendChild(createTextCell(poi.shared_by_name || 'Unknown'));
      }
      
      // Actions cell
      const actionsCell = document.createElement('td');
      if (window.safeHTML) {
        actionsCell.innerHTML = window.safeHTML(actions);
      } else {
        actionsCell.textContent = 'Actions';
      }
      row.appendChild(actionsCell);
      
      return row;
    }

    // Check authentication status
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (data.authenticated) {
          currentUser = data.user;
          document.getElementById('account-content').style.display = 'flex';
          loadUserData();
          loadPreferences();
          
          // Handle URL parameters for navigation
          const urlParams = new URLSearchParams(window.location.search);
          const tab = urlParams.get('tab');
          const section = urlParams.get('section');
          
          // Navigate to specified tab
          if (tab === 'admin' && currentUser.is_admin) {
            showTab('admin');
            
            // Open specific section if specified
            if (section === 'poi-editor') {
              setTimeout(() => {
                const poiEditorSection = document.getElementById('poi-editor-section');
                if (poiEditorSection) {
                  poiEditorSection.classList.remove('collapsed');
                  
                  // Set the highlight ID from URL parameters
                  const urlParams = new URLSearchParams(window.location.search);
                  const highlightId = urlParams.get('highlight');
                  if (highlightId) {
                    window.poiEditorHighlightId = highlightId;
                  }
                  
                  loadPOIEditor();
                }
              }, 100);
            }
          }
        } else {
          document.getElementById('not-authenticated').style.display = 'block';
        }
      } catch (error) {
        document.getElementById('loading').innerHTML = 'Error loading account information';
      }
    }

    function loadUserData() {
      // Use display name (nickname or real name)
      const displayName = currentUser.displayName || currentUser.name;
      document.getElementById('user-name').textContent = displayName;
      document.getElementById('user-email').textContent = currentUser.email;
      
      
      // Use picture from server (auth/status already returns the correct avatar URL)
      const userAvatar = document.getElementById('user-avatar');
      userAvatar.src = currentUser.picture;
      userAvatar.alt = displayName;
      
      // Add error handler for avatar fallback
      userAvatar.onerror = async function() {
        
        // Try to get the Google picture from the API
        try {
          const response = await fetch('/api/user/google-picture');
          if (response.ok) {
            const data = await response.json();
            if (data.picture && this.src !== data.picture) {
              this.src = data.picture;
              return;
            }
          }
        } catch (error) {
          // Silently fail
        }
        
        // If all else fails, hide the image
        this.style.display = 'none';
      };
      
      // Initialize preferences tab
      const previewAvatar = document.getElementById('preview-avatar');
      previewAvatar.src = currentUser.picture;
      previewAvatar.onerror = userAvatar.onerror;
      
      document.getElementById('nickname-input').value = currentUser.nickname || '';
      
      // Show/hide reset avatar button based on avatar_filename
      if (currentUser.avatar_filename) {
        document.getElementById('reset-avatar-btn').style.display = 'inline-block';
      }
      
      if (currentUser.is_admin) {
        document.getElementById('admin-badge').style.display = 'inline-block';
        document.getElementById('admin-tab-btn').style.display = 'block';
      }
      
      // Load XP and level information
      loadProfileStats();
    }
    
    async function loadProfileStats() {
      try {
        // Get user XP and calculate level
        const userXP = currentUser.xp || 0;
        const xpProgress = getXPProgress(userXP);
        
        // Update level display
        document.getElementById('user-level').textContent = xpProgress.level;
        document.getElementById('user-current-xp').textContent = xpProgress.xpIntoLevel;
        document.getElementById('user-next-level-xp').textContent = xpProgress.level * xpProgress.level * 100;
        document.getElementById('user-xp-bar').style.width = xpProgress.progressPercent + '%';
        
        // Load stats
        const [statsResponse, rankResponse] = await Promise.all([
          fetch('/api/user/stats'),
          fetch('/api/user/rank')
        ]);
        
        if (statsResponse.ok) {
          const stats = await statsResponse.json();
          document.getElementById('total-pois').textContent = stats.totalPois || 0;
          document.getElementById('approved-pois').textContent = stats.approvedPois || 0;
          document.getElementById('total-votes').textContent = stats.totalVotes || 0;
        }
        
        if (rankResponse.ok) {
          const rankData = await rankResponse.json();
          document.getElementById('user-rank').textContent = `Rank: #${rankData.rank}`;
        }
      } catch (error) {
        console.error('Error loading profile stats:', error);
      }
    }
    
    function getXPProgress(totalXP) {
      // Calculate level from total XP
      let level = 1;
      let xpForNextLevel = 0;
      
      // Calculate which level the user is at
      while (xpForNextLevel <= totalXP) {
        xpForNextLevel += level * level * 100;
        if (xpForNextLevel <= totalXP) {
          level++;
        }
      }
      
      // Calculate XP needed for current level and progress
      const xpForCurrentLevel = level > 1 ? (level - 1) * (level - 1) * 100 * level / 2 : 0;
      const xpIntoLevel = totalXP - xpForCurrentLevel;
      const xpNeededForNextLevel = level * level * 100;
      const progressPercent = Math.min(100, (xpIntoLevel / xpNeededForNextLevel) * 100);
      
      return {
        level,
        xpIntoLevel,
        xpNeededForNextLevel,
        progressPercent,
        totalXP
      };
    }

    async function loadPreferences() {
      // Preferences are coming soon
    }

    function showTab(tabName, skipNavUpdate = false) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Reset container width when leaving admin tab
      if (tabName !== 'admin') {
        const accountContent = document.querySelector('.account-content');
        accountContent.classList.remove('editor-active', 'both-editors-active');
      }
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to the corresponding nav item
      if (!skipNavUpdate) {
        if (event && event.target) {
          event.target.classList.add('active');
        } else {
          // Find the nav item by its content or ID
          const navItems = {
            'profile': '👤 Profile',
            'preferences': '⚙️ Preferences',
            'privacy': '🔒 Privacy & Security',
            'custom-pois': '📍 Custom POIs',
            'voting': '🗳️ Voting',
            'admin': '👑 Admin'
          };
          
          document.querySelectorAll('.nav-item').forEach(item => {
            if (item.textContent.includes(navItems[tabName])) {
              item.classList.add('active');
            }
          });
        }
      }
      
      // Load admin data when admin tab is shown
      if (tabName === 'admin' && currentUser?.is_admin) {
        loadAdminData();
      }
      
      // Load voting data when voting tab is shown
      if (tabName === 'voting') {
        loadVotingData();
      }
    }

    function toggleAdminSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');
      
      // Update container width based on open editors
      updateContainerWidth();
    }
    
    function updateContainerWidth() {
      const accountContent = document.querySelector('.account-content');
      if (!accountContent) return;
      
      const poiEditorSection = document.getElementById('poi-editor-section');
      const itemEditorSection = document.getElementById('item-editor-section');
      const npcEditorSection = document.getElementById('npc-editor-section');
      
      const poiEditorOpen = poiEditorSection && !poiEditorSection.classList.contains('collapsed');
      const itemEditorOpen = itemEditorSection && !itemEditorSection.classList.contains('collapsed');
      const npcEditorOpen = npcEditorSection && !npcEditorSection.classList.contains('collapsed');
      
      // Remove all width classes first
      accountContent.classList.remove('editor-active', 'both-editors-active');
      
      // Count open editors
      const openEditors = [poiEditorOpen, itemEditorOpen, npcEditorOpen].filter(Boolean).length;
      
      // Add appropriate class based on number of open editors
      if (openEditors >= 2) {
        accountContent.classList.add('both-editors-active');
      } else if (openEditors === 1) {
        accountContent.classList.add('editor-active');
      }
    }

    async function updatePreference(key, value) {
      // Preferences are coming soon
    }


    async function deleteAccount() {
      if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF('/api/user/account', {
          method: 'DELETE'
        });
        
        if (response.ok) {
          window.location.href = '/';
        }
      } catch (error) {
        showMessage('Failed to delete account', 'error');
      }
    }

    async function logoutAll() {
      try {
        const response = await window.csrfHelper.fetchWithCSRF('/api/auth/logout-all', {
          method: 'POST'
        });
        
        if (response.ok) {
          window.location.href = '/';
        }
      } catch (error) {
        showMessage('Failed to logout from all devices', 'error');
      }
    }

    // Custom confirmation dialog
    function showConfirmDialog(message, onConfirm) {
      const dialog = document.getElementById('confirmDialog');
      const messageEl = dialog.querySelector('.confirm-dialog-message');
      const confirmBtn = dialog.querySelector('.confirm-dialog-btn-confirm');
      const cancelBtn = dialog.querySelector('.confirm-dialog-btn-cancel');
      
      messageEl.textContent = message;
      dialog.style.display = 'flex';
      
      // Remove any existing event listeners
      const newConfirmBtn = confirmBtn.cloneNode(true);
      const newCancelBtn = cancelBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
      
      // Add new event listeners
      newConfirmBtn.addEventListener('click', () => {
        dialog.style.display = 'none';
        onConfirm();
      });
      
      newCancelBtn.addEventListener('click', () => {
        dialog.style.display = 'none';
      });
      
      // Also close on overlay click
      dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
          dialog.style.display = 'none';
        }
      });
    }
    
    function showMessage(text, type) {
      // Create a floating toast notification
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      `;
      
      // Style based on type
      if (type === 'success') {
        toast.style.backgroundColor = '#4a7c59';
        toast.style.color = '#fff';
        toast.style.border = '1px solid #5fa772';
      } else if (type === 'error') {
        toast.style.backgroundColor = '#8b2635';
        toast.style.color = '#fff';
        toast.style.border = '1px solid #a94442';
      } else {
        toast.style.backgroundColor = '#4a6fa5';
        toast.style.color = '#fff';
        toast.style.border = '1px solid #5c7cfa';
      }
      
      toast.textContent = text;
      document.body.appendChild(toast);
      
      // Remove after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // Custom POIs functionality
    let customPois = [];
    let myPoisCurrentPage = 1;
    let sharedPoisCurrentPage = 1;
    const ITEMS_PER_PAGE = 10;

    async function loadCustomPois() {
      try {
        const response = await fetch('/api/custom-pois');
        if (response.ok) {
          customPois = await response.json();
          displayCustomPois();
        }
      } catch (error) {
        console.error('Error loading custom POIs:', error);
      }
    }

    function displayCustomPois() {
      document.getElementById('custom-pois-loading').style.display = 'none';
      document.getElementById('custom-pois-content').style.display = 'block';
      
      // Separate owned POIs from shared POIs
      const ownedPois = customPois.filter(poi => poi.is_owner);
      const sharedPois = customPois.filter(poi => !poi.is_owner);
      
      // Display owned POIs with pagination
      displayMyPois(ownedPois);
      
      // Display shared POIs with pagination
      displaySharedPois(sharedPois);
    }
    
    function displayMyPois(ownedPois) {
      const totalPages = Math.ceil(ownedPois.length / ITEMS_PER_PAGE);
      myPoisCurrentPage = Math.max(1, Math.min(myPoisCurrentPage, totalPages || 1));
      
      // Table is always visible
      document.getElementById('custom-pois-table').style.display = 'table';
      
      const tbody = document.getElementById('custom-pois-tbody');
      tbody.innerHTML = '';
      
      if (ownedPois.length === 0) {
        // Show empty message in table
        document.getElementById('my-pois-pagination').style.display = 'none';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="7" style="text-align: center; color: #666; padding: 2rem;">
            <p style="margin-bottom: 0.5rem;">You haven't created any custom POIs yet.</p>
            <p style="font-size: 0.9rem; color: #999;">Right-click on any map to create your first custom POI!</p>
          </td>
        `;
        tbody.appendChild(row);
      } else {
        // Only show pagination if there's more than one page
        document.getElementById('my-pois-pagination').style.display = totalPages > 1 ? 'flex' : 'none';
        
        // Calculate pagination
        const startIndex = (myPoisCurrentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const pageItems = ownedPois.slice(startIndex, endIndex);
        
        pageItems.forEach(poi => {
          const row = document.createElement('tr');
          
          // Icon cell
          const iconCell = document.createElement('td');
          iconCell.style.textAlign = 'center';
          iconCell.style.fontSize = '1.5rem';
          iconCell.textContent = poi.icon;
          row.appendChild(iconCell);
          
          // Name cell
          const nameCell = document.createElement('td');
          nameCell.textContent = poi.name;
          row.appendChild(nameCell);
          
          // Map cell
          const mapCell = document.createElement('td');
          mapCell.textContent = poi.map_name;
          row.appendChild(mapCell);
          
          // Date cell
          const dateCell = document.createElement('td');
          dateCell.textContent = new Date(poi.created_at).toLocaleDateString();
          row.appendChild(dateCell);
          
          // Status cell
          const statusCell = document.createElement('td');
          const statusBadge = getStatusBadge(poi.status);
          if (window.safeHTML) {
            statusCell.innerHTML = window.safeHTML(statusBadge);
          } else {
            statusCell.innerHTML = statusBadge; // Safe - our generated HTML
          }
          row.appendChild(statusCell);
          
          // Share cell
          const shareCell = document.createElement('td');
          const shareCount = poi.share_count || 0;
          
          const shareLink = document.createElement('a');
          shareLink.href = '#';
          shareLink.style.color = shareCount > 0 ? '#4dff4d' : '#999';
          shareLink.style.textDecoration = 'none';
          shareLink.style.cursor = 'pointer';
          shareLink.style.transition = 'all 0.2s';
          shareLink.textContent = `${shareCount} user${shareCount !== 1 ? 's' : ''}`;
          
          // Add glow effect for counts > 0
          if (shareCount > 0) {
            shareLink.style.textShadow = '0 0 8px rgba(77, 255, 77, 0.6), 0 0 12px rgba(77, 255, 77, 0.4)';
          }
          
          shareLink.onmouseover = () => {
            shareLink.style.textDecoration = 'underline';
            if (shareCount > 0) {
              shareLink.style.textShadow = '0 0 10px rgba(77, 255, 77, 0.8), 0 0 15px rgba(77, 255, 77, 0.6)';
            }
          };
          shareLink.onmouseout = () => {
            shareLink.style.textDecoration = 'none';
            if (shareCount > 0) {
              shareLink.style.textShadow = '0 0 8px rgba(77, 255, 77, 0.6), 0 0 12px rgba(77, 255, 77, 0.4)';
            }
          };
          shareLink.onclick = (e) => {
            e.preventDefault();
            viewSharedUsers(poi.id);
          };
          shareCell.appendChild(shareLink);
          row.appendChild(shareCell);
          
          // Actions cell
          const actionCell = document.createElement('td');
          actionCell.appendChild(createPoiActionButtons(poi));
          row.appendChild(actionCell);
          
          tbody.appendChild(row);
        });
        
        // Update pagination controls
        document.getElementById('my-pois-page-info').textContent = `Page ${myPoisCurrentPage} of ${totalPages}`;
        document.getElementById('my-pois-prev').disabled = myPoisCurrentPage === 1;
        document.getElementById('my-pois-next').disabled = myPoisCurrentPage === totalPages;
      }
    }
    
    function displaySharedPois(sharedPois) {
      // Always display shared POIs section
      document.getElementById('shared-pois-section').style.display = 'block';
      
      const totalPages = Math.ceil(sharedPois.length / ITEMS_PER_PAGE);
      sharedPoisCurrentPage = Math.max(1, Math.min(sharedPoisCurrentPage, totalPages || 1));
      
      const sharedTbody = document.getElementById('shared-pois-tbody');
      sharedTbody.innerHTML = '';
      
      if (sharedPois.length > 0) {
        // Only show pagination if there's more than one page
        document.getElementById('shared-pois-pagination').style.display = totalPages > 1 ? 'flex' : 'none';
        
        // Calculate pagination
        const startIndex = (sharedPoisCurrentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const pageItems = sharedPois.slice(startIndex, endIndex);
        
        pageItems.forEach(poi => {
          const row = document.createElement('tr');
          const isActive = poi.is_shared_active !== false; // Default to active if not specified
          
          // If revoked, add a visual indicator to the row
          if (!isActive) {
            row.style.opacity = '0.6';
          }
          
          // Icon cell
          const iconCell = document.createElement('td');
          iconCell.style.textAlign = 'center';
          iconCell.style.fontSize = '1.5rem';
          iconCell.textContent = poi.icon;
          row.appendChild(iconCell);
          
          // Name cell
          row.appendChild(createTextCell(poi.name));
          
          // Map cell
          row.appendChild(createTextCell(poi.map_name));
          
          // Owner cell
          row.appendChild(createTextCell(poi.owner_name));
          
          // Status cell
          const statusCell = document.createElement('td');
          if (!isActive && poi.invalidation_reason === 'published') {
            // Source custom POI was deleted (published) - show as Invalidated
            const invalidatedSpan = document.createElement('span');
            invalidatedSpan.style.background = '#ffc107';
            invalidatedSpan.style.color = '#2a1810';
            invalidatedSpan.style.padding = '0.2rem 0.5rem';
            invalidatedSpan.style.borderRadius = '4px';
            invalidatedSpan.style.fontSize = '0.8rem';
            invalidatedSpan.style.fontWeight = 'bold';
            invalidatedSpan.textContent = 'Invalidated';
            invalidatedSpan.title = 'The source POI has been published and is now public. You can remove this share.';
            statusCell.appendChild(invalidatedSpan);
          } else if (poi.status === 'published') {
            const publishedSpan = document.createElement('span');
            publishedSpan.style.background = '#FFD700';
            publishedSpan.style.color = '#2a1810';
            publishedSpan.style.padding = '0.2rem 0.5rem';
            publishedSpan.style.borderRadius = '4px';
            publishedSpan.style.fontSize = '0.8rem';
            publishedSpan.style.fontWeight = 'bold';
            publishedSpan.textContent = 'Published';
            publishedSpan.title = 'This POI has been approved and is now public!';
            statusCell.appendChild(publishedSpan);
          } else if (isActive) {
            const activeSpan = document.createElement('span');
            activeSpan.style.background = '#28a745';
            activeSpan.style.color = 'white';
            activeSpan.style.padding = '0.2rem 0.5rem';
            activeSpan.style.borderRadius = '4px';
            activeSpan.style.fontSize = '0.8rem';
            activeSpan.textContent = 'Active';
            statusCell.appendChild(activeSpan);
          } else {
            const revokedSpan = document.createElement('span');
            revokedSpan.style.background = '#dc3545';
            revokedSpan.style.color = 'white';
            revokedSpan.style.padding = '0.2rem 0.5rem';
            revokedSpan.style.borderRadius = '4px';
            revokedSpan.style.fontSize = '0.8rem';
            revokedSpan.textContent = 'Revoked';
            statusCell.appendChild(revokedSpan);
          }
          row.appendChild(statusCell);
          
          // Actions cell
          const actionsCell = document.createElement('td');
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'action-buttons';
          
          // View button - disabled for revoked POIs
          const viewBtn = document.createElement('button');
          viewBtn.className = 'small-btn info-btn';
          if (isActive) {
            viewBtn.onclick = () => goToPoi(poi.id, poi.map_id, poi.x, poi.y);
          } else {
            viewBtn.disabled = true;
            viewBtn.style.opacity = '0.5';
            viewBtn.style.cursor = 'not-allowed';
            viewBtn.title = 'This POI has been revoked';
          }
          const viewIcon = document.createElement('span');
          viewIcon.className = 'btn-icon';
          viewIcon.textContent = '👁️';
          viewBtn.appendChild(viewIcon);
          viewBtn.appendChild(document.createTextNode('View'));
          
          // Remove button
          const removeBtn = document.createElement('button');
          removeBtn.className = 'small-btn danger-btn';
          removeBtn.onclick = () => removeSharedPoi(poi.id);
          const removeIcon = document.createElement('span');
          removeIcon.className = 'btn-icon';
          removeIcon.textContent = '🗑️';
          removeBtn.appendChild(removeIcon);
          removeBtn.appendChild(document.createTextNode('Remove'));
          
          actionsDiv.appendChild(viewBtn);
          actionsDiv.appendChild(removeBtn);
          actionsCell.appendChild(actionsDiv);
          row.appendChild(actionsCell);
          
          sharedTbody.appendChild(row);
        });
        
        // Update pagination controls
        document.getElementById('shared-pois-page-info').textContent = `Page ${sharedPoisCurrentPage} of ${totalPages}`;
        document.getElementById('shared-pois-prev').disabled = sharedPoisCurrentPage === 1;
        document.getElementById('shared-pois-next').disabled = sharedPoisCurrentPage === totalPages;
      } else {
        document.getElementById('shared-pois-pagination').style.display = 'none';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="6" style="text-align: center; color: #666; padding: 2rem;">
            No POIs have been shared with you yet. When someone shares a POI with you, it will appear here.
          </td>
        `;
        sharedTbody.appendChild(row);
      }
    }

    function goToPoi(poiId, mapId, x, y) {
      // Store POI location in sessionStorage to highlight it when the map loads
      sessionStorage.setItem('highlightCustomPoi', JSON.stringify({ id: poiId, mapId, x, y }));
      window.open('/', '_blank');
    }

    async function sharePoi(poiId) {
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/custom-pois/${poiId}/share`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const data = await response.json();
          showShareCodeModal(data.shareCode, poiId);
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to create share code', 'error');
        }
      } catch (error) {
        console.error('Error in sharePoi:', error);
        showMessage('Failed to create share code', 'error');
      }
    }

    async function deletePoi(poiId) {
      if (!confirm('Are you sure you want to delete this custom POI? This will also remove it from anyone you shared it with and from pending community approval if applicable.')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/custom-pois/${poiId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showMessage('Custom POI deleted', 'success');
          loadCustomPois(); // Reload the list
          // loadPendingPois(); // Removed - pending POIs system no longer used
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to delete custom POI', 'error');
        }
      } catch (error) {
        console.error('Error in deletePoi:', error);
        showMessage('Failed to delete custom POI', 'error');
      }
    }

    async function removeSharedPoi(poiId) {
      if (!confirm('Are you sure you want to remove this shared POI? You will no longer have access to it.')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/custom-pois/${poiId}/unshare`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showMessage('Shared POI removed', 'success');
          loadCustomPois(); // Reload the list
        }
      } catch (error) {
        showMessage('Failed to remove shared POI', 'error');
      }
    }
    
    // Helper functions for POI display
    function getStatusBadge(status) {
      switch(status) {
        case 'private':
          return '<span style="color: #999;">Private</span>';
        case 'pending':
          return '<span style="color: #FFA500;">Pending</span>';
        case 'published':
          return '<span style="color: #4CAF50;">Published</span>';
        case 'rejected':
          return '<span style="color: #f44336;">Rejected</span>';
        default:
          return '<span style="color: #999;">Private</span>';
      }
    }
    
    function createPoiActionButtons(poi) {
      const container = document.createElement('div');
      container.className = 'action-buttons';
      
      // Primary actions group
      const primaryGroup = document.createElement('div');
      primaryGroup.className = 'action-group';
      
      // View button
      const viewBtn = document.createElement('button');
      viewBtn.className = 'small-btn info-btn';
      viewBtn.setAttribute('data-action', 'goToPoi');
      viewBtn.setAttribute('data-args', `${poi.id}, ${poi.map_id}, ${poi.x}, ${poi.y}`);
      
      const viewIcon = document.createElement('span');
      viewIcon.className = 'btn-icon';
      viewIcon.textContent = '👁️';
      viewBtn.appendChild(viewIcon);
      viewBtn.appendChild(document.createTextNode('View'));
      
      primaryGroup.appendChild(viewBtn);
      
      // Publish button (if applicable)
      if (poi.status === 'private' || poi.status === 'rejected') {
        const publishBtn = document.createElement('button');
        publishBtn.className = 'small-btn warning-btn';
        publishBtn.setAttribute('data-action', 'publishPoi');
        publishBtn.setAttribute('data-args', poi.id.toString());
        
        const publishIcon = document.createElement('span');
        publishIcon.className = 'btn-icon';
        publishIcon.textContent = '📢';
        publishBtn.appendChild(publishIcon);
        publishBtn.appendChild(document.createTextNode('Publish'));
        
        primaryGroup.appendChild(publishBtn);
      }
      
      container.appendChild(primaryGroup);
      
      // Secondary actions group (if not published)
      if (poi.status !== 'published') {
        const secondaryGroup = document.createElement('div');
        secondaryGroup.className = 'action-group';
        
        // Share button
        const shareBtn = document.createElement('button');
        shareBtn.className = 'small-btn secondary-btn';
        shareBtn.setAttribute('data-action', 'sharePoi');
        shareBtn.setAttribute('data-args', poi.id.toString());
        
        const shareIcon = document.createElement('span');
        shareIcon.className = 'btn-icon';
        shareIcon.textContent = '🔗';
        shareBtn.appendChild(shareIcon);
        shareBtn.appendChild(document.createTextNode('Share'));
        
        secondaryGroup.appendChild(shareBtn);
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'small-btn danger-btn';
        deleteBtn.setAttribute('data-action', 'deletePoi');
        deleteBtn.setAttribute('data-args', poi.id.toString());
        
        const deleteIcon = document.createElement('span');
        deleteIcon.className = 'btn-icon';
        deleteIcon.textContent = '🗑️';
        deleteBtn.appendChild(deleteIcon);
        deleteBtn.appendChild(document.createTextNode('Delete'));
        
        secondaryGroup.appendChild(deleteBtn);
        
        container.appendChild(secondaryGroup);
      }
      
      
      return container;
    }
    
    // Publish POI function
    async function publishPoi(poiId) {
      if (!confirm('Are you sure you want to submit this POI for community approval? Once approved, it will become a permanent part of the map.')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/custom-pois/${poiId}/publish`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showMessage('POI submitted for approval!', 'success');
          loadCustomPois(); // Reload the list
          // loadPendingPois(); // Removed - pending POIs system no longer used
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to publish POI', 'error');
        }
      } catch (error) {
        showMessage('Failed to publish POI', 'error');
      }
    }
    
    // Pagination functions
    function changeMyPoisPage(direction) {
      const ownedPois = customPois.filter(poi => poi.is_owner);
      const totalPages = Math.ceil(ownedPois.length / ITEMS_PER_PAGE);
      
      myPoisCurrentPage += direction;
      myPoisCurrentPage = Math.max(1, Math.min(myPoisCurrentPage, totalPages));
      
      displayMyPois(ownedPois);
    }
    
    function changeSharedPoisPage(direction) {
      const sharedPois = customPois.filter(poi => !poi.is_owner);
      const totalPages = Math.ceil(sharedPois.length / ITEMS_PER_PAGE);
      
      sharedPoisCurrentPage += direction;
      sharedPoisCurrentPage = Math.max(1, Math.min(sharedPoisCurrentPage, totalPages));
      
      displaySharedPois(sharedPois);
    }
    
    // Pending POIs functionality - DEPRECATED (replaced by change proposals system)
    /*
    async function loadPendingPois() {
      document.getElementById('pending-pois-loading').style.display = 'block';
      
      try {
        const response = await fetch('/api/pending-pois');
        if (response.ok) {
          pendingPois = await response.json();
          displayPendingPois();
        }
      } catch (error) {
        console.error('Error loading pending POIs:', error);
      } finally {
        document.getElementById('pending-pois-loading').style.display = 'none';
      }
    }
    */
    
    function displayPendingPois() {
      const totalPages = Math.ceil(pendingPois.length / ITEMS_PER_PAGE);
      pendingPoisCurrentPage = Math.max(1, Math.min(pendingPoisCurrentPage, totalPages || 1));
      
      const tbody = document.getElementById('pending-pois-tbody');
      tbody.innerHTML = '';
      
      if (pendingPois.length === 0) {
        document.getElementById('pending-pois-pagination').style.display = 'none';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="7" style="text-align: center; color: #666; padding: 2rem;">
            No POIs are currently pending community approval.
          </td>
        `;
        tbody.appendChild(row);
      } else {
        // Only show pagination if there's more than one page
        document.getElementById('pending-pois-pagination').style.display = totalPages > 1 ? 'flex' : 'none';
        
        // Calculate pagination
        const startIndex = (pendingPoisCurrentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const pageItems = pendingPois.slice(startIndex, endIndex);
        
        pageItems.forEach(poi => {
          const row = document.createElement('tr');
          row.className = 'poi-data-row';
          const voteButtonsElement = createVoteButtons(poi);
          
          // Build row using DOM methods for safety
          // Icon cell
          const iconCell = document.createElement('td');
          iconCell.style.textAlign = 'center';
          iconCell.style.fontSize = '1.5rem';
          iconCell.textContent = poi.icon;
          row.appendChild(iconCell);
          
          // Name cell
          row.appendChild(createTextCell(poi.name));
          
          // Map cell
          row.appendChild(createTextCell(poi.map_name));
          
          // Creator cell
          row.appendChild(createTextCell(poi.creator_name));
          
          // Vote score cell
          const voteScoreCell = document.createElement('td');
          voteScoreCell.className = 'vote-score';
          voteScoreCell.textContent = (poi.vote_score > 0 ? '+' : '') + poi.vote_score;
          row.appendChild(voteScoreCell);
          
          // Vote buttons cell
          const voteBtnCell = document.createElement('td');
          voteBtnCell.appendChild(voteButtonsElement);
          row.appendChild(voteBtnCell);
          
          // Actions cell
          const actionsCell = document.createElement('td');
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'action-buttons';
          
          // Action group
          const actionGroup = document.createElement('div');
          actionGroup.className = 'action-group';
          
          // View button
          const viewBtn = document.createElement('button');
          viewBtn.className = 'small-btn info-btn';
          viewBtn.onclick = () => goToPoi(poi.custom_poi_id, poi.map_id, poi.x, poi.y);
          const viewIcon = document.createElement('span');
          viewIcon.className = 'btn-icon';
          viewIcon.textContent = '👁️';
          viewBtn.appendChild(viewIcon);
          viewBtn.appendChild(document.createTextNode('View'));
          actionGroup.appendChild(viewBtn);
          
          // Inspect button (admin only)
          if (currentUser && currentUser.is_admin) {
            const inspectBtn = document.createElement('button');
            inspectBtn.className = 'small-btn secondary-btn';
            inspectBtn.onclick = () => inspectVotes(poi.id, poi.name);
            const inspectIcon = document.createElement('span');
            inspectIcon.className = 'btn-icon';
            inspectIcon.textContent = '🔍';
            inspectBtn.appendChild(inspectIcon);
            inspectBtn.appendChild(document.createTextNode('Inspect'));
            actionGroup.appendChild(inspectBtn);
          }
          
          actionsDiv.appendChild(actionGroup);
          
          // Admin actions
          if (currentUser && currentUser.is_admin) {
            const adminGroup = document.createElement('div');
            adminGroup.className = 'action-group admin-actions';
            
            // Approve button
            const approveBtn = document.createElement('button');
            approveBtn.className = 'small-btn success-btn';
            approveBtn.onclick = () => forcePublishPoi(poi.id);
            const approveIcon = document.createElement('span');
            approveIcon.className = 'btn-icon';
            approveIcon.textContent = '✅';
            approveBtn.appendChild(approveIcon);
            approveBtn.appendChild(document.createTextNode('Approve'));
            adminGroup.appendChild(approveBtn);
            
            // Reject button
            const rejectBtn = document.createElement('button');
            rejectBtn.className = 'small-btn danger-btn';
            rejectBtn.onclick = () => forceRejectPoi(poi.id);
            const rejectIcon = document.createElement('span');
            rejectIcon.className = 'btn-icon';
            rejectIcon.textContent = '❌';
            rejectBtn.appendChild(rejectIcon);
            rejectBtn.appendChild(document.createTextNode('Reject'));
            adminGroup.appendChild(rejectBtn);
            
            actionsDiv.appendChild(adminGroup);
          }
          
          actionsCell.appendChild(actionsDiv);
          row.appendChild(actionsCell);
          tbody.appendChild(row);
          
          // Add status bar row
          const statusRow = document.createElement('tr');
          statusRow.className = 'vote-status-row';
          statusRow.innerHTML = `
            <td colspan="7" style="padding: 0;">
              <div class="vote-status-bar">
                <div class="vote-bar-track">
                  <span class="vote-label reject">Rejected (-10)</span>
                  <div class="vote-bar-container">
                    <div class="vote-bar-fill" style="left: ${poi.vote_score < 0 ? 50 + (poi.vote_score * 5) : 50}%; width: ${Math.abs(poi.vote_score * 5)}%; background-color: ${poi.vote_score >= 0 ? '#28a745' : '#dc3545'};"></div>
                    <div class="vote-bar-center"></div>
                  </div>
                  <span class="vote-label approve">Approved (+10)</span>
                </div>
              </div>
            </td>
          `;
          tbody.appendChild(statusRow);
        });
        
        // Update pagination controls
        document.getElementById('pending-pois-page-info').textContent = `Page ${pendingPoisCurrentPage} of ${totalPages}`;
        document.getElementById('pending-pois-prev').disabled = pendingPoisCurrentPage === 1;
        document.getElementById('pending-pois-next').disabled = pendingPoisCurrentPage === totalPages;
      }
    }
    
    function createVoteButtons(poi) {
      const container = document.createElement('div');
      container.className = 'vote-buttons';
      
      // Upvote button
      const upvoteBtn = document.createElement('button');
      upvoteBtn.className = 'vote-btn upvote' + (poi.user_vote === 1 ? ' active' : '');
      upvoteBtn.setAttribute('data-action', 'votePoi');
      upvoteBtn.setAttribute('data-args', `${poi.id},1,${poi.is_creator ? 'true' : 'false'}`);
      upvoteBtn.setAttribute('title', 'Upvote');
      upvoteBtn.textContent = '👍';
      container.appendChild(upvoteBtn);
      
      // Downvote button
      const downvoteBtn = document.createElement('button');
      downvoteBtn.className = 'vote-btn downvote' + (poi.user_vote === -1 ? ' active' : '');
      downvoteBtn.setAttribute('data-action', 'votePoi');
      downvoteBtn.setAttribute('data-args', `${poi.id},-1,${poi.is_creator ? 'true' : 'false'}`);
      downvoteBtn.setAttribute('title', poi.is_creator ? 'Withdraw from voting' : 'Downvote');
      downvoteBtn.textContent = '👎';
      container.appendChild(downvoteBtn);
      
      return container;
    }
    
    async function votePoi(poiId, vote, isCreator = false) {
      
      // Convert string 'true'/'false' to boolean
      const isCreatorBool = isCreator === true || isCreator === 'true';
      
      // Check if creator is downvoting their own POI
      if (isCreatorBool && vote === -1) {
        if (!confirm('Are you sure you want to withdraw your POI from community voting? This will remove it from the pending list and return it to private status.')) {
          return;
        }
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/pending-pois/${poiId}/vote`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ vote })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.approved) {
            showMessage('POI approved and published!', 'success');
          } else if (result.rejected) {
            showMessage('POI rejected', 'info');
          } else if (result.withdrawn) {
            showMessage('POI withdrawn from community voting', 'success');
          }
          // loadPendingPois(); // Removed - pending POIs system no longer used
          loadCustomPois(); // Also reload custom POIs if withdrawn
        } else {
          const error = await response.json();
          console.error('Vote failed:', error);
          showMessage(error.error || 'Failed to vote', 'error');
        }
      } catch (error) {
        console.error('Vote error:', error);
        showMessage('Failed to vote', 'error');
      }
    }
    
    async function forcePublishPoi(poiId) {
      if (!confirm('Are you sure you want to force-publish this POI? This will bypass the normal voting process.')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/pending-pois/${poiId}/force-publish`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showMessage('POI approved and published! It will now appear on the map.', 'success');
          // loadPendingPois(); // Removed - pending POIs system no longer used
          loadCustomPois(); // Reload My POIs to show updated status
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to force-publish POI', 'error');
        }
      } catch (error) {
        showMessage('Failed to force-publish POI', 'error');
      }
    }
    
    async function forceRejectPoi(poiId) {
      if (!confirm('Are you sure you want to force-reject this POI? This will bypass the normal voting process and remove XP from the creator.')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/pending-pois/${poiId}/force-reject`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showMessage('POI rejected and returned to creator with "Rejected" status.', 'success');
          // loadPendingPois(); // Removed - pending POIs system no longer used
          loadCustomPois(); // Reload My POIs to show updated status
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to force-reject POI', 'error');
        }
      } catch (error) {
        showMessage('Failed to force-reject POI', 'error');
      }
    }
    
    // Modal functions
    async function inspectVotes(poiId, poiName) {
      try {
        const response = await fetch(`/api/pending-pois/${poiId}/votes`);
        if (response.ok) {
          const votes = await response.json();
          displayVoteModal(poiName, votes);
        } else {
          showMessage('Failed to load vote details', 'error');
        }
      } catch (error) {
        showMessage('Failed to load vote details', 'error');
      }
    }
    
    function displayVoteModal(poiName, votes) {
      document.getElementById('inspect-poi-name').textContent = poiName;
      
      // Calculate vote stats
      const upvotes = votes.filter(v => v.vote === 1).length;
      const downvotes = votes.filter(v => v.vote === -1).length;
      const totalScore = upvotes - downvotes;
      
      document.getElementById('inspect-poi-stats').textContent = 
        `Total Score: ${totalScore > 0 ? '+' : ''}${totalScore} (${upvotes} upvotes, ${downvotes} downvotes)`;
      
      // Populate vote table
      const tbody = document.getElementById('vote-details-tbody');
      tbody.innerHTML = '';
      
      if (votes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">No votes yet</td></tr>';
      } else {
        votes.forEach(vote => {
          const row = document.createElement('tr');
          const voteIcon = vote.vote === 1 ? '👍' : '👎';
          const voteClass = vote.vote === 1 ? 'color: #4CAF50;' : 'color: #f44336;';
          
          row.innerHTML = `
            <td>${vote.voter_name} <span style="color: #666; font-size: 0.85rem;">(${vote.voter_email})</span></td>
            <td style="text-align: center; ${voteClass} font-size: 1.2rem;">${voteIcon}</td>
            <td>${new Date(vote.created_at).toLocaleString()}</td>
          `;
          tbody.appendChild(row);
        });
      }
      
      // Show modal
      document.getElementById('vote-inspect-modal').style.display = 'block';
    }
    
    function closeVoteModal() {
      document.getElementById('vote-inspect-modal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('vote-inspect-modal');
      if (event.target === modal) {
        closeVoteModal();
      }
    }

    // Update showTab to load custom POIs when tab is clicked
    const originalShowTab = showTab;
    showTab = function(tabName) {
      originalShowTab(tabName);
      
      if (tabName === 'custom-pois') {
        // Always reload to get fresh data
        loadCustomPois();
      } else if (tabName === 'admin' && currentUser?.is_admin) {
        loadXPConfig();
        loadUsers();
      }
    };

    // Item Editor Functions
    let gameItems = [];
    let filteredGameItems = [];
    let currentGameItemPage = 0;
    const GAME_ITEMS_PER_PAGE = 20;
    let editingGameItem = null;
    let currentItemEmojiCategory = 'harvest';
    let itemChanges = new Map(); // Track staged changes for items
    
    async function loadItemEditor() {
      const loading = document.getElementById('item-editor-loading');
      const content = document.getElementById('item-editor-content');
      
      try {
        const response = await fetch('/api/items');
        if (response.ok) {
          gameItems = await response.json();
          filterItemsByType();
          loading.style.display = 'none';
          content.style.display = 'block';
        } else if (response.status === 404) {
          loading.innerHTML = '<p style="color: #dc3545;">Items API not found. Please implement /api/items endpoint.</p>';
        } else {
          loading.innerHTML = '<p style="color: #dc3545;">Failed to load items. Server returned: ' + response.status + '</p>';
        }
      } catch (error) {
        console.error('Error loading items:', error);
        loading.innerHTML = '<p style="color: #dc3545;">Failed to load items. The /api/items endpoint needs to be implemented.</p>';
      }
    }
    
    function filterItemsByType() {
      const typeFilter = document.getElementById('item-type-filter').value;
      const searchTerm = document.getElementById('item-search').value.toLowerCase();
      
      filteredGameItems = gameItems.filter(item => {
        const matchesType = typeFilter === 'all' || item.item_type === typeFilter;
        const matchesSearch = !searchTerm || 
          item.name.toLowerCase().includes(searchTerm) ||
          (item.description && item.description.toLowerCase().includes(searchTerm)) ||
          item.id.toString().includes(searchTerm);
        
        return matchesType && matchesSearch;
      });
      
      currentGameItemPage = 0;
      displayItems();
    }
    
    function searchItems() {
      filterItemsByType();
    }
    
    function displayItems() {
      const tbody = document.getElementById('item-editor-tbody');
      tbody.innerHTML = '';
      
      const totalPages = Math.ceil(filteredGameItems.length / GAME_ITEMS_PER_PAGE);
      const startIndex = currentGameItemPage * GAME_ITEMS_PER_PAGE;
      const endIndex = Math.min(startIndex + GAME_ITEMS_PER_PAGE, filteredGameItems.length);
      const pageItems = filteredGameItems.slice(startIndex, endIndex);
      
      // Update counts
      document.getElementById('item-total-count').textContent = gameItems.length;
      document.getElementById('item-filtered-count').textContent = filteredGameItems.length;
      
      // Update pagination info
      const paginationInfo = document.getElementById('item-editor-pagination-info');
      if (filteredGameItems.length > 0) {
        paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredGameItems.length} items`;
      } else {
        paginationInfo.textContent = 'No items found';
      }
      
      pageItems.forEach(item => {
        const row = createItemEditorRow(item);
        tbody.appendChild(row);
      });
      
      // Update pagination
      displayItemPagination();
      updateItemChangeButtons();
    }
    
    function createItemEditorRow(item) {
      const row = document.createElement('tr');
      row.id = `item-row-${item.id}`;
      
      // ID
      const idCell = document.createElement('td');
      idCell.textContent = item.id;
      row.appendChild(idCell);
      
      // Icon
      const iconCell = document.createElement('td');
      iconCell.style.textAlign = 'center';
      iconCell.style.cursor = 'pointer';
      iconCell.onclick = () => showItemIconPicker(item.id);
      if (item.icon_type === 'emoji') {
        iconCell.style.fontSize = '1.5rem';
        iconCell.textContent = item.icon_value;
      } else if (item.icon_type === 'iconify') {
        iconCell.innerHTML = `<iconify-icon icon="${item.icon_value}" width="24" height="24"></iconify-icon>`;
      } else if (item.icon_type === 'upload') {
        const img = document.createElement('img');
        img.src = item.icon_value;
        img.style.width = '32px';
        img.style.height = '32px';
        img.style.objectFit = 'contain';
        iconCell.appendChild(img);
      }
      iconCell.title = 'Click to change icon';
      row.appendChild(iconCell);
      
      // Name
      const nameCell = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = item.name;
      nameInput.className = 'inline-edit';
      nameInput.style.width = '100%';
      nameInput.style.fontWeight = 'bold';
      nameInput.dataset.field = 'name';
      nameInput.dataset.original = item.name;
      nameInput.onblur = () => stageItemChange(item.id, 'name', nameInput.value);
      nameInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          nameInput.blur();
        }
      };
      nameCell.appendChild(nameInput);
      row.appendChild(nameCell);
      
      // Type
      const typeCell = document.createElement('td');
      const typeSelect = document.createElement('select');
      typeSelect.className = 'inline-edit';
      typeSelect.style.width = '100%';
      typeSelect.dataset.field = 'item_type';
      typeSelect.dataset.original = item.item_type || '';
      ['', 'weapon', 'armor', 'consumable', 'material', 'jewelry', 'misc'].forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type || '-';
        if (type === (item.item_type || '')) option.selected = true;
        typeSelect.appendChild(option);
      });
      typeSelect.onchange = () => stageItemChange(item.id, 'item_type', typeSelect.value);
      typeCell.appendChild(typeSelect);
      row.appendChild(typeCell);
      
      // Slot
      const slotCell = document.createElement('td');
      const slotSelect = document.createElement('select');
      slotSelect.className = 'inline-edit';
      slotSelect.style.width = '100%';
      slotSelect.dataset.field = 'slot';
      slotSelect.dataset.original = item.slot || '';
      const slots = [
        { value: '', label: 'None' },
        { value: 'main_hand', label: 'Main Hand' },
        { value: 'off_hand', label: 'Off Hand' },
        { value: 'two_hand', label: 'Two Hand' },
        { value: 'head', label: 'Head' },
        { value: 'chest', label: 'Chest' },
        { value: 'legs', label: 'Legs' },
        { value: 'feet', label: 'Feet' },
        { value: 'hands', label: 'Hands' },
        { value: 'neck', label: 'Neck' },
        { value: 'ring', label: 'Ring' },
        { value: 'trinket', label: 'Trinket' }
      ];
      slots.forEach(slot => {
        const option = document.createElement('option');
        option.value = slot.value;
        option.textContent = slot.label;
        if (slot.value === (item.slot || '')) option.selected = true;
        slotSelect.appendChild(option);
      });
      slotSelect.onchange = () => stageItemChange(item.id, 'slot', slotSelect.value);
      slotCell.appendChild(slotSelect);
      row.appendChild(slotCell);
      
      // Stats
      ['str', 'sta', 'agi', 'dex', 'wis', 'int', 'cha'].forEach(stat => {
        const statCell = document.createElement('td');
        const statInput = document.createElement('input');
        statInput.type = 'number';
        statInput.value = item[stat] || 0;
        statInput.className = 'inline-edit stat-input';
        statInput.style.textAlign = 'center';
        statInput.min = '-999';
        statInput.max = '999';
        statInput.dataset.field = stat;
        statInput.dataset.original = item[stat] || 0;
        statInput.onblur = () => stageItemChange(item.id, stat, parseInt(statInput.value) || 0);
        statInput.onkeypress = (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            statInput.blur();
          }
        };
        updateStatInputColor(statInput);
        statCell.appendChild(statInput);
        row.appendChild(statCell);
      });
      
      // Attack Speed
      const asCell = document.createElement('td');
      const asInput = document.createElement('input');
      asInput.type = 'number';
      asInput.value = item.attack_speed || 0;
      asInput.className = 'inline-edit';
      asInput.style.textAlign = 'center';
      asInput.min = '0';
      asInput.max = '99.9';
      asInput.step = '0.1';
      asInput.dataset.field = 'attack_speed';
      asInput.dataset.original = item.attack_speed || 0;
      asInput.onblur = () => stageItemChange(item.id, 'attack_speed', parseFloat(asInput.value) || 0);
      asInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          asInput.blur();
        }
      };
      asCell.appendChild(asInput);
      row.appendChild(asCell);
      
      // Health
      const hpCell = document.createElement('td');
      const hpInput = document.createElement('input');
      hpInput.type = 'number';
      hpInput.value = item.health || 0;
      hpInput.className = 'inline-edit stat-input';
      hpInput.style.textAlign = 'center';
      hpInput.min = '-9999';
      hpInput.max = '9999';
      hpInput.dataset.field = 'health';
      hpInput.dataset.original = item.health || 0;
      hpInput.onblur = () => stageItemChange(item.id, 'health', parseInt(hpInput.value) || 0);
      hpInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          hpInput.blur();
        }
      };
      updateStatInputColor(hpInput);
      hpCell.appendChild(hpInput);
      row.appendChild(hpCell);
      
      // Mana
      const mpCell = document.createElement('td');
      const mpInput = document.createElement('input');
      mpInput.type = 'number';
      mpInput.value = item.mana || 0;
      mpInput.className = 'inline-edit stat-input';
      mpInput.style.textAlign = 'center';
      mpInput.min = '-9999';
      mpInput.max = '9999';
      mpInput.dataset.field = 'mana';
      mpInput.dataset.original = item.mana || 0;
      mpInput.onblur = () => stageItemChange(item.id, 'mana', parseInt(mpInput.value) || 0);
      mpInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          mpInput.blur();
        }
      };
      updateStatInputColor(mpInput);
      mpCell.appendChild(mpInput);
      row.appendChild(mpCell);
      
      // AC
      const acCell = document.createElement('td');
      const acInput = document.createElement('input');
      acInput.type = 'number';
      acInput.value = item.ac || 0;
      acInput.className = 'inline-edit stat-input';
      acInput.style.textAlign = 'center';
      acInput.min = '-50';
      acInput.max = '50';
      acInput.dataset.field = 'ac';
      acInput.dataset.original = item.ac || 0;
      acInput.onblur = () => stageItemChange(item.id, 'ac', parseInt(acInput.value) || 0);
      acInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          acInput.blur();
        }
      };
      updateStatInputColor(acInput);
      acCell.appendChild(acInput);
      row.appendChild(acCell);
      
      // Description
      const descCell = document.createElement('td');
      const descTextarea = document.createElement('textarea');
      descTextarea.value = item.description || '';
      descTextarea.className = 'inline-edit';
      descTextarea.style.width = '100%';
      descTextarea.style.minHeight = '50px';
      descTextarea.style.resize = 'vertical';
      descTextarea.rows = 2;
      descTextarea.dataset.field = 'description';
      descTextarea.dataset.original = item.description || '';
      descTextarea.onblur = () => stageItemChange(item.id, 'description', descTextarea.value);
      descTextarea.onkeydown = (e) => {
        // Allow Enter for new lines in textarea
        if (e.key === 'Tab') {
          e.preventDefault();
          descTextarea.blur();
        }
      };
      descCell.appendChild(descTextarea);
      row.appendChild(descCell);
      
      // Actions
      const actionsCell = document.createElement('td');
      const actionsDiv = document.createElement('div');
      actionsDiv.style.display = 'flex';
      actionsDiv.style.gap = '0.5rem';
      actionsDiv.style.justifyContent = 'center';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'small-btn danger-btn';
      deleteBtn.innerHTML = '🗑️';
      deleteBtn.title = 'Delete';
      deleteBtn.onclick = () => markItemForDeletion(item.id);
      actionsDiv.appendChild(deleteBtn);
      
      actionsCell.appendChild(actionsDiv);
      row.appendChild(actionsCell);
      
      return row;
    }
    
    function displayItemPagination() {
      const totalPages = Math.ceil(filteredGameItems.length / GAME_ITEMS_PER_PAGE);
      if (totalPages <= 1) return;
      const paginationDiv = document.getElementById('item-editor-pagination');
      
      if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
      }
      
      paginationDiv.style.display = 'block';
      paginationDiv.innerHTML = '';
      
      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = 'pagination-btn';
      prevBtn.textContent = 'Previous';
      prevBtn.disabled = currentGameItemPage === 0;
      prevBtn.onclick = () => {
        currentGameItemPage--;
        displayItems();
      };
      paginationDiv.appendChild(prevBtn);
      
      // Page info
      const pageInfo = document.createElement('span');
      pageInfo.className = 'pagination-info';
      pageInfo.textContent = `Page ${currentGameItemPage + 1} of ${totalPages}`;
      paginationDiv.appendChild(pageInfo);
      
      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.className = 'pagination-btn';
      nextBtn.textContent = 'Next';
      nextBtn.disabled = currentGameItemPage === totalPages - 1;
      nextBtn.onclick = () => {
        currentGameItemPage++;
        displayItems();
      };
      paginationDiv.appendChild(nextBtn);
    }
    
    function showAddItemModal() {
      editingGameItem = null;
      document.getElementById('item-modal-title').textContent = 'Add Item';
      document.getElementById('item-form').reset();
      document.getElementById('item-emoji-input-group').style.display = 'block';
      document.getElementById('item-modal').style.display = 'flex';
      
      // Initialize emoji picker
      populateItemEmojiPicker('harvest');
      
      // Initialize modal events and preview
      initializeItemModalEvents();
      updateSlotOptions();
    }
    
    /* Old editItem function - no longer needed with inline editing
    function editItem(id) {
      const item = gameItems.find(i => i.id === id);
      if (!item) return;
      
      editingGameItem = item;
      document.getElementById('item-modal-title').textContent = 'Edit Item';
      
      // Populate form
      document.getElementById('item-name').value = item.name || '';
      document.getElementById('item-type').value = item.item_type || '';
      document.getElementById('item-slot').value = item.slot || '';
      document.getElementById('item-description').value = item.description || '';
      
      // Set icon
      document.querySelector(`input[name="item-icon-type"][value="${item.icon_type}"]`).checked = true;
      updateItemIconTypeDisplay();
      
      if (item.icon_type === 'emoji') {
        document.getElementById('item-emoji').value = item.icon_value;
      }
      
      // Set stats
      document.getElementById('item-str').value = item.str || 0;
      document.getElementById('item-sta').value = item.sta || 0;
      document.getElementById('item-agi').value = item.agi || 0;
      document.getElementById('item-dex').value = item.dex || 0;
      document.getElementById('item-wis').value = item.wis || 0;
      document.getElementById('item-int').value = item.int || 0;
      document.getElementById('item-cha').value = item.cha || 0;
      
      // Set combat stats
      document.getElementById('item-attack-speed').value = item.attack_speed || 0;
      document.getElementById('item-health').value = item.health || 0;
      document.getElementById('item-mana').value = item.mana || 0;
      
      // Set additional properties
      document.getElementById('item-ac').value = item.ac || 0;
      
      document.getElementById('item-modal').style.display = 'flex';
      
      // Initialize modal events and preview
      initializeItemModalEvents();
      updateSlotOptions();
    }
    */
    
    /* Old modal functions - commented out as we now use inline editing
    async function saveItem(event) {
      event.preventDefault();
      
      const formData = {
        name: document.getElementById('item-name').value.trim(),
        item_type: document.getElementById('item-type').value,
        slot: document.getElementById('item-slot').value,
        description: document.getElementById('item-description').value.trim(),
        icon_type: document.querySelector('input[name="item-icon-type"]:checked').value,
        icon_value: document.getElementById('item-emoji').value, // TODO: Handle other icon types
        str: parseInt(document.getElementById('item-str').value) || 0,
        sta: parseInt(document.getElementById('item-sta').value) || 0,
        agi: parseInt(document.getElementById('item-agi').value) || 0,
        dex: parseInt(document.getElementById('item-dex').value) || 0,
        wis: parseInt(document.getElementById('item-wis').value) || 0,
        int: parseInt(document.getElementById('item-int').value) || 0,
        cha: parseInt(document.getElementById('item-cha').value) || 0,
        attack_speed: parseFloat(document.getElementById('item-attack-speed').value) || 0,
        health: parseInt(document.getElementById('item-health').value) || 0,
        mana: parseInt(document.getElementById('item-mana').value) || 0,
        ac: parseInt(document.getElementById('item-ac').value) || 0
      };
      
      try {
        const url = editingGameItem ? `/api/items/${editingGameItem.id}` : '/api/items';
        const method = editingGameItem ? 'PUT' : 'POST';
        
        const response = await window.csrfHelper.fetchWithCSRF(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to save item');
        }
        
        showMessage(editingGameItem ? 'Item updated' : 'Item added', 'success');
        closeItemModal();
        await loadItemEditor();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }
    
    // Commented out old modal-based delete function - now using staged deletion
    /*
    async function deleteItem(id) {
      const item = gameItems.find(i => i.id === id);
      if (!item) return;
      
      if (!confirm(`Delete item "${item.name}"? This cannot be undone.`)) return;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/items/${id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to delete item');
        }
        
        showMessage('Item deleted', 'success');
        await loadItemEditor();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }
    
    function closeItemModal() {
      document.getElementById('item-modal').style.display = 'none';
      document.getElementById('item-form').reset();
      editingGameItem = null;
    }
    */ // End of old modal functions
    
    /* These emoji picker functions will be updated for inline editing
    function updateItemIconTypeDisplay() {
      const iconType = document.querySelector('input[name="item-icon-type"]:checked').value;
      document.getElementById('item-emoji-input-group').style.display = iconType === 'emoji' ? 'block' : 'none';
      // TODO: Add other icon type displays
    }
    
    function toggleItemEmojiPicker() {
      const picker = document.getElementById('item-emoji-picker');
      picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
      
      if (picker.style.display === 'block') {
        populateItemEmojiPicker(currentItemEmojiCategory);
      }
    }
    
    function selectItemEmojiCategory(category) {
      currentItemEmojiCategory = category;
      
      // Update active button
      document.querySelectorAll('#item-emoji-picker .emoji-category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      populateItemEmojiPicker(category);
    }
    
    function populateItemEmojiPicker(category) {
      const grid = document.getElementById('item-emoji-grid');
      grid.innerHTML = '';
      grid.className = 'emoji-grid';
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(50px, 1fr))';
      grid.style.gap = '0.5rem';
      grid.style.padding = '1rem';
      grid.style.maxHeight = '300px';
      grid.style.overflowY = 'auto';
      grid.style.background = '#1a1a1a';
      
      const emojis = emojiCategories[category] || [];
      emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.style.fontSize = '1.75rem';
        btn.style.padding = '0.5rem';
        btn.style.border = '1px solid transparent';
        btn.style.background = '#2d2d2d';
        btn.style.cursor = 'pointer';
        btn.style.borderRadius = '6px';
        btn.style.minWidth = '45px';
        btn.style.minHeight = '45px';
        btn.style.display = 'flex';
        btn.style.alignItems = 'center';
        btn.style.justifyContent = 'center';
        btn.style.transition = 'all 0.2s ease';
        btn.textContent = emoji;
        
        btn.onmouseover = () => {
          btn.style.background = '#3d3d3d';
          btn.style.border = '1px solid #FFD700';
          btn.style.transform = 'scale(1.1)';
        };
        
        btn.onmouseout = () => {
          btn.style.background = '#2d2d2d';
          btn.style.border = '1px solid transparent';
          btn.style.transform = 'scale(1)';
        };
        
        btn.onclick = () => {
          document.getElementById('item-emoji').value = emoji;
          document.getElementById('item-emoji-picker').style.display = 'none';
          updateItemPreview();
        };
        
        grid.appendChild(btn);
      });
    }
    */ // End of emoji picker functions to be updated
    
    async function exportItemsToCSV() {
      const headers = ['ID', 'Name', 'Type', 'Slot', 'STR', 'STA', 'AGI', 'DEX', 'WIS', 'INT', 'CHA', 'Attack Speed', 'Health', 'Mana', 'AC', 'Description'];
      const rows = [headers];
      
      filteredGameItems.forEach(item => {
        rows.push([
          item.id,
          item.name,
          item.item_type || '',
          item.slot || '',
          item.str || 0,
          item.sta || 0,
          item.agi || 0,
          item.dex || 0,
          item.wis || 0,
          item.int || 0,
          item.cha || 0,
          item.attack_speed || 0,
          item.health || 0,
          item.mana || 0,
          item.ac || 0,
          item.description || ''
        ]);
      });
      
      const csv = rows.map(row => row.map(cell => {
        const str = String(cell).replace(/"/g, '""');
        return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
      }).join(',')).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `items_export_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    async function reloadItemEditor() {
      if (itemChanges.size > 0) {
        if (!confirm('You have unsaved changes. Reload anyway?')) {
          return;
        }
      }
      itemChanges.clear();
      await loadItemEditor();
      showMessage('Items reloaded', 'info');
    }
    
    // Staging functions for Item Editor
    function stageItemChange(itemId, field, newValue) {
      const row = document.getElementById(`item-row-${itemId}`);
      if (!row) return;
      
      const input = row.querySelector(`[data-field="${field}"]`);
      if (!input) return;
      
      const originalValue = input.dataset.original;
      const cell = input.closest('td');
      
      // Convert values for comparison
      let original = originalValue;
      let current = newValue;
      
      // Handle numeric fields
      if (['str', 'sta', 'agi', 'dex', 'wis', 'int', 'cha', 'health', 'mana', 'ac'].includes(field)) {
        original = parseInt(original) || 0;
        current = parseInt(current) || 0;
      } else if (field === 'attack_speed') {
        original = parseFloat(original) || 0;
        current = parseFloat(current) || 0;
      }
      
      // Check if value changed
      if (String(original) === String(current)) {
        // Remove from changes if it's back to original
        if (itemChanges.has(itemId)) {
          const changes = itemChanges.get(itemId);
          delete changes[field];
          if (Object.keys(changes).length === 0) {
            itemChanges.delete(itemId);
          }
        }
        cell.classList.remove('cell-changed');
      } else {
        // Add to changes
        if (!itemChanges.has(itemId)) {
          itemChanges.set(itemId, {});
        }
        itemChanges.get(itemId)[field] = current;
        cell.classList.add('cell-changed');
      }
      
      updateItemChangeButtons();
    }
    
    function updateItemChangeButtons() {
      const saveBtn = document.getElementById('item-save-btn');
      const resetBtn = document.getElementById('item-reset-btn');
      const changeCountSpan = document.getElementById('item-change-count');
      const changeCount = itemChanges.size;
      
      if (changeCount > 0) {
        saveBtn.disabled = false;
        resetBtn.disabled = false;
        if (changeCountSpan) changeCountSpan.textContent = changeCount;
      } else {
        saveBtn.disabled = true;
        resetBtn.disabled = true;
        if (changeCountSpan) changeCountSpan.textContent = '0';
      }
    }
    
    function updateStatInputColor(input) {
      const value = parseInt(input.value) || 0;
      if (value > 0) {
        input.style.color = '#4ade80';
      } else if (value < 0) {
        input.style.color = '#ef4444';
      } else {
        input.style.color = '';
      }
    }
    
    async function saveItemChanges() {
      if (itemChanges.size === 0) return;
      
      const creates = [];
      const updates = [];
      const deletes = [];
      
      for (const [itemId, changes] of itemChanges.entries()) {
        if (changes._delete) {
          deletes.push(itemId);
        } else if (changes._isNew) {
          // Remove internal flags before sending
          const newItem = { ...changes };
          delete newItem._isNew;
          delete newItem.id; // Remove the 'new' id
          creates.push(newItem);
        } else {
          const item = gameItems.find(i => i.id === parseInt(itemId));
          if (item) {
            updates.push({
              id: itemId,
              ...item,
              ...changes
            });
          }
        }
      }
      
      try {
        // Process creates
        for (const item of creates) {
          const response = await window.csrfHelper.fetchWithCSRF('/api/items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item)
          });
          
          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to create item');
          }
        }
        
        // Process updates
        for (const item of updates) {
          const response = await window.csrfHelper.fetchWithCSRF(`/api/items/${item.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item)
          });
          
          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to update item');
          }
        }
        
        // Process deletes
        for (const itemId of deletes) {
          const response = await window.csrfHelper.fetchWithCSRF(`/api/items/${itemId}`, {
            method: 'DELETE'
          });
          
          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to delete item');
          }
        }
        
        showMessage('All changes saved successfully', 'success');
        itemChanges.clear();
        await loadItemEditor();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }
    
    function resetItemChanges() {
      if (itemChanges.size === 0) return;
      
      if (!confirm('Discard all changes?')) return;
      
      // Reset all values and remove visual indicators
      for (const [itemId, changes] of itemChanges.entries()) {
        // Remove add row if it exists
        if (itemId === 'new' && changes._isNew) {
          const addRow = document.getElementById('item-add-row');
          if (addRow) addRow.remove();
          continue;
        }
        
        const row = document.getElementById(`item-row-${itemId}`);
        if (!row) continue;
        
        if (changes._delete) {
          row.classList.remove('marked-for-deletion');
          const deleteBtn = row.querySelector('.small-btn');
          if (deleteBtn) {
            deleteBtn.innerHTML = '🗑️';
            deleteBtn.title = 'Delete';
            deleteBtn.onclick = () => markItemForDeletion(itemId);
          }
        } else {
          for (const field of Object.keys(changes)) {
            const input = row.querySelector(`[data-field="${field}"]`);
            if (input) {
              input.value = input.dataset.original;
              if (input.classList.contains('stat-input')) {
                updateStatInputColor(input);
              }
              input.closest('td').classList.remove('cell-changed');
            }
          }
        }
      }
      
      itemChanges.clear();
      updateItemChangeButtons();
      showMessage('Changes discarded', 'info');
    }
    
    function markItemForDeletion(itemId) {
      const row = document.getElementById(`item-row-${itemId}`);
      if (!row) return;
      
      if (!itemChanges.has(itemId)) {
        itemChanges.set(itemId, {});
      }
      
      const changes = itemChanges.get(itemId);
      
      if (changes._delete) {
        // Undo deletion
        delete changes._delete;
        if (Object.keys(changes).length === 0) {
          itemChanges.delete(itemId);
        }
        row.classList.remove('marked-for-deletion');
        const deleteBtn = row.querySelector('.small-btn');
        deleteBtn.innerHTML = '🗑️';
        deleteBtn.title = 'Delete';
      } else {
        // Mark for deletion
        changes._delete = true;
        row.classList.add('marked-for-deletion');
        const deleteBtn = row.querySelector('.small-btn');
        deleteBtn.innerHTML = '↩️';
        deleteBtn.title = 'Undo delete';
      }
      
      updateItemChangeButtons();
    }
    
    function showAddItemForm() {
      const tbody = document.getElementById('item-editor-tbody');
      
      // Check if add row already exists
      if (document.getElementById('item-add-row')) {
        showMessage('Add item form is already open', 'warning');
        return;
      }
      
      // Create a new item object with default values
      const newItem = {
        id: 'new',
        name: '',
        item_type: 'weapon',
        slot: '',
        str: 0,
        sta: 0,
        agi: 0,
        dex: 0,
        wis: 0,
        int: 0,
        cha: 0,
        attack_speed: 0,
        health: 0,
        mana: 0,
        ac: 0,
        description: '',
        icon_type: 'emoji',
        icon_value: '⚔️'
      };
      
      // Create the add row
      const addRow = createItemEditorRow(newItem);
      addRow.id = 'item-add-row';
      addRow.style.background = '#2d4a2d'; // Green tint for new item
      
      // Insert at the beginning of the table
      tbody.insertBefore(addRow, tbody.firstChild);
      
      // Focus on the name field
      const nameInput = addRow.querySelector('[data-field="name"]');
      if (nameInput) {
        nameInput.focus();
        nameInput.style.border = '2px solid #4ade80';
      }
      
      // Mark as a new item in changes
      itemChanges.set('new', { ...newItem, _isNew: true });
      updateItemChangeButtons();
      
      showMessage('Fill in the item details and click Save Changes to create', 'info');
    }
    
    function showItemIconPicker(itemId) {
      // TODO: Implement icon picker
      showMessage('Icon picker coming soon', 'info');
    }
    
    // Helper functions for polished Item modal
    function updateStatColor(input) {
      const value = parseInt(input.value) || 0;
      if (value > 0) {
        input.style.color = '#4ade80'; // Green for positive
        input.style.fontWeight = 'bold';
      } else if (value < 0) {
        input.style.color = '#ef4444'; // Red for negative
        input.style.fontWeight = 'bold';
      } else {
        input.style.color = '#ccc'; // Default for zero
        input.style.fontWeight = 'normal';
      }
    }
    
    function updateSlotOptions() {
      const itemType = document.getElementById('item-type').value;
      const slotSelect = document.getElementById('item-slot');
      
      // Clear current options
      slotSelect.innerHTML = '<option value="">None</option>';
      
      // Define slot options based on item type
      const slotOptions = {
        weapon: ['main_hand', 'off_hand', 'two_handed'],
        armor: ['head', 'chest', 'legs', 'feet', 'hands', 'shoulders', 'belt', 'cloak'],
        jewelry: ['ring', 'necklace', 'bracelet', 'earring'],
        consumable: [],
        material: [],
        misc: []
      };
      
      const slots = slotOptions[itemType] || [];
      slots.forEach(slot => {
        const option = document.createElement('option');
        option.value = slot;
        option.textContent = slot.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        slotSelect.appendChild(option);
      });
      
      // If editing and the current slot is in the new options, select it
      if (editingGameItem && slots.includes(editingGameItem.slot)) {
        slotSelect.value = editingGameItem.slot;
      }
    }
    
    function updateItemPreview() {
      const previewIcon = document.getElementById('item-preview-icon');
      const previewName = document.getElementById('item-preview-name');
      const previewStats = document.getElementById('item-preview-stats');
      
      if (!previewIcon || !previewName || !previewStats) return;
      
      const name = document.getElementById('item-name').value || 'New Item';
      const iconType = document.querySelector('input[name="item-icon-type"]:checked')?.value || 'emoji';
      const emoji = document.getElementById('item-emoji').value || '⚔️';
      
      // Update icon
      if (iconType === 'emoji') {
        previewIcon.textContent = emoji;
      }
      
      // Update name
      previewName.textContent = name;
      
      // Update stats
      const stats = {
        STR: parseInt(document.getElementById('item-str').value) || 0,
        STA: parseInt(document.getElementById('item-sta').value) || 0,
        AGI: parseInt(document.getElementById('item-agi').value) || 0,
        DEX: parseInt(document.getElementById('item-dex').value) || 0,
        WIS: parseInt(document.getElementById('item-wis').value) || 0,
        INT: parseInt(document.getElementById('item-int').value) || 0,
        CHA: parseInt(document.getElementById('item-cha').value) || 0
      };
      
      const attackSpeed = parseFloat(document.getElementById('item-attack-speed').value) || 0;
      const health = parseInt(document.getElementById('item-health').value) || 0;
      const mana = parseInt(document.getElementById('item-mana').value) || 0;
      const ac = parseInt(document.getElementById('item-ac').value) || 0;
      
      // Build stats display
      let statsHTML = '';
      const hasStats = Object.values(stats).some(v => v !== 0);
      
      if (hasStats || attackSpeed || health || mana || ac) {
        const statParts = [];
        
        // Add attribute stats
        for (const [stat, value] of Object.entries(stats)) {
          if (value !== 0) {
            const color = value > 0 ? '#4ade80' : '#ef4444';
            const sign = value > 0 ? '+' : '';
            statParts.push(`<span style="color: ${color};">${stat}: ${sign}${value}</span>`);
          }
        }
        
        // Add AC if present
        if (ac !== 0) {
          const color = ac > 0 ? '#4ade80' : '#ef4444';
          const sign = ac > 0 ? '+' : '';
          statParts.push(`<span style="color: ${color};">AC: ${sign}${ac}</span>`);
        }
        
        // Add combat stats
        if (attackSpeed) statParts.push(`<span style="color: #94a3b8;">⚡ ${attackSpeed}</span>`);
        if (health) statParts.push(`<span style="color: #94a3b8;">❤️ ${health}</span>`);
        if (mana) statParts.push(`<span style="color: #94a3b8;">💙 ${mana}</span>`);
        
        statsHTML = statParts.join(' ');
      } else {
        statsHTML = 'No stats';
      }
      
      previewStats.innerHTML = statsHTML;
    }
    
    // Initialize stat color updates when modal opens
    function initializeItemModalEvents() {
      // Add event listeners for stat inputs
      const statInputs = ['str', 'sta', 'agi', 'dex', 'wis', 'int', 'cha', 'ac'];
      statInputs.forEach(stat => {
        const input = document.getElementById(`item-${stat}`);
        if (input) {
          input.addEventListener('input', function() {
            updateStatColor(this);
            updateItemPreview();
          });
          // Initialize color on load
          updateStatColor(input);
        }
      });
      
      // Add event listeners for other inputs
      document.getElementById('item-name')?.addEventListener('input', updateItemPreview);
      document.getElementById('item-emoji')?.addEventListener('input', updateItemPreview);
      document.getElementById('item-attack-speed')?.addEventListener('input', updateItemPreview);
      document.getElementById('item-health')?.addEventListener('input', updateItemPreview);
      document.getElementById('item-mana')?.addEventListener('input', updateItemPreview);
      document.getElementById('item-ac')?.addEventListener('input', updateItemPreview);
      document.getElementById('item-type')?.addEventListener('change', updateSlotOptions);
      
      // Initialize preview
      updateItemPreview();
    }
    
    // XP Configuration Functions
    async function loadXPConfig() {
      const loading = document.getElementById('xp-config-loading');
      const content = document.getElementById('xp-config-content');
      const tbody = document.getElementById('xp-config-tbody');
      
      if (!loading || !content || !tbody) {
        console.error('XP config elements not found:', { loading, content, tbody });
        return;
      }
      
      loading.style.display = 'block';
      content.style.display = 'none';
      
      try {
        const response = await fetch('/api/admin/xp-config');
        if (response.ok) {
          const configs = await response.json();
          
          tbody.innerHTML = '';
          configs.forEach(config => {
            const row = document.createElement('tr');
            const displayName = getXPActionName(config.key);
            
            // Action name cell
            row.appendChild(createTextCell(displayName));
            
            // Description cell
            row.appendChild(createTextCell(config.description));
            
            // XP input cell
            const inputCell = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'number';
            input.id = `xp-${config.key}`;
            input.value = config.value;
            input.className = 'xp-input';
            input.min = '-100';
            input.max = '100';
            inputCell.appendChild(input);
            row.appendChild(inputCell);
            
            // Update button cell
            const btnCell = document.createElement('td');
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm';
            btn.textContent = 'Update';
            btn.onclick = () => updateXPConfig(config.key);
            btnCell.appendChild(btn);
            row.appendChild(btnCell);
            
            tbody.appendChild(row);
          });
          
          loading.style.display = 'none';
          content.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading XP config:', error);
        loading.innerHTML = '<p style="color: #dc3545;">Failed to load XP configuration</p>';
      }
    }
    
    function getXPActionName(key) {
      const names = {
        'poi_publish': 'Publish POI',
        'poi_pending_remove': 'Remove from Pending',
        'poi_approved': 'POI Approved',
        'proposal_vote': 'Vote on Proposal',
        'change_approved': 'Change Approved'
      };
      return names[key] || key;
    }
    
    async function updateXPConfig(key) {
      const input = document.getElementById(`xp-${key}`);
      const value = parseInt(input.value);
      
      if (isNaN(value)) {
        showMessage('Please enter a valid number', 'error');
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/xp-config/${key}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value })
        });
        
        if (response.ok) {
          showMessage('XP configuration updated successfully', 'success');
        } else {
          showMessage('Failed to update XP configuration', 'error');
        }
      } catch (error) {
        console.error('Error updating XP config:', error);
        showMessage('Failed to update XP configuration', 'error');
      }
    }

    // User Management Functions
    let allUsers = [];
    let filteredUsers = [];
    let usersCurrentPage = 1;
    let selectedUser = null;
    
    async function loadUsers() {
      const loading = document.getElementById('user-management-loading');
      const content = document.getElementById('user-management-content');
      
      loading.style.display = 'block';
      content.style.display = 'none';
      
      try {
        const response = await fetch('/api/admin/users');
        if (response.ok) {
          allUsers = await response.json();
          filteredUsers = [...allUsers];
          displayUsers();
          
          loading.style.display = 'none';
          content.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading users:', error);
        loading.innerHTML = '<p style="color: #dc3545;">Failed to load users</p>';
      }
    }
    
    function refreshUsers() {
      // Clear search when refreshing
      document.getElementById('user-search').value = '';
      // Reload users
      loadUsers();
    }
    
    function searchUsers() {
      const searchTerm = document.getElementById('user-search').value.toLowerCase();
      
      if (searchTerm) {
        filteredUsers = allUsers.filter(user => 
          user.name.toLowerCase().includes(searchTerm) || 
          user.email.toLowerCase().includes(searchTerm)
        );
      } else {
        filteredUsers = [...allUsers];
      }
      
      usersCurrentPage = 1;
      displayUsers();
    }
    
    function displayUsers() {
      const totalPages = Math.ceil(filteredUsers.length / ITEMS_PER_PAGE);
      usersCurrentPage = Math.max(1, Math.min(usersCurrentPage, totalPages || 1));
      
      const tbody = document.getElementById('users-tbody');
      tbody.innerHTML = '';
      
      if (filteredUsers.length === 0) {
        document.getElementById('users-pagination').style.display = 'none';
        const row = document.createElement('tr');
        const noDataCell = document.createElement('td');
        noDataCell.colSpan = 8;
        noDataCell.style.textAlign = 'center';
        noDataCell.style.color = '#666';
        noDataCell.style.padding = '2rem';
        noDataCell.textContent = 'No users found';
        row.appendChild(noDataCell);
        tbody.appendChild(row);
      } else {
        document.getElementById('users-pagination').style.display = totalPages > 1 ? 'flex' : 'none';
        
        const startIndex = (usersCurrentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const pageUsers = filteredUsers.slice(startIndex, endIndex);
        
        pageUsers.forEach(user => {
          const row = document.createElement('tr');
          const statusBadge = getUserStatusBadge(user);
          
          // Always use DOM manipulation for consistent rendering
          const cells = [
            createImageCell(user.custom_avatar, user.picture, user.display_name || user.name),
            createTextCell(user.display_name || user.name),
            createTextCell(user.email),
            createXPCell(user.xp || 0),
            createTextCell(user.poi_count || 0),
            createHTMLCell(statusBadge),
            createTextCell(new Date(user.created_at).toLocaleDateString()),
            createButtonCell(user.id)
          ];
          cells.forEach(cell => row.appendChild(cell));
          tbody.appendChild(row);
        });
        
        document.getElementById('users-page-info').textContent = `Page ${usersCurrentPage} of ${totalPages}`;
        document.getElementById('users-prev').disabled = usersCurrentPage === 1;
        document.getElementById('users-next').disabled = usersCurrentPage === totalPages;
      }
    }
    
    function getUserStatusBadge(user) {
      if (user.is_banned) {
        return '<span style="background: #dc3545; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Banned</span>';
      } else if (user.is_admin) {
        return '<span style="background: #FFD700; color: #2a1810; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Admin</span>';
      } else {
        return '<span style="background: #28a745; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Active</span>';
      }
    }
    
    function changeUsersPage(direction) {
      const totalPages = Math.ceil(filteredUsers.length / ITEMS_PER_PAGE);
      usersCurrentPage += direction;
      usersCurrentPage = Math.max(1, Math.min(usersCurrentPage, totalPages));
      displayUsers();
    }
    
    async function viewUserDetails(userId) {
      try {
        const response = await fetch(`/api/admin/users/${userId}`);
        if (response.ok) {
          selectedUser = await response.json();
          displayUserModal(selectedUser);
        }
      } catch (error) {
        showMessage('Failed to load user details', 'error');
      }
    }
    
    function displayUserModal(user) {
      const detailAvatar = document.getElementById('detail-user-avatar');
      // custom_avatar already contains the full URL from the API
      detailAvatar.src = user.custom_avatar || user.picture;
      
      // Add fallback to Google picture
      detailAvatar.onerror = function() {
        if (user.picture && this.src !== user.picture) {
          this.src = user.picture;
          this.onerror = null; // Prevent infinite loop
        } else {
          this.style.display = 'none';
        }
      };
      document.getElementById('detail-user-name').textContent = user.display_name || user.name;
      document.getElementById('detail-user-email').textContent = user.email;
      document.getElementById('detail-user-id').textContent = user.id;
      document.getElementById('detail-user-joined').textContent = new Date(user.created_at).toLocaleString();
      document.getElementById('detail-user-last-active').textContent = user.last_visit ? new Date(user.last_visit).toLocaleString() : 'Never';
      document.getElementById('detail-user-xp').textContent = user.xp || 0;
      document.getElementById('detail-user-admin').textContent = user.is_admin ? 'Yes' : 'No';
      
      document.getElementById('detail-user-total-pois').textContent = user.total_pois || 0;
      document.getElementById('detail-user-published-pois').textContent = user.published_pois || 0;
      document.getElementById('detail-user-votes').textContent = user.votes_cast || 0;
      
      // Update status
      const statusEl = document.getElementById('detail-user-status');
      if (user.is_banned) {
        statusEl.textContent = 'Banned';
        statusEl.style.background = '#dc3545';
        statusEl.style.color = 'white';
        document.getElementById('ban-user-btn').style.display = 'none';
        document.getElementById('unban-user-btn').style.display = 'inline-flex';
      } else {
        statusEl.textContent = 'Active';
        statusEl.style.background = '#28a745';
        statusEl.style.color = 'white';
        document.getElementById('ban-user-btn').style.display = 'inline-flex';
        document.getElementById('unban-user-btn').style.display = 'none';
      }
      
      // Update admin toggle button
      const toggleBtn = document.getElementById('toggle-admin-text');
      toggleBtn.textContent = user.is_admin ? 'Remove Admin' : 'Make Admin';
      
      // Show warnings if any
      if (user.warnings && user.warnings.length > 0) {
        document.getElementById('user-warnings-section').style.display = 'block';
        const warningsList = document.getElementById('user-warnings-list');
        warningsList.innerHTML = user.warnings.map(w => `
          <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border-left: 3px solid #ffc107;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
              <strong style="color: #ffc107;">${new Date(w.created_at).toLocaleDateString()}</strong>
              <span style="color: #888; font-size: 0.85rem;">by ${w.admin_name}</span>
            </div>
            <p style="margin: 0; color: #e0e0e0; line-height: 1.4;">${w.reason}</p>
          </div>
        `).join('');
      } else {
        document.getElementById('user-warnings-section').style.display = 'none';
      }
      
      document.getElementById('user-detail-modal').style.display = 'block';
    }
    
    function closeUserModal() {
      document.getElementById('user-detail-modal').style.display = 'none';
      selectedUser = null;
    }
    
    async function banUser() {
      if (!confirm('Are you sure you want to ban this user? They will be immediately logged out and unable to access their account.')) return;
      
      const reason = prompt('Enter reason for ban:');
      if (!reason) return;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/users/${selectedUser.id}/ban`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        
        if (response.ok) {
          showMessage('User banned successfully', 'success');
          closeUserModal();
          loadUsers();
        }
      } catch (error) {
        showMessage('Failed to ban user', 'error');
      }
    }
    
    async function unbanUser() {
      if (!confirm('Are you sure you want to unban this user?')) return;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/users/${selectedUser.id}/unban`, {
          method: 'POST'
        });
        
        if (response.ok) {
          showMessage('User unbanned successfully', 'success');
          closeUserModal();
          loadUsers();
        }
      } catch (error) {
        showMessage('Failed to unban user', 'error');
      }
    }
    
    async function warnUser() {
      if (!confirm('Are you sure you want to send a warning to this user?')) return;
      
      const reason = prompt('Enter warning message:');
      if (!reason) return;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/users/${selectedUser.id}/warn`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        
        if (response.ok) {
          showMessage('Warning sent to user', 'success');
          viewUserDetails(selectedUser.id); // Reload to show new warning
        }
      } catch (error) {
        showMessage('Failed to warn user', 'error');
      }
    }
    
    async function logoutUser() {
      if (!confirm('Are you sure you want to force logout this user from all sessions? They will need to sign in again to access their account.')) return;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/users/${selectedUser.id}/logout`, {
          method: 'POST'
        });
        
        if (response.ok) {
          showMessage('User logged out from all sessions', 'success');
        }
      } catch (error) {
        showMessage('Failed to logout user', 'error');
      }
    }
    
    async function toggleAdminStatus() {
      const action = selectedUser.is_admin ? 'remove admin privileges from' : 'grant admin privileges to';
      if (!confirm(`Are you sure you want to ${action} this user?`)) return;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/users/${selectedUser.id}/admin`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_admin: !selectedUser.is_admin })
        });
        
        if (response.ok) {
          showMessage(`Admin status ${selectedUser.is_admin ? 'removed' : 'granted'}`, 'success');
          closeUserModal();
          loadUsers();
        }
      } catch (error) {
        showMessage('Failed to update admin status', 'error');
      }
    }
    
    function viewUserPois() {
      if (!confirm(`View all POIs created by ${selectedUser.name}?`)) return;
      sessionStorage.setItem('viewUserPois', selectedUser.id);
      window.open('/', '_blank');
    }
    
    // XP Adjustment functions
    function showXPAdjustment() {
      if (!selectedUser) return;
      
      const xpAvatar = document.getElementById('xp-user-avatar');
      const xpAvatarUrl = selectedUser.custom_avatar ? `/avatars/${selectedUser.custom_avatar}` : selectedUser.picture;
      xpAvatar.src = xpAvatarUrl;
      
      // Add fallback to Google picture
      xpAvatar.onerror = function() {
        if (selectedUser.picture && this.src !== selectedUser.picture) {
          this.src = selectedUser.picture;
        } else {
          this.style.display = 'none';
        }
      };
      document.getElementById('xp-user-name').textContent = selectedUser.display_name || selectedUser.name;
      document.getElementById('xp-current').textContent = selectedUser.xp || 0;
      document.getElementById('xp-new-value').value = selectedUser.xp || 0;
      document.getElementById('xp-reason').value = '';
      
      document.getElementById('xp-adjustment-modal').style.display = 'block';
    }
    
    function closeXPModal() {
      document.getElementById('xp-adjustment-modal').style.display = 'none';
    }
    
    async function updateUserXP() {
      const newXP = parseInt(document.getElementById('xp-new-value').value);
      const reason = document.getElementById('xp-reason').value;
      
      if (isNaN(newXP) || newXP < 0) {
        showMessage('Please enter a valid XP value', 'error');
        return;
      }
      
      const currentXP = selectedUser.xp || 0;
      if (newXP === currentXP) {
        showMessage('XP value unchanged', 'error');
        return;
      }
      
      const xpChange = newXP - currentXP;
      const changeText = xpChange > 0 ? `+${xpChange}` : `${xpChange}`;
      
      if (!confirm(`Are you sure you want to change ${selectedUser.name}'s XP from ${currentXP} to ${newXP} (${changeText})?`)) return;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/users/${selectedUser.id}/xp`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ xp: newXP, reason })
        });
        
        if (response.ok) {
          showMessage('XP updated successfully', 'success');
          closeXPModal();
          // Refresh user details to show new XP
          viewUserDetails(selectedUser.id);
        } else {
          const data = await response.json();
          showMessage(data.error || 'Failed to update XP', 'error');
        }
      } catch (error) {
        showMessage('Failed to update XP', 'error');
      }
    }
    
    // Update close modal handler
    window.onclick = function(event) {
      const userModal = document.getElementById('user-detail-modal');
      const xpModal = document.getElementById('xp-adjustment-modal');
      
      if (event.target === userModal) {
        closeUserModal();
      } else if (event.target === xpModal) {
        closeXPModal();
      }
    }

    // Profile customization functions
    async function handleAvatarUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file size
      if (file.size > 5 * 1024 * 1024) {
        showMessage('File size must be less than 5MB', 'error');
        return;
      }
      
      // Show loading
      document.getElementById('avatar-loading').style.display = 'flex';
      document.getElementById('upload-progress-bar').style.width = '0%';
      document.getElementById('upload-status').textContent = '';
      
      const formData = new FormData();
      formData.append('avatar', file);
      
      try {
        // Simulate upload progress
        const progressBar = document.getElementById('upload-progress-bar');
        const statusText = document.getElementById('upload-status');
        
        // Upload phase (0-60%)
        progressBar.style.width = '20%';
        statusText.textContent = 'Uploading...';
        
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 60);
            progressBar.style.width = percentComplete + '%';
          }
        });
        
        // Create a promise for the XHR request
        const uploadPromise = new Promise((resolve, reject) => {
          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve(JSON.parse(xhr.responseText));
            } else {
              reject(new Error(xhr.statusText));
            }
          };
          xhr.onerror = () => reject(new Error('Network error'));
        });
        
        // Get CSRF token first
        const csrfResponse = await fetch('/api/csrf-token');
        const csrfData = await csrfResponse.json();
        
        xhr.open('POST', '/api/user/profile/avatar');
        xhr.setRequestHeader('X-CSRF-Token', csrfData.csrfToken);
        xhr.send(formData);
        
        const data = await uploadPromise;
        
        // Processing phase (60-80%)
        progressBar.style.width = '80%';
        statusText.textContent = 'Processing image...';
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Verification phase (80-100%)
        progressBar.style.width = '90%';
        statusText.textContent = 'Verifying upload...';
        
        // Verify the uploaded avatar
        const verifyResponse = await fetch('/api/user/profile/avatar/verify');
        const verifyData = await verifyResponse.json();
        
        if (verifyData.verified) {
          progressBar.style.width = '100%';
          statusText.textContent = '✓ Upload verified!';
          
          // Update all avatar displays
          const newAvatarUrl = data.avatarUrl;
          
          // Add timestamp to force reload
          const timestampedUrl = newAvatarUrl + (newAvatarUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
          
          document.getElementById('user-avatar').src = timestampedUrl;
          document.getElementById('preview-avatar').src = timestampedUrl;
          
          // Update current user data
          currentUser.custom_avatar = newAvatarUrl;
          currentUser.picture = newAvatarUrl;
          
          // Show reset button
          document.getElementById('reset-avatar-btn').style.display = 'inline-block';
          
          // Wait a moment to show completion
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          showMessage('Profile picture updated and verified successfully', 'success');
          
          // Trigger auth status refresh to update main app
          window.dispatchEvent(new Event('avatar-updated'));
        } else {
          progressBar.style.width = '90%';
          statusText.textContent = '✗ Verification failed';
          showMessage('Avatar upload failed verification. Please try again.', 'error');
        }
      } catch (error) {
        document.getElementById('upload-progress-bar').style.width = '0%';
        document.getElementById('upload-status').textContent = '✗ Upload failed';
        showMessage('Failed to upload image: ' + error.message, 'error');
      } finally {
        // Hide loading after a delay
        setTimeout(() => {
          document.getElementById('avatar-loading').style.display = 'none';
          document.getElementById('upload-progress-bar').style.width = '0%';
          document.getElementById('upload-status').textContent = '';
        }, 1500);
        
        // Reset file input
        document.getElementById('avatar-upload').value = '';
      }
    }
    
    async function resetAvatar() {
      if (!confirm('Reset to your Google profile picture? This will permanently delete all your custom avatars.')) return;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF('/api/user/profile/avatar/reset', {
          method: 'POST'
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Fetch user profile to get original Google picture
          const profileResponse = await fetch('/api/user/profile');
          const profile = await profileResponse.json();
          
          // Revert to Google picture
          const googlePicture = profile.picture;
          document.getElementById('user-avatar').src = googlePicture;
          document.getElementById('preview-avatar').src = googlePicture;
          
          // Update current user data
          currentUser.custom_avatar = null;
          currentUser.avatar_filename = null;
          
          // Hide reset button
          document.getElementById('reset-avatar-btn').style.display = 'none';
          
          showMessage(`Profile picture reset successfully. ${data.filesDeleted} avatar file(s) deleted.`, 'success');
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to reset profile picture', 'error');
        }
      } catch (error) {
        showMessage('Failed to reset profile picture', 'error');
      }
    }
    
    async function updateNickname() {
      const nickname = document.getElementById('nickname-input').value.trim();
      const errorEl = document.getElementById('nickname-error');
      
      // Clear previous error
      errorEl.style.display = 'none';
      errorEl.textContent = '';
      
      // Client-side validation
      if (nickname) {
        if (nickname.length < 3) {
          errorEl.textContent = 'Nickname must be at least 3 characters long';
          errorEl.style.display = 'block';
          return;
        }
        
        if (nickname.length > 50) {
          errorEl.textContent = 'Nickname must be 50 characters or less';
          errorEl.style.display = 'block';
          return;
        }
        
        if (!/^[a-zA-Z0-9_\-\s]+$/.test(nickname)) {
          errorEl.textContent = 'Nickname can only contain letters, numbers, spaces, underscores, and hyphens';
          errorEl.style.display = 'block';
          return;
        }
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF('/api/user/profile/nickname', {
          method: 'PUT',
          body: { nickname }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Update display name
          const newDisplayName = nickname || currentUser.name;
          document.getElementById('user-name').textContent = newDisplayName;
          
          // Update current user data
          currentUser.nickname = nickname;
          currentUser.displayName = newDisplayName;
          
          showMessage('Display name updated successfully', 'success');
          errorEl.style.display = 'none';
        } else {
          const error = await response.json();
          errorEl.textContent = error.error || 'Failed to update nickname';
          errorEl.style.display = 'block';
        }
      } catch (error) {
        errorEl.textContent = 'Failed to update nickname';
        errorEl.style.display = 'block';
      }
    }

    // Helper functions for safe DOM manipulation
    function createTextCell(text) {
      const cell = document.createElement('td');
      cell.textContent = text;
      return cell;
    }
    
    function createImageCell(avatarUrl, googleUrl, alt) {
      const cell = document.createElement('td');
      cell.style.textAlign = 'center';
      const img = document.createElement('img');
      img.src = avatarUrl || googleUrl;
      img.alt = alt;
      img.style.width = '32px';
      img.style.height = '32px';
      img.style.borderRadius = '50%';
      img.style.objectFit = 'cover';
      
      // Add fallback to Google avatar on error
      if (avatarUrl && googleUrl && avatarUrl !== googleUrl) {
        img.onerror = function() {
          console.log(`Avatar failed to load for ${alt}, falling back to Google picture`);
          this.onerror = null; // Prevent infinite loop
          this.src = googleUrl;
        };
      }
      
      cell.appendChild(img);
      return cell;
    }
    
    function createXPCell(xp) {
      const cell = document.createElement('td');
      cell.style.color = '#FFD700';
      cell.style.fontWeight = 'bold';
      cell.textContent = xp;
      return cell;
    }
    
    function createHTMLCell(html) {
      const cell = document.createElement('td');
      cell.innerHTML = html; // This is safe because statusBadge is generated by our code
      return cell;
    }
    
    function createButtonCell(userId) {
      const cell = document.createElement('td');
      const button = document.createElement('button');
      button.className = 'small-btn info-btn';
      button.onclick = () => viewUserDetails(userId);
      const span = document.createElement('span');
      span.className = 'btn-icon';
      span.textContent = '👁️';
      button.appendChild(span);
      button.appendChild(document.createTextNode('Details'));
      cell.appendChild(button);
      return cell;
    }

    // Setup event listeners after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Expose POI action functions to window for event delegation
      window.goToPoi = goToPoi;
      window.sharePoi = sharePoi;
      window.deletePoi = deletePoi;
      window.publishPoi = publishPoi;
      window.votePoi = votePoi;
      
      // Expose modal and admin functions to window for event delegation
      window.closeVoteModal = closeVoteModal;
      window.closeXPModal = closeXPModal;
      window.updateUserXP = updateUserXP;
      window.closeUserModal = closeUserModal;
      window.showXPAdjustment = showXPAdjustment;
      window.banUser = banUser;
      window.unbanUser = unbanUser;
      window.warnUser = warnUser;
      window.logoutUser = logoutUser;
      window.viewUserPois = viewUserPois;
      window.toggleAdminStatus = toggleAdminStatus;
      window.changeUsersPage = changeUsersPage;
      
      // Note: Voting functions will be exposed after they are defined
      
      // Handle all data-action elements
      document.addEventListener('click', function(e) {
        
        // Find the closest element with data-action attribute
        const actionElement = e.target.closest('[data-action]');
        if (!actionElement) {
          return;
        }
        
        const action = actionElement.getAttribute('data-action');
        if (action) {
          e.preventDefault();
          const args = actionElement.getAttribute('data-args');
          
          // Call the appropriate function
          if (window[action]) {
            if (args) {
              // Parse arguments and call function
              try {
                // Handle multiple comma-separated arguments
                if (args.includes(',')) {
                  // Split by comma and trim whitespace
                  const argArray = args.split(',').map(arg => {
                    arg = arg.trim();
                    // Convert to number if it's a number
                    if (arg.match(/^-?\d+$/)) {
                      return parseInt(arg);
                    }
                    // Handle boolean strings
                    if (arg === 'true') return true;
                    if (arg === 'false') return false;
                    // Remove quotes if present
                    if ((arg.startsWith("'") && arg.endsWith("'")) || 
                        (arg.startsWith('"') && arg.endsWith('"'))) {
                      return arg.slice(1, -1);
                    }
                    return arg;
                  });
                  // Call function with spread arguments
                  window[action](...argArray);
                } else {
                  // Single argument
                  if (args.match(/^-?\d+$/)) {
                    window[action](parseInt(args));
                  } else if (args.match(/^'.*'$/) || args.match(/^".*"$/)) {
                    window[action](args.slice(1, -1));
                  } else {
                    window[action](args);
                  }
                }
              } catch (error) {
                console.error('Error calling function:', action, error);
              }
            } else {
              window[action]();
            }
          } else {
            console.error('Function not found:', action);
          }
        }
      });
      
      // Tab navigation
      document.querySelectorAll('.nav-item').forEach(button => {
        const tabName = button.textContent.includes('Profile') ? 'profile' :
                       button.textContent.includes('Preferences') ? 'preferences' :
                       button.textContent.includes('Privacy') ? 'privacy' :
                       button.textContent.includes('Custom POIs') ? 'custom-pois' :
                       button.textContent.includes('Voting') ? 'voting' :
                       button.textContent.includes('Admin') ? 'admin' : null;
        
        if (tabName) {
          button.addEventListener('click', () => showTab(tabName));
        }
      });
      
      // Preferences tab buttons
      const resetAvatarBtn = document.getElementById('reset-avatar-btn');
      if (resetAvatarBtn) {
        resetAvatarBtn.addEventListener('click', resetAvatar);
      }
      
      // Save nickname button
      const saveNicknameBtn = document.getElementById('save-nickname-btn');
      if (saveNicknameBtn) {
        saveNicknameBtn.addEventListener('click', updateNickname);
      }
      
      // Privacy tab buttons
      const deleteAccountBtn = document.getElementById('delete-account-btn');
      if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', deleteAccount);
      }
      
      const logoutAllBtn = document.getElementById('logout-all-btn');
      if (logoutAllBtn) {
        logoutAllBtn.addEventListener('click', logoutAll);
      }
      
      // Pagination buttons
      const myPoisPrev = document.getElementById('my-pois-prev');
      if (myPoisPrev) {
        myPoisPrev.addEventListener('click', () => changeMyPoisPage(-1));
      }
      
      const myPoisNext = document.getElementById('my-pois-next');
      if (myPoisNext) {
        myPoisNext.addEventListener('click', () => changeMyPoisPage(1));
      }
      
      const sharedPoisPrev = document.getElementById('shared-pois-prev');
      if (sharedPoisPrev) {
        sharedPoisPrev.addEventListener('click', () => changeSharedPoisPage(-1));
      }
      
      const sharedPoisNext = document.getElementById('shared-pois-next');
      if (sharedPoisNext) {
        sharedPoisNext.addEventListener('click', () => changeSharedPoisPage(1));
      }
      
      // Admin search button
      const adminSearchBtn = document.querySelector('.admin-controls button');
      if (adminSearchBtn && adminSearchBtn.textContent === 'Search') {
        adminSearchBtn.addEventListener('click', searchUsers);
      }
      
      // Users pagination
      const usersPrev = document.getElementById('users-prev');
      if (usersPrev) {
        usersPrev.addEventListener('click', () => changeUsersPage(-1));
      }
      
      const usersNext = document.getElementById('users-next');
      if (usersNext) {
        usersNext.addEventListener('click', () => changeUsersPage(1));
      }
    });

    // Function to load initial proposal count
    async function loadInitialProposalCount() {
      try {
        const response = await fetch('/api/change-proposals');
        if (response.ok) {
          const proposals = await response.json();
          updateVotingTabCount(proposals.length);
        }
      } catch (error) {
        console.error('Error loading initial proposal count:', error);
      }
    }
    
    // Helper function to update voting tab count
    function updateVotingTabCount(count) {
      const votingTabBtn = document.getElementById('voting-tab-btn');
      if (votingTabBtn) {
        if (count > 0) {
          votingTabBtn.innerHTML = `🗳️ Voting (${count})`;
        } else {
          votingTabBtn.innerHTML = '🗳️ Voting';
        }
      }
    }

    // Initialize
    checkAuth();
    
    // Load initial proposal count for voting tab
    loadInitialProposalCount();
    
    // Handle URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    const section = urlParams.get('section');
    const highlightId = urlParams.get('highlight');
    
    // Store highlight ID for later use
    window.poiEditorHighlightId = highlightId;
    
    // Add click handlers for sortable table headers
    document.addEventListener('click', (e) => {
      if (e.target.matches('.poi-editor-table th[data-sort]')) {
        const field = e.target.dataset.sort;
        
        // Update sort direction
        if (sortField === field) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = field;
          sortDirection = 'asc';
        }
        
        // Update header classes
        document.querySelectorAll('.poi-editor-table th').forEach(th => {
          th.classList.remove('sorted-asc', 'sorted-desc');
        });
        e.target.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        
        // Re-apply filters and display
        applySearchFilter();
      }
    });
  </script>

  <!-- Share Code Modal -->
  <div id="share-code-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Share POI</h3>
        <button class="close-btn" onclick="closeShareCodeModal()">×</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1rem;">Share this code with others to let them add this POI to their map:</p>
        
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
          <input type="text" id="share-code-display" readonly 
                 style="flex: 1; padding: 1rem; font-size: 1.5rem; font-family: monospace; 
                        text-align: center; letter-spacing: 2px; background: #2d2d2d; 
                        border: 2px solid #4a7c59; border-radius: 8px; color: #4dff4d;">
          <button class="btn" onclick="copyShareCode()" style="padding: 1rem;">
            📋 Copy
          </button>
        </div>
        
        <div id="share-users-section" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #444;">
          <h4 style="color: #FFD700; margin-bottom: 1rem;">Users sharing this POI:</h4>
          <div id="share-users-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
        
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #444;">
          <p style="color: #999; font-size: 0.9rem; margin-bottom: 1rem;">
            ⚠️ Creating a new share code will invalidate the previous code and remove access for all users who were using it.
          </p>
          <div style="display: flex; gap: 1rem;">
            <button class="btn secondary-btn" onclick="regenerateShareCode()">
              🔄 Generate New Code
            </button>
            <button class="btn danger-btn" onclick="revokeShareCode()">
              🚫 Revoke Share
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Users Modal -->
  <div id="share-users-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 id="share-users-title">Users Sharing This POI</h3>
        <button class="close-btn" onclick="closeShareUsersModal()">×</button>
      </div>
      <div class="modal-body">
        <div id="share-users-loading" style="text-align: center; padding: 2rem;">
          Loading users...
        </div>
        <div id="share-users-content" style="display: none;">
          <div id="share-users-list-modal" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Shared POI Modal -->
  <div id="add-shared-poi-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; height: auto; margin-top: 10%; margin-bottom: auto;">
      <div class="modal-header">
        <h3>Add Shared POI</h3>
        <button class="close-btn" onclick="closeAddSharedPOIModal()">×</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1rem;">Enter the share code you received:</p>
        
        <input type="text" id="share-code-input" placeholder="Enter share code" maxlength="10"
               style="width: 100%; padding: 1rem; font-size: 1.2rem; font-family: monospace; 
                      text-align: center; letter-spacing: 2px; text-transform: uppercase;
                      background: #2d2d2d; border: 2px solid #555; border-radius: 8px; 
                      color: #e0e0e0; margin-bottom: 1.5rem;"
               onkeyup="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')"
               onkeypress="if(event.key === 'Enter') addSharedPOI()">
        
        <div style="display: flex; gap: 1rem;">
          <button class="btn" onclick="addSharedPOI()" style="flex: 1;">
            ➕ Add POI
          </button>
          <button class="btn secondary-btn" onclick="closeAddSharedPOIModal()">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Share code modal functions
    let currentSharePoiId = null;

    function showShareCodeModal(shareCode, poiId) {
      currentSharePoiId = poiId;
      document.getElementById('share-code-display').value = shareCode;
      document.getElementById('share-code-modal').style.display = 'flex';
      
      // Load users who have this POI shared
      loadShareUsers(poiId);
    }

    function closeShareCodeModal() {
      document.getElementById('share-code-modal').style.display = 'none';
      currentSharePoiId = null;
    }

    function copyShareCode() {
      const shareCode = document.getElementById('share-code-display').value;
      navigator.clipboard.writeText(shareCode).then(() => {
        showMessage('Share code copied to clipboard!', 'success');
      }).catch(() => {
        // Fallback
        document.getElementById('share-code-display').select();
        document.execCommand('copy');
        showMessage('Share code copied!', 'success');
      });
    }

    async function loadShareUsers(poiId) {
      try {
        const response = await fetch(`/api/custom-pois/${poiId}/shared-users`);
        if (response.ok) {
          const data = await response.json();
          const section = document.getElementById('share-users-section');
          const list = document.getElementById('share-users-list');
          
          if (data.users.length > 0) {
            section.style.display = 'block';
            list.innerHTML = data.users.map(user => `
              <div style="padding: 0.5rem; border-bottom: 1px solid #333;">
                <span style="color: #FFD700;">${window.escapeHTML(user.display_name)}</span>
                <span style="color: #999; font-size: 0.85rem; margin-left: 1rem;">
                  Added ${new Date(user.added_at).toLocaleDateString()}
                </span>
              </div>
            `).join('');
          } else {
            section.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading share users:', error);
      }
    }

    async function regenerateShareCode() {
      if (!confirm('Are you sure? This will invalidate the current share code and remove access for all users currently using it.')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/custom-pois/${currentSharePoiId}/share`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const data = await response.json();
          document.getElementById('share-code-display').value = data.shareCode;
          showMessage('New share code generated', 'success');
          loadShareUsers(currentSharePoiId);
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to generate new code', 'error');
        }
      } catch (error) {
        showMessage('Failed to generate new code', 'error');
      }
    }

    async function revokeShareCode() {
      if (!confirm('Are you sure? This will revoke the share code and remove access for all users currently using it.')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/custom-pois/${currentSharePoiId}/revoke-share`, {
          method: 'POST'
        });
        
        if (response.ok) {
          showMessage('Share code revoked', 'success');
          closeShareCodeModal();
          loadCustomPois(); // Refresh the list
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to revoke share', 'error');
        }
      } catch (error) {
        showMessage('Failed to revoke share', 'error');
      }
    }

    // Add shared POI modal functions
    function showAddSharedPOIModal() {
      document.getElementById('share-code-input').value = '';
      document.getElementById('add-shared-poi-modal').style.display = 'flex';
      document.getElementById('share-code-input').focus();
    }

    function closeAddSharedPOIModal() {
      document.getElementById('add-shared-poi-modal').style.display = 'none';
    }

    async function addSharedPOI() {
      const shareCode = document.getElementById('share-code-input').value.trim();
      
      if (!shareCode) {
        showMessage('Please enter a share code', 'error');
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF('/api/custom-pois/add-shared', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ shareCode })
        });
        
        if (response.ok) {
          const data = await response.json();
          showMessage(`Added "${data.poi.name}" from ${data.poi.owner_name}`, 'success');
          closeAddSharedPOIModal();
          loadCustomPois(); // Refresh the list
        } else {
          let errorMessage = 'Failed to add shared POI';
          try {
            const error = await response.json();
            errorMessage = error.error || errorMessage;
          } catch (e) {
            // If response isn't JSON, use default error message
          }
          showMessage(errorMessage, 'error');
        }
      } catch (error) {
        showMessage('Failed to add shared POI', 'error');
      }
    }

    // Share users modal functions
    async function showShareUsersModal(poiId, poiName) {
      document.getElementById('share-users-title').textContent = `Users Sharing "${poiName}"`;
      document.getElementById('share-users-modal').style.display = 'flex';
      document.getElementById('share-users-loading').style.display = 'block';
      document.getElementById('share-users-content').style.display = 'none';
      
      try {
        const response = await fetch(`/api/custom-pois/${poiId}/shared-users`);
        if (response.ok) {
          const data = await response.json();
          const listEl = document.getElementById('share-users-list-modal');
          
          if (data.users.length > 0) {
            listEl.innerHTML = data.users.map(user => `
              <div style="padding: 1rem; border-bottom: 1px solid #333;">
                <div style="font-size: 1.1rem; color: #FFD700; margin-bottom: 0.25rem;">
                  ${window.escapeHTML(user.display_name)}
                </div>
                <div style="color: #999; font-size: 0.9rem;">
                  Added ${new Date(user.added_at).toLocaleDateString()} at ${new Date(user.added_at).toLocaleTimeString()}
                </div>
              </div>
            `).join('');
          } else {
            listEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: #999;">No users have added this POI yet.</div>';
          }
          
          document.getElementById('share-users-loading').style.display = 'none';
          document.getElementById('share-users-content').style.display = 'block';
        } else {
          showMessage('Failed to load users', 'error');
          closeShareUsersModal();
        }
      } catch (error) {
        console.error('Error loading share users:', error);
        showMessage('Failed to load users', 'error');
        closeShareUsersModal();
      }
    }

    function closeShareUsersModal() {
      document.getElementById('share-users-modal').style.display = 'none';
    }
    
    // Helper function to view shared users from the table
    function viewSharedUsers(poiId) {
      const poi = customPois.find(p => p.id === poiId);
      if (poi) {
        showShareUsersModal(poiId, poi.name);
      }
    }

    // POI Type Management Functions
    let poiTypes = [];
    let editingPOIType = null;
    let currentEmojiCategory = 'harvest';
    let currentPOITypePage = 0;
    const POI_TYPES_PER_PAGE = 10;
    
    const emojiCategories = {
      harvest: ['🪵', '🪨', '⛏️', '🔨', '⚒️', '🪓', '🛠️', '⚙️', '🔩', '⛓️', '🧱', '🪙', '🥈', '🥇', '🥉', '💎', '💍', '📿', '🔷', '🔶', '🟫', '⬜', '⬛', '🟥', '🟦', '🟩', '🟨', '🟧', '🟪', '🔳', '🔲', '◼️', '◻️', '◾', '◽', '▪️', '▫️', '🔸', '🔹', '🔺', '🔻', '🧲', '⚗️', '🧪', '🔬', '🔭', '🪚', '🪛', '🪜', '🧰', '🧯', '🪣', '🧴', '🧽', '🧹', '🧺', '🧻', '🧼', '🪒', '🪔', '🕯️', '🪩', '🪫'],
      plants: ['🌿', '🌾', '🌱', '🌲', '🌳', '🌴', '🌵', '🎋', '🎍', '🌺', '🌸', '🌼', '🌻', '🌹', '🌷', '🌺', '🥀', '🏵️', '💐', '🌿', '☘️', '🍀', '🍃', '🍂', '🍁', '🍄', '🟫', '🌰', '🫘', '🥜', '🌶️', '🫑', '🥒', '🥬', '🥦', '🧄', '🧅', '🥕', '🌽', '🥔', '🍠', '🫚', '🫛', '🌿', '🌾', '🪴', '🎍', '🪷', '🪸', '🪹', '🪺', '🥀', '🌹', '🥀', '🌺', '🌻', '🌼', '🌷', '🌸', '🪻', '🏵️', '💐', '🌿'],
      rpg: ['⚔️', '🗡️', '🏹', '🛡️', '🪃', '🏏', '⚰️', '🪦', '💀', '☠️', '🎯', '🔮', '📿', '🏺', '⚗️', '🧪', '💉', '🩸', '🧬', '🦴', '🦷', '👑', '🎩', '🎓', '🪖', '⛑️', '📯', '🎺', '🥁', '🪘', '🔔', '📜', '📃', '📄', '🗞️', '🔖', '🏷️', '💼', '🎒', '👝', '👛', '👜', '🪄', '🔱', '🪬', '🪭', '🩹', '🩺', '💊', '🧿', '🪯', '🎭', '🎪', '🎰', '🎲', '🃏', '🀄', '🎴', '🎮', '🕹️', '👾', '🎯'],
      locations: ['🏰', '🏯', '🏟️', '🗿', '🗽', '⛩️', '🕌', '🛕', '⛪', '🏛️', '🕍', '🕋', '⛺', '🏕️', '🏠', '🏡', '🏘️', '🏚️', '🏗️', '🏭', '🏢', '🏬', '🏣', '🏤', '🏥', '🏦', '🏨', '🏩', '🏪', '🏫', '⛽', '🚏', '🚥', '🚦', '🚧', '⚓', '⛵', '🚤', '🛶', '🚁', '🏖️', '🏜️', '🏝️', '🗾', '🏞️', '🌁', '🌃', '🏙️', '🌄', '🌅', '🌆', '🌇', '🌉', '🌌', '🎠', '🎡', '🎢', '💈', '🎪', '🚂', '🚃', '🚄', '🚅', '🚆', '🚇', '🚈', '🚉', '🚊', '🚝', '🚞', '🚋'],
      map: ['🗺️', '🧭', '📍', '📌', '🚩', '🏁', '🏳️', '🏴', '📐', '📏', '🔍', '🔎', '🔭', '🔬', '🗝️', '🔑', '🚪', '🪜', '🛤️', '🛣️', '🛑', '⛔', '🚫', '🚳', '🚭', '🚯', '🚱', '🚷', '📵', '🔞', '☢️', '☣️', '⬆️', '↗️', '➡️', '↘️', '⬇️', '↙️', '⬅️', '↖️', '↕️', '↔️', '↩️', '↪️', '⤴️', '⤵️', '🔄', '🔃', '🔂', '🔁', '🔀', '🔼', '🔽', '⏪', '⏩', '⏫', '⏬', '⏸️', '⏹️', '⏺️', '⏏️', '🎦', '🔅', '🔆', '📶', '📳', '📴'],
      creatures: ['🐉', '🦄', '🧙', '🧚', '🧛', '🧟', '🧞', '🧜', '🧝', '👺', '👹', '👻', '👽', '👾', '🤖', '🦇', '🦅', '🦉', '🦆', '🦢', '🦜', '🦩', '🦚', '🦃', '🐺', '🦊', '🦝', '🐻', '🐼', '🦁', '🐯', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦏', '🦛', '🦒', '🦘', '🦬', '🦣', '🦫', '🦦', '🦥', '🐁', '🐀', '🐹', '🐰', '🐇', '🐿️', '🦫', '🦡', '🦨', '🦔', '🐾'],
      weather: ['☀️', '🌤️', '⛅', '🌥️', '☁️', '🌦️', '🌧️', '⛈️', '🌩️', '🌨️', '❄️', '☃️', '⛄', '🌬️', '💨', '💧', '💦', '☔', '☂️', '🌊', '🌫️', '🌪️', '🌈', '🌅', '🌄', '🌠', '🎇', '🎆', '🌇', '🌆', '🌃', '🌌', '🌉', '🌁', '⚡', '🔥', '💥', '❄️', '🌟', '⭐', '🌙', '☄️', '🌑', '🌒', '🌓', '🌔', '🌕', '🌖', '🌗', '🌘', '🌚', '🌛', '🌜', '☁️', '⛅', '⛈️', '🌤️', '🌥️', '🌦️', '🌧️', '🌨️', '🌩️', '🌪️'],
      items: ['💰', '💵', '💴', '💶', '💷', '💸', '💳', '🪙', '⚱️', '🏺', '🕯️', '💡', '🔦', '🏮', '🪔', '📦', '🎁', '🎀', '🎗️', '🏵️', '🏅', '🥇', '🥈', '🥉', '🏆', '🎖️', '🎪', '🎭', '🎨', '🎬', '🎤', '🎧', '🎼', '🎵', '🎶', '🎹', '🥁', '🎷', '🎺', '🎸', '🎻', '🎲', '🎯', '🎳', '🎮', '🎰', '🧩', '♠️', '♥️', '♦️', '♣️', '♟️', '🃏', '🀄', '🎴', '🔇', '🔈', '🔉', '🔊', '📢', '📣', '📯', '🔔', '🔕', '🎵', '🎶', '💿', '📀'],
      food: ['🍖', '🍗', '🥩', '🥓', '🧀', '🥚', '🍞', '🥖', '🥨', '🥐', '🥯', '🧇', '🧈', '🍳', '🥘', '🍲', '🥣', '🥗', '🍿', '🧂', '🥫', '🍱', '🍘', '🍙', '🍚', '🍛', '🍜', '🍺', '🍻', '🥂', '🍷', '🥃', '🍸', '🍹', '🍾', '🍶', '🍵', '☕', '🫖', '🧃', '🧊', '🍯', '🍼', '🥛', '🫗', '🍯', '🍮', '🎂', '🍰', '🧁', '🥧', '🍦', '🍨', '🍧', '🍡', '🍢', '🍣', '🍤', '🍥', '🥮', '🍘', '🍙', '🍚', '🍛', '🍜', '🍝', '🍞', '🍟'],
      symbols: ['⭐', '🌟', '✨', '⚡', '🔥', '💥', '💫', '💢', '💯', '❗', '❓', '❕', '❔', '⁉️', '‼️', '⚠️', '🚸', '⛔', '🔱', '⚜️', '🔰', '⭕', '✅', '☑️', '✔️', '❌', '❎', '➕', '➖', '➗', '✖️', '💲', '💱', '™️', '©️', '®️', '〰️', '➰', '➿', '🔚', '🔙', '🔛', '🔝', '🔜', '🆕', '🆒', '🆓', '🆙', '🆗', '🆖', '🏧', '🚮', '🚰', '♿', '🚹', '🚺', '🚻', '🚼', '🚾', '🛂', '🛃', '🛄', '🛅', '🛐', '⚛️', '🕉️', '✡️', '☸️', '☯️', '✝️', '☦️', '☪️', '☮️']
    };
    
    // NPC Editor Functions
    let npcs = [];
    let filteredNpcs = [];
    let currentNpcPage = 0;
    const NPCS_PER_PAGE = 20;
    let npcChanges = new Map(); // Track staged changes for NPCs
    let selectedItemsForLoot = []; // For loot selection modal
    
    async function loadNPCEditor() {
      const loading = document.getElementById('npc-editor-loading');
      const content = document.getElementById('npc-editor-content');
      
      try {
        loading.style.display = 'block';
        content.style.display = 'none';
        
        const response = await window.csrfHelper.fetchWithCSRF('/api/npcs');
        if (!response.ok) throw new Error('Failed to load NPCs');
        
        npcs = await response.json();
        filteredNpcs = [...npcs];
        currentNpcPage = 0;
        
        displayNPCs();
        
        loading.style.display = 'none';
        content.style.display = 'block';
      } catch (error) {
        console.error('Error loading NPCs:', error);
        loading.innerHTML = `<p style="color: #ef4444;">Error loading NPCs: ${error.message}</p>`;
      }
    }
    
    function filterNPCsByType() {
      const filterValue = document.getElementById('npc-type-filter').value;
      const searchValue = document.getElementById('npc-search').value.toLowerCase();
      
      filteredNpcs = npcs.filter(npc => {
        const matchesType = filterValue === 'all' || npc.npc_type === filterValue;
        const matchesSearch = !searchValue || 
          npc.name.toLowerCase().includes(searchValue) ||
          (npc.description && npc.description.toLowerCase().includes(searchValue)) ||
          npc.id.toString().includes(searchValue);
        
        return matchesType && matchesSearch;
      });
      
      currentNpcPage = 0;
      displayNPCs();
    }
    
    function searchNPCs() {
      filterNPCsByType();
    }
    
    function displayNPCs() {
      const tbody = document.getElementById('npc-editor-tbody');
      if (!tbody) return; // Element not ready yet
      tbody.innerHTML = '';
      
      const totalPages = Math.ceil(filteredNpcs.length / NPCS_PER_PAGE);
      const startIndex = currentNpcPage * NPCS_PER_PAGE;
      const endIndex = Math.min(startIndex + NPCS_PER_PAGE, filteredNpcs.length);
      const pageNpcs = filteredNpcs.slice(startIndex, endIndex);
      
      // Update counts
      const totalCount = document.getElementById('npc-total-count');
      const filteredCount = document.getElementById('npc-filtered-count');
      if (totalCount) totalCount.textContent = npcs.length;
      if (filteredCount) filteredCount.textContent = filteredNpcs.length;
      
      // Update pagination info
      const paginationInfo = document.getElementById('npc-editor-pagination-info');
      if (paginationInfo) {
        if (filteredNpcs.length > 0) {
          paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredNpcs.length} NPCs`;
        } else {
          paginationInfo.textContent = 'No NPCs found';
        }
      }
      
      pageNpcs.forEach(npc => {
        const row = createNPCEditorRow(npc);
        tbody.appendChild(row);
      });
      
      // Update pagination
      displayNPCPagination();
      updateNPCChangeButtons();
    }
    
    function createNPCEditorRow(npc) {
      const row = document.createElement('tr');
      row.id = `npc-row-${npc.id}`;
      
      // Check if marked for deletion
      const change = npcChanges.get(npc.id);
      if (change && change._delete) {
        row.classList.add('marked-for-deletion');
      }
      
      // ID
      const idCell = document.createElement('td');
      idCell.textContent = npc.id;
      row.appendChild(idCell);
      
      // NPC ID
      const npcIdCell = document.createElement('td');
      npcIdCell.textContent = npc.npcid || '-';
      row.appendChild(npcIdCell);
      
      // Type
      const typeCell = document.createElement('td');
      const typeSelect = document.createElement('select');
      typeSelect.className = 'inline-edit';
      typeSelect.dataset.field = 'npc_type';
      typeSelect.dataset.original = npc.npc_type || '';
      
      const npcTypes = [
        'humanoid', 'beast', 'undead', 'elemental', 'dragon',
        'demon', 'construct', 'aberration', 'plant', 'fey'
      ];
      
      npcTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        if (type === npc.npc_type) option.selected = true;
        typeSelect.appendChild(option);
      });
      
      typeSelect.onchange = () => stageNPCChange(npc.id, 'npc_type', typeSelect.value);
      typeCell.appendChild(typeSelect);
      row.appendChild(typeCell);
      
      // Name
      const nameCell = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = npc.name || '';
      nameInput.className = 'inline-edit';
      nameInput.dataset.field = 'name';
      nameInput.dataset.original = npc.name || '';
      nameInput.onblur = () => stageNPCChange(npc.id, 'name', nameInput.value);
      nameInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          nameInput.blur();
        }
      };
      nameCell.appendChild(nameInput);
      row.appendChild(nameCell);
      
      // Description
      const descCell = document.createElement('td');
      const descTextarea = document.createElement('textarea');
      descTextarea.value = npc.description || '';
      descTextarea.className = 'inline-edit';
      descTextarea.style.minHeight = '50px';
      descTextarea.style.resize = 'vertical';
      descTextarea.dataset.field = 'description';
      descTextarea.dataset.original = npc.description || '';
      descTextarea.onblur = () => stageNPCChange(npc.id, 'description', descTextarea.value);
      descCell.appendChild(descTextarea);
      row.appendChild(descCell);
      
      // Loot
      const lootCell = document.createElement('td');
      lootCell.style.cursor = 'pointer';
      lootCell.setAttribute('data-field', 'loot');
      lootCell.setAttribute('data-original', JSON.stringify(npc.loot || []));
      lootCell.onclick = () => showLootSelector(npc.id, npc.loot || []);
      
      // Display loot items if any
      if (npc.loot_items && npc.loot_items.length > 0) {
        const lootDisplay = document.createElement('div');
        lootDisplay.style.display = 'flex';
        lootDisplay.style.flexWrap = 'wrap';
        lootDisplay.style.gap = '4px';
        
        npc.loot_items.forEach(item => {
          const itemChip = document.createElement('span');
          itemChip.style.padding = '2px 6px';
          itemChip.style.background = '#4a4a4a';
          itemChip.style.borderRadius = '3px';
          itemChip.style.fontSize = '0.8rem';
          itemChip.style.whiteSpace = 'nowrap';
          itemChip.textContent = item.name;
          itemChip.title = `ID: ${item.id}`;
          lootDisplay.appendChild(itemChip);
        });
        
        lootCell.appendChild(lootDisplay);
      } else {
        lootCell.innerHTML = '<span style="color: #666;">Click to add loot</span>';
      }
      
      row.appendChild(lootCell);
      
      // HP
      const hpCell = document.createElement('td');
      const hpInput = document.createElement('input');
      hpInput.type = 'number';
      hpInput.value = npc.hp || 0;
      hpInput.className = 'inline-edit';
      hpInput.min = '0';
      hpInput.max = '99999';
      hpInput.dataset.field = 'hp';
      hpInput.dataset.original = npc.hp || 0;
      hpInput.onblur = () => stageNPCChange(npc.id, 'hp', parseInt(hpInput.value) || 0);
      hpInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          hpInput.blur();
        }
      };
      hpCell.appendChild(hpInput);
      row.appendChild(hpCell);
      
      // MP
      const mpCell = document.createElement('td');
      const mpInput = document.createElement('input');
      mpInput.type = 'number';
      mpInput.value = npc.mp || 0;
      mpInput.className = 'inline-edit';
      mpInput.min = '0';
      mpInput.max = '99999';
      mpInput.dataset.field = 'mp';
      mpInput.dataset.original = npc.mp || 0;
      mpInput.onblur = () => stageNPCChange(npc.id, 'mp', parseInt(mpInput.value) || 0);
      mpInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          mpInput.blur();
        }
      };
      mpCell.appendChild(mpInput);
      row.appendChild(mpCell);
      
      // AC
      const acCell = document.createElement('td');
      const acInput = document.createElement('input');
      acInput.type = 'number';
      acInput.value = npc.ac || 0;
      acInput.className = 'inline-edit stat-input';
      acInput.min = '-50';
      acInput.max = '50';
      acInput.dataset.field = 'ac';
      acInput.dataset.original = npc.ac || 0;
      acInput.onblur = () => stageNPCChange(npc.id, 'ac', parseInt(acInput.value) || 0);
      acInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          acInput.blur();
        }
      };
      updateStatInputColor(acInput);
      acCell.appendChild(acInput);
      row.appendChild(acCell);
      
      // Stats (STR, STA, AGI, DEX, WIS, INT, CHA)
      ['str', 'sta', 'agi', 'dex', 'wis', 'int', 'cha'].forEach(stat => {
        const statCell = document.createElement('td');
        const statInput = document.createElement('input');
        statInput.type = 'number';
        statInput.value = npc[stat] || 0;
        statInput.className = 'inline-edit stat-input';
        statInput.min = '-999';
        statInput.max = '999';
        statInput.dataset.field = stat;
        statInput.dataset.original = npc[stat] || 0;
        statInput.onblur = () => stageNPCChange(npc.id, stat, parseInt(statInput.value) || 0);
        statInput.onkeypress = (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            statInput.blur();
          }
        };
        updateStatInputColor(statInput);
        statCell.appendChild(statInput);
        row.appendChild(statCell);
      });
      
      // Attack Speed
      const asCell = document.createElement('td');
      const asInput = document.createElement('input');
      asInput.type = 'number';
      asInput.value = npc.attack_speed || 0;
      asInput.className = 'inline-edit';
      asInput.min = '0';
      asInput.max = '99.9';
      asInput.step = '0.1';
      asInput.dataset.field = 'attack_speed';
      asInput.dataset.original = npc.attack_speed || 0;
      asInput.onblur = () => stageNPCChange(npc.id, 'attack_speed', parseFloat(asInput.value) || 0);
      asInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          asInput.blur();
        }
      };
      asCell.appendChild(asInput);
      row.appendChild(asCell);
      
      // Min Damage
      const minDmgCell = document.createElement('td');
      const minDmgInput = document.createElement('input');
      minDmgInput.type = 'number';
      minDmgInput.value = npc.min_dmg || 0;
      minDmgInput.className = 'inline-edit';
      minDmgInput.min = '0';
      minDmgInput.max = '9999';
      minDmgInput.dataset.field = 'min_dmg';
      minDmgInput.dataset.original = npc.min_dmg || 0;
      minDmgInput.onblur = () => stageNPCChange(npc.id, 'min_dmg', parseInt(minDmgInput.value) || 0);
      minDmgInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          minDmgInput.blur();
        }
      };
      minDmgCell.appendChild(minDmgInput);
      row.appendChild(minDmgCell);
      
      // Max Damage
      const maxDmgCell = document.createElement('td');
      const maxDmgInput = document.createElement('input');
      maxDmgInput.type = 'number';
      maxDmgInput.value = npc.max_dmg || 0;
      maxDmgInput.className = 'inline-edit';
      maxDmgInput.min = '0';
      maxDmgInput.max = '9999';
      maxDmgInput.dataset.field = 'max_dmg';
      maxDmgInput.dataset.original = npc.max_dmg || 0;
      maxDmgInput.onblur = () => stageNPCChange(npc.id, 'max_dmg', parseInt(maxDmgInput.value) || 0);
      maxDmgInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          maxDmgInput.blur();
        }
      };
      maxDmgCell.appendChild(maxDmgInput);
      row.appendChild(maxDmgCell);
      
      // Level
      const levelCell = document.createElement('td');
      const levelInput = document.createElement('input');
      levelInput.type = 'number';
      levelInput.value = npc.level || 1;
      levelInput.className = 'inline-edit';
      levelInput.min = '1';
      levelInput.max = '100';
      levelInput.dataset.field = 'level';
      levelInput.dataset.original = npc.level || 1;
      levelInput.onblur = () => stageNPCChange(npc.id, 'level', parseInt(levelInput.value) || 1);
      levelInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          levelInput.blur();
        }
      };
      levelCell.appendChild(levelInput);
      row.appendChild(levelCell);
      
      // Actions
      const actionsCell = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'small-btn danger-btn';
      deleteBtn.innerHTML = '🗑️ Delete';
      deleteBtn.onclick = () => markNPCForDeletion(npc.id);
      actionsCell.appendChild(deleteBtn);
      row.appendChild(actionsCell);
      
      // Apply changed cells styling
      if (change) {
        Object.keys(change).forEach(field => {
          if (field !== '_delete') {
            const input = row.querySelector(`[data-field="${field}"]`);
            if (input && input.closest('td')) {
              input.closest('td').classList.add('cell-changed');
            }
          }
        });
      }
      
      return row;
    }
    
    function stageNPCChange(npcId, field, value) {
      const npc = npcs.find(n => n.id === npcId);
      if (!npc) return;
      
      const originalValue = npc[field];
      let input = document.querySelector(`#npc-row-${npcId} [data-field="${field}"]`);
      
      // For loot field, the cell itself has the data-field attribute, not an input
      if (field === 'loot' && !input) {
        input = document.querySelector(`#npc-row-${npcId} td[data-field="loot"]`);
      }
      
      // Convert values for comparison
      let compareValue = value;
      let compareOriginal = originalValue;
      
      if (typeof originalValue === 'number') {
        compareValue = Number(value);
      } else if (field === 'loot') {
        // Special handling for loot arrays
        const origArray = Array.isArray(originalValue) ? [...originalValue].sort() : [];
        const newArray = Array.isArray(value) ? [...value].sort() : [];
        
        // Compare sorted arrays
        const arraysEqual = origArray.length === newArray.length && 
                           origArray.every((item, index) => item === newArray[index]);
        
        // If arrays are different (including empty vs non-empty), stage the change
        if (!arraysEqual) {
          compareValue = value;
          compareOriginal = null; // Force it to be seen as different
        } else {
          compareValue = compareOriginal; // Make them "equal" to skip staging
        }
      }
      
      if (!npcChanges.has(npcId)) {
        npcChanges.set(npcId, {});
      }
      
      const changes = npcChanges.get(npcId);
      
      if (compareValue !== compareOriginal) {
        // Store numeric fields as numbers
        if (typeof originalValue === 'number') {
          changes[field] = compareValue;
        } else {
          changes[field] = value;
        }
        if (input) {
          const cell = field === 'loot' ? input : input.closest('td');
          if (cell) {
            cell.classList.add('cell-changed');
          }
        }
      } else {
        delete changes[field];
        if (input) {
          const cell = field === 'loot' ? input : input.closest('td');
          if (cell) {
            cell.classList.remove('cell-changed');
          }
        }
      }
      
      // Remove from map if no changes
      if (Object.keys(changes).length === 0) {
        npcChanges.delete(npcId);
      }
      
      updateNPCChangeButtons();
    }
    
    function markNPCForDeletion(npcId) {
      const row = document.getElementById(`npc-row-${npcId}`);
      
      if (!npcChanges.has(npcId)) {
        npcChanges.set(npcId, {});
      }
      
      const changes = npcChanges.get(npcId);
      
      if (changes._delete) {
        // Unmark for deletion
        delete changes._delete;
        row.classList.remove('marked-for-deletion');
        
        // Re-enable inputs
        row.querySelectorAll('input, select, textarea').forEach(input => {
          input.disabled = false;
        });
        
        if (Object.keys(changes).length === 0) {
          npcChanges.delete(npcId);
        }
      } else {
        // Mark for deletion
        changes._delete = true;
        row.classList.add('marked-for-deletion');
        
        // Disable inputs
        row.querySelectorAll('input, select, textarea').forEach(input => {
          input.disabled = true;
        });
      }
      
      updateNPCChangeButtons();
    }
    
    function updateNPCChangeButtons() {
      const saveBtn = document.getElementById('npc-save-btn');
      const resetBtn = document.getElementById('npc-reset-btn');
      const changeCount = document.getElementById('npc-change-count');
      const pendingCount = document.getElementById('npc-pending-count');
      
      if (!saveBtn || !resetBtn || !changeCount || !pendingCount) {
        return; // Elements not ready yet
      }
      
      const totalChanges = npcChanges.size;
      
      saveBtn.disabled = totalChanges === 0;
      resetBtn.disabled = totalChanges === 0;
      changeCount.textContent = totalChanges;
      pendingCount.textContent = totalChanges;
    }
    
    async function saveNPCChanges() {
      if (npcChanges.size === 0) return;
      
      const saveBtn = document.getElementById('npc-save-btn');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<span style="margin-right: 0.5rem;">⏳</span>Saving...';
      saveBtn.disabled = true;
      
      try {
        const updates = [];
        const deletions = [];
        const creations = [];
        
        for (const [npcId, changes] of npcChanges) {
          if (changes._delete) {
            if (npcId > 0) { // Only delete if it's a real NPC
              deletions.push(npcId);
            }
          } else {
            const npc = npcs.find(n => n.id === npcId);
            if (npc) {
              if (npcId < 0) {
                // This is a new NPC
                creations.push(changes);
              } else {
                // This is an update to existing NPC
                updates.push({
                  ...npc,
                  ...changes,
                  id: npcId
                });
              }
            }
          }
        }
        
        // Process updates
        if (updates.length > 0) {
          const response = await window.csrfHelper.fetchWithCSRF('/api/npcs/batch/update', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ npcs: updates })
          });
          
          if (!response.ok) {
            throw new Error('Failed to update NPCs');
          }
        }
        
        // Process creations (new NPCs)
        if (creations.length > 0) {
          for (const newNpc of creations) {
            const response = await window.csrfHelper.fetchWithCSRF('/api/npcs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(newNpc)
            });
            
            if (!response.ok) {
              throw new Error('Failed to create NPC');
            }
          }
        }
        
        // Process deletions
        if (deletions.length > 0) {
          const response = await window.csrfHelper.fetchWithCSRF('/api/npcs/batch/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: deletions })
          });
          
          if (!response.ok) {
            throw new Error('Failed to delete NPCs');
          }
        }
        
        // Clear changes and reload
        npcChanges.clear();
        await loadNPCEditor();
        
        showMessage('NPC changes saved successfully!', 'success');
      } catch (error) {
        console.error('Error saving NPC changes:', error);
        showMessage('Error saving changes: ' + error.message, 'error');
      } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = npcChanges.size === 0;
      }
    }
    
    function resetNPCChanges() {
      if (!confirm('Are you sure you want to discard all unsaved changes?')) {
        return;
      }
      
      npcChanges.clear();
      displayNPCs();
    }
    
    async function reloadNPCEditor() {
      if (npcChanges.size > 0) {
        if (!confirm('You have unsaved changes. Are you sure you want to reload?')) {
          return;
        }
      }
      
      npcChanges.clear();
      await loadNPCEditor();
    }
    
    function displayNPCPagination() {
      const totalPages = Math.ceil(filteredNpcs.length / NPCS_PER_PAGE);
      if (totalPages <= 1) return;
      
      const paginationDiv = document.getElementById('npc-editor-pagination');
      
      if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
      }
      
      paginationDiv.style.display = 'block';
      paginationDiv.innerHTML = '';
      
      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = 'pagination-btn';
      prevBtn.textContent = 'Previous';
      prevBtn.disabled = currentNpcPage === 0;
      prevBtn.onclick = () => {
        currentNpcPage--;
        displayNPCs();
      };
      paginationDiv.appendChild(prevBtn);
      
      // Page info
      const pageInfo = document.createElement('span');
      pageInfo.className = 'pagination-info';
      pageInfo.textContent = `Page ${currentNpcPage + 1} of ${totalPages}`;
      paginationDiv.appendChild(pageInfo);
      
      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.className = 'pagination-btn';
      nextBtn.textContent = 'Next';
      nextBtn.disabled = currentNpcPage === totalPages - 1;
      nextBtn.onclick = () => {
        currentNpcPage++;
        displayNPCs();
      };
      paginationDiv.appendChild(nextBtn);
    }
    
    function showAddNPCForm() {
      // Create a new empty NPC at the top of the list
      const newNpc = {
        id: -Date.now(), // Temporary negative ID
        npc_type: 'humanoid',
        name: 'New NPC',
        description: '',
        loot: [],
        hp: 100,
        mp: 0,
        ac: 10,
        str: 10,
        sta: 10,
        agi: 10,
        dex: 10,
        wis: 10,
        int: 10,
        cha: 10,
        attack_speed: 2.0,
        min_dmg: 1,
        max_dmg: 5,
        level: 1,
        _isNew: true
      };
      
      // Add to beginning of arrays
      npcs.unshift(newNpc);
      filteredNpcs.unshift(newNpc);
      
      // Stage all fields as changes
      const changes = { ...newNpc };
      delete changes.id;
      delete changes._isNew;
      npcChanges.set(newNpc.id, changes);
      
      // Go to first page and display
      currentNpcPage = 0;
      displayNPCs();
      
      // Focus on name field
      setTimeout(() => {
        const nameInput = document.querySelector(`#npc-row-${newNpc.id} [data-field="name"]`);
        if (nameInput) {
          nameInput.select();
          nameInput.focus();
        }
      }, 100);
    }
    
    function exportNPCsToCSV() {
      const headers = ['ID', 'Type', 'Name', 'Description', 'Loot IDs', 'HP', 'MP', 'AC', 
                       'STR', 'STA', 'AGI', 'DEX', 'WIS', 'INT', 'CHA', 
                       'Attack Speed', 'Min Damage', 'Max Damage', 'Level'];
      const rows = [headers];
      
      filteredNpcs.forEach(npc => {
        rows.push([
          npc.id,
          npc.npc_type || '',
          npc.name,
          npc.description || '',
          (npc.loot || []).join(','),
          npc.hp || 0,
          npc.mp || 0,
          npc.ac || 0,
          npc.str || 0,
          npc.sta || 0,
          npc.agi || 0,
          npc.dex || 0,
          npc.wis || 0,
          npc.int || 0,
          npc.cha || 0,
          npc.attack_speed || 0,
          npc.min_dmg || 0,
          npc.max_dmg || 0,
          npc.level || 1
        ]);
      });
      
      const csv = rows.map(row => row.map(cell => {
        const value = cell.toString();
        return value.includes(',') || value.includes('"') || value.includes('\n') 
          ? `"${value.replace(/"/g, '""')}"` 
          : value;
      }).join(',')).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `npcs_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // Loot selector modal functions
    function showLootSelector(npcId, currentLoot) {
      selectedItemsForLoot = [...(currentLoot || [])];
      
      // Create modal HTML
      const modalHtml = `
        <div id="loot-selector-modal" class="modal" style="display: flex;">
          <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
              <h2>Select Loot Items</h2>
              <button class="close-btn" onclick="closeLootSelector()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 1rem;">
                <input type="text" id="loot-item-search" placeholder="Search items..." 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #555; 
                              border-radius: 4px; background: #2d2d2d; color: #e0e0e0;"
                       onkeyup="filterLootItems()">
              </div>
              <div style="display: flex; gap: 1rem; height: 400px;">
                <div style="flex: 1; overflow-y: auto; border: 1px solid #444; 
                            border-radius: 4px; padding: 1rem;">
                  <h3 style="margin-top: 0;">Available Items</h3>
                  <div id="available-items-list"></div>
                </div>
                <div style="flex: 1; overflow-y: auto; border: 1px solid #444; 
                            border-radius: 4px; padding: 1rem;">
                  <h3 style="margin-top: 0;">Selected Items (<span id="selected-count">0</span>)</h3>
                  <div id="selected-items-list"></div>
                </div>
              </div>
              <div style="margin-top: 1rem; text-align: right;">
                <button class="secondary-btn" onclick="closeLootSelector()">Cancel</button>
                <button class="primary-btn" onclick="saveLootSelection(${npcId})" 
                        style="margin-left: 0.5rem;">Save Selection</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to page
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHtml;
      document.body.appendChild(modalContainer.firstElementChild);
      
      // Load items
      loadItemsForLootSelector();
    }
    
    async function loadItemsForLootSelector() {
      try {
        const response = await window.csrfHelper.fetchWithCSRF('/api/items');
        if (!response.ok) throw new Error('Failed to load items');
        
        const items = await response.json();
        displayLootItems(items);
      } catch (error) {
        console.error('Error loading items for loot selector:', error);
      }
    }
    
    function displayLootItems(items) {
      const availableList = document.getElementById('available-items-list');
      const selectedList = document.getElementById('selected-items-list');
      const searchValue = document.getElementById('loot-item-search').value.toLowerCase();
      
      availableList.innerHTML = '';
      selectedList.innerHTML = '';
      
      // Filter items
      const filteredItems = items.filter(item => 
        !searchValue || 
        item.name.toLowerCase().includes(searchValue) ||
        item.id.toString().includes(searchValue)
      );
      
      // Display available items
      filteredItems.forEach(item => {
        const isSelected = selectedItemsForLoot.includes(item.id);
        const itemDiv = createLootItemDisplay(item, !isSelected);
        
        if (isSelected) {
          selectedList.appendChild(itemDiv);
        } else {
          availableList.appendChild(itemDiv);
        }
      });
      
      // Update count
      document.getElementById('selected-count').textContent = selectedItemsForLoot.length;
    }
    
    function createLootItemDisplay(item, canAdd) {
      const div = document.createElement('div');
      div.style.cssText = `
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: #3a3a3a;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: background 0.2s;
      `;
      
      div.onmouseover = () => div.style.background = '#444';
      div.onmouseout = () => div.style.background = '#3a3a3a';
      
      const info = document.createElement('div');
      info.innerHTML = `
        <strong>${item.name}</strong> 
        <span style="color: #999; font-size: 0.9rem;">(ID: ${item.id})</span>
      `;
      
      const button = document.createElement('button');
      button.className = canAdd ? 'small-btn primary-btn' : 'small-btn danger-btn';
      button.textContent = canAdd ? '+ Add' : '- Remove';
      button.onclick = (e) => {
        e.stopPropagation();
        toggleLootItem(item.id);
      };
      
      div.appendChild(info);
      div.appendChild(button);
      
      return div;
    }
    
    function toggleLootItem(itemId) {
      const index = selectedItemsForLoot.indexOf(itemId);
      if (index > -1) {
        selectedItemsForLoot.splice(index, 1);
      } else {
        selectedItemsForLoot.push(itemId);
      }
      
      // Reload the display
      loadItemsForLootSelector();
    }
    
    function filterLootItems() {
      loadItemsForLootSelector();
    }
    
    function closeLootSelector() {
      const modal = document.getElementById('loot-selector-modal');
      if (modal) {
        modal.remove();
      }
    }
    
    function saveLootSelection(npcId) {
      // Always pass an array, even if empty
      const lootArray = selectedItemsForLoot || [];
      stageNPCChange(npcId, 'loot', lootArray);
      
      // Update the display in the table
      const npc = npcs.find(n => n.id === npcId);
      if (npc) {
        npc.loot = lootArray;
        // Also clear loot_items to reflect empty selection
        if (lootArray.length === 0) {
          npc.loot_items = [];
        }
        displayNPCs();
      }
      
      closeLootSelector();
    }

    // Voting Tab Functions
    let currentProposals = [];
    let proposalFilters = {
      type: '',
      show: 'not-voted'  // Default to showing only proposals not voted on
    };
    let proposalsPage = 1;
    const proposalsPerPage = 2;

    async function loadVotingData() {
      // Load voting statistics
      loadVotingStats();
      
      // Load proposals
      loadProposals();
    }

    async function loadVotingStats() {
      try {
        const response = await fetch('/api/change-proposals');
        if (response.ok) {
          const proposals = await response.json();
          
          // Calculate stats
          const myProposals = proposals.filter(p => p.proposer_id === currentUser.id);
          document.getElementById('my-proposals-count').textContent = myProposals.length;
          
          // Calculate stats for each proposal type
          const proposalTypes = ['add_poi', 'edit_poi', 'move_poi', 'delete_poi', 
                                'add_npc', 'edit_npc', 'change_loot', 
                                'add_item', 'edit_item'];
          
          proposalTypes.forEach(type => {
            const typeProposals = proposals.filter(p => p.change_type === type);
            const unvotedTypeProposals = typeProposals.filter(p => !p.user_vote || p.user_vote === 0);
            
            const totalElement = document.getElementById(`${type.replace('_', '-')}-total`);
            const pendingElement = document.getElementById(`${type.replace('_', '-')}-pending`);
            
            if (totalElement) totalElement.textContent = typeProposals.length;
            
            if (pendingElement) {
              const pendingCount = unvotedTypeProposals.length;
              if (pendingCount === 0) {
                pendingElement.textContent = 'All voted!';
                pendingElement.classList.add('none');
              } else {
                pendingElement.textContent = `${pendingCount} pending vote!`;
                pendingElement.classList.remove('none');
              }
            }
          });
        }
      } catch (error) {
        console.error('Error loading voting stats:', error);
      }
    }

    function refreshProposals() {
      // Reset page to 1 when refreshing
      proposalsPage = 1;
      loadProposals();
    }
    
    function resetProposalFilters() {
      // Reset filters to default values
      document.getElementById('proposal-type-filter').value = '';
      document.getElementById('proposal-filter').value = 'not-voted';
      
      // Update the filter state
      proposalFilters.type = '';
      proposalFilters.show = 'not-voted';
      
      // Clear active card states
      clearActiveCards();
      
      // Reset page and reload
      proposalsPage = 1;
      loadProposals();
    }
    
    function filterByCard(filterType) {
      // Clear active states
      clearActiveCards();
      
      // Set the clicked card as active
      const clickedCard = document.querySelector(`[data-filter-type="${filterType}"]`);
      if (clickedCard) {
        clickedCard.classList.add('active');
      }
      
      if (filterType === 'mine') {
        // For "My Proposals", set show filter to "mine" and clear type filter
        document.getElementById('proposal-filter').value = 'mine';
        document.getElementById('proposal-type-filter').value = '';
        proposalFilters.show = 'mine';
        proposalFilters.type = '';
      } else {
        // For type-specific cards, check if there are pending votes
        const pendingElement = document.getElementById(`${filterType.replace('_', '-')}-pending`);
        const hasPendingVotes = pendingElement && !pendingElement.classList.contains('none');
        
        // Set type filter
        document.getElementById('proposal-type-filter').value = filterType;
        proposalFilters.type = filterType;
        
        // If there are pending votes, show only unvoted proposals
        // If no pending votes, show all proposals of that type
        if (hasPendingVotes) {
          document.getElementById('proposal-filter').value = 'not-voted';
          proposalFilters.show = 'not-voted';
        } else {
          document.getElementById('proposal-filter').value = 'all';
          proposalFilters.show = 'all';
        }
      }
      
      // Reset page and reload
      proposalsPage = 1;
      loadProposals();
    }
    
    function clearActiveCards() {
      document.querySelectorAll('.voting-stat-card').forEach(card => {
        card.classList.remove('active');
      });
    }

    async function loadProposals() {
      const loading = document.getElementById('proposals-loading');
      const container = document.getElementById('proposals-container');
      
      loading.style.display = 'block';
      container.style.display = 'none';
      
      try {
        const response = await fetch('/api/change-proposals');
        if (response.ok) {
          const proposals = await response.json();
          currentProposals = proposals;
          
          // Apply filters
          let filtered = proposals;
          
          if (proposalFilters.type) {
            filtered = filtered.filter(p => p.change_type === proposalFilters.type);
          }
          
          if (proposalFilters.show === 'mine') {
            filtered = filtered.filter(p => p.proposer_id === currentUser.id);
          } else if (proposalFilters.show === 'not-voted') {
            // Only show proposals the user hasn't voted on
            filtered = filtered.filter(p => !p.user_vote || p.user_vote === 0);
          }
          
          // Pagination
          const totalPages = Math.ceil(filtered.length / proposalsPerPage);
          const start = (proposalsPage - 1) * proposalsPerPage;
          const paginated = filtered.slice(start, start + proposalsPerPage);
          
          displayProposals(paginated);
          updateProposalsPagination(totalPages);
          
          // Update voting tab with pending count
          updateVotingTabCount(proposals.length);
          
          loading.style.display = 'none';
          container.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading proposals:', error);
        loading.innerHTML = '<p style="color: #f44336;">Failed to load proposals</p>';
      }
    }

    function displayProposals(proposals) {
      const list = document.getElementById('proposals-list');
      
      if (proposals.length === 0) {
        // Check if "Not Voted" filter is active
        const filterValue = document.getElementById('proposal-filter')?.value;
        let message = 'No proposals found';
        
        if (filterValue === 'not-voted') {
          message = 'There are no more proposals left to vote on! Good Work!';
        }
        
        list.innerHTML = `<div style="text-align: center; padding: 3rem; color: #999;">${message}</div>`;
        return;
      }
      
      list.innerHTML = proposals.map(proposal => {
        const isOwner = proposal.proposer_id === currentUser.id;
        const voteClass = proposal.user_vote === 1 ? 'upvote active' : 
                         proposal.user_vote === -1 ? 'downvote active' : '';
        
        return `
          <div class="proposal-card">
            <div class="proposal-header">
              <div>
                <div class="proposal-title">${getProposalTitle(proposal)}</div>
                <div class="proposal-meta">
                  <span>by ${proposal.proposer_name}</span>
                  <span>•</span>
                  <span>${formatDate(proposal.created_at)}</span>
                  <span>•</span>
                  <span style="color: #888;">ID: ${proposal.id}</span>
                </div>
              </div>
              <span class="proposal-type">${formatChangeType(proposal.change_type)}</span>
            </div>
            
            <div class="proposal-content">
              ${getProposalDescription(proposal)}
            </div>
            
            <div class="proposal-voting">
              <div class="vote-buttons">
                <button class="vote-btn upvote ${proposal.user_vote === 1 || isOwner ? 'active' : ''}" 
                        onclick="voteProposal(${proposal.id}, 1)"
                        ${isOwner ? 'disabled title="Cannot vote on your own proposal"' : ''}>
                  👍 ${proposal.upvotes || 0}
                </button>
                <button class="vote-btn downvote ${proposal.user_vote === -1 ? 'active' : ''}" 
                        onclick="voteProposal(${proposal.id}, -1)"
                        ${isOwner && proposal.user_vote !== -1 ? '' : isOwner ? 'title="Click to withdraw proposal"' : ''}>
                  👎 ${proposal.downvotes || 0}
                </button>
              </div>
              
              <div class="vote-score ${proposal.vote_score >= 0 ? 'positive' : 'negative'}">
                Score: ${proposal.vote_score >= 0 ? '+' : ''}${proposal.vote_score}
              </div>
              
              ${proposal.vote_score >= 10 ? '<span class="proposal-status approved">Auto-Approval Pending</span>' : ''}
              
              <div class="proposal-actions">
                ${['add_poi', 'edit_poi', 'move_poi', 'delete_poi', 'change_loot', 'add_npc', 'edit_npc'].includes(proposal.change_type) ? 
                  `<button class="small-btn info-btn" onclick="viewProposalPOI(${proposal.id})">View on Map</button>` : ''}
                ${isOwner && proposal.status === 'pending' ? 
                  `<button class="small-btn danger-btn" onclick="deleteProposal(${proposal.id})">Delete</button>` : ''}
                ${currentUser.is_admin ? 
                  `<button class="small-btn admin-btn" onclick="showAdminProposalModal(${proposal.id})">Admin Review</button>` : ''}
              </div>
            </div>
            
            ${renderVoteStatusBar(proposal)}
          </div>
        `;
      }).join('');
    }

    function renderVoteStatusBar(proposal) {
      const voteScore = proposal.vote_score || 0;
      const upvotes = proposal.upvotes || 0;
      const downvotes = proposal.downvotes || 0;
      const totalVotes = upvotes + downvotes;
      
      // Calculate percentage (0-100) for bar width
      // Score ranges from -10 to 10, so we map it to 0-100%
      const percentage = Math.min(100, Math.abs(voteScore) * 10);
      
      // Check if near threshold
      const nearThreshold = Math.abs(voteScore) >= 8;
      
      // Determine status
      let status = 'pending';
      let statusText = 'Pending';
      if (voteScore >= 10) {
        status = 'pass';
        statusText = 'Auto-Approval';
      } else if (voteScore <= -10) {
        status = 'fail';
        statusText = 'Auto-Rejection';
      }
      
      return `
        <div class="vote-status-bar">
          <div class="vote-bar-labels">
            <span class="label-left">← Rejected</span>
            <span class="label-center">Community Vote</span>
            <span class="label-right">Approved →</span>
          </div>
          <div class="vote-bar-container">
            <div class="vote-bar-track">
              <div class="vote-bar-left"></div>
              <div class="vote-bar-right"></div>
            </div>
            ${voteScore !== 0 ? `
              <div class="vote-bar-fill ${voteScore > 0 ? 'positive' : 'negative'} ${nearThreshold ? 'near-threshold' : ''}" 
                   style="${voteScore > 0 ? 'left: 50%' : 'right: 50%'}; width: ${percentage / 2}%"></div>
            ` : ''}
            <div class="vote-bar-markers">
              <span class="vote-bar-marker left">-10</span>
              <span class="vote-bar-marker center">0</span>
              <span class="vote-bar-marker right">+10</span>
            </div>
          </div>
          <div class="vote-status-text">
            <span class="vote-score ${voteScore > 0 ? 'positive' : voteScore < 0 ? 'negative' : 'neutral'}">
              Vote Score: ${voteScore >= 0 ? '+' : ''}${voteScore}
            </span>
          </div>
        </div>
      `;
    }
    
    function getProposalTitle(proposal) {
      const data = proposal.proposed_data;
      switch (proposal.change_type) {
        case 'add_poi':
          return `New POI: ${data.name}`;
        case 'edit_poi':
          return `Edit POI: ${proposal.current_data?.name || 'POI #' + proposal.target_id}`;
        case 'move_poi':
          return `Move POI: ${data.name || 'POI #' + data.poi_id}`;
        case 'add_npc':
          return `New NPC: ${data.name}`;
        case 'edit_npc':
          return `Edit NPC: ${data.name || 'NPC #' + data.npc_id}`;
        case 'add_item':
          return `New Item: ${data.name}`;
        case 'edit_item':
          return `Edit Item: ${data.name || 'Item #' + data.item_id}`;
        case 'delete_poi':
          return `Delete POI: ${proposal.current_data?.name || 'POI #' + proposal.target_id}`;
        case 'change_loot':
          const npcName = proposal.current_data?.npc_name || 'Unknown NPC';
          return `Change NPC Loot (${npcName})`;
        default:
          return 'Change Proposal';
      }
    }

    function getProposalDescription(proposal) {
      const data = proposal.proposed_data;
      const current = proposal.current_data;
      let desc = '';
      
      // Debug log for edit_poi proposals
      if (proposal.change_type === 'edit_poi') {
        console.log('Edit POI Proposal Debug:', {
          id: proposal.id,
          map_name: proposal.map_name,
          current_type_name: proposal.current_type_name,
          type_name: proposal.type_name,
          current_data: current,
          proposed_data: data
        });
      }
      
      if (proposal.notes) {
        desc += `<p style="color: #ccc; margin-bottom: 0.5rem;">${proposal.notes}</p>`;
      }
      
      switch (proposal.change_type) {
        case 'add_poi':
          desc += `<div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem;">`;
          desc += `<p><strong>Map:</strong> ${proposal.map_name || data.map_name || `Map ${data.map_id}`}</p>`;
          desc += `<p><strong>Location:</strong> ${data.x}, ${data.y}</p>`;
          if (proposal.type_name || data.type_name) {
            let typeIcon = '';
            if (proposal.type_icon_type === 'emoji' && proposal.type_icon_value) {
              typeIcon = `<span style="font-size: 1.2em; margin-right: 0.25rem;">${proposal.type_icon_value}</span>`;
            } else if (proposal.type_icon_type === 'iconify' && proposal.type_icon_value) {
              typeIcon = `<iconify-icon icon="${proposal.type_icon_value}" width="20" style="vertical-align: middle; margin-right: 0.25rem;"></iconify-icon>`;
            }
            desc += `<p><strong>Type:</strong> ${typeIcon}${proposal.type_name || data.type_name}</p>`;
          }
          if (proposal.npc_name || data.npc_name) desc += `<p><strong>NPC:</strong> ${proposal.npc_name || data.npc_name}</p>`;
          if (proposal.item_name || data.item_name) desc += `<p><strong>Item:</strong> ${proposal.item_name || data.item_name}</p>`;
          desc += `</div>`;
          if (data.description) desc += `<p><strong>Description:</strong> ${data.description}</p>`;
          break;
          
        case 'edit_poi':
          // Show map name for context
          if (proposal.map_name) {
            desc += `<p style="margin-bottom: 1rem;"><strong>Zone:</strong> ${proposal.map_name}</p>`;
          }
          desc += `<div class="proposal-diff-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">`;
          desc += `<div style="background: rgba(255,0,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b;">Current</h4>`;
          
          // Only show fields that are being changed
          if (data.name !== undefined && data.name !== current?.name) {
            desc += `<p><strong>Name:</strong> ${current?.name || 'None'}</p>`;
          }
          if (data.description !== undefined && data.description !== current?.description) {
            desc += `<p><strong>Description:</strong> ${current?.description || 'None'}</p>`;
          }
          if (data.type_id !== undefined && data.type_id !== current?.type_id) {
            const currentTypeName = proposal.current_type_name || 
                                   (current?.type_id ? 'Type #' + current.type_id : 'None');
            desc += `<p><strong>Type:</strong> ${currentTypeName}</p>`;
          }
          if (data.npc_id !== undefined && data.npc_id !== current?.npc_id) {
            const currentNPC = current?.npc_id ? 
                              (proposal.current_npc_name || 'NPC #' + current.npc_id) : 
                              'None';
            desc += `<p><strong>NPC:</strong> ${currentNPC}</p>`;
          }
          if (data.item_id !== undefined && data.item_id !== current?.item_id) {
            const currentItem = current?.item_id ? 
                               (proposal.current_item_name || 'Item #' + current.item_id) : 
                               'None';
            desc += `<p><strong>Item:</strong> ${currentItem}</p>`;
          }
          
          desc += `</div>`;
          desc += `<div style="background: rgba(0,255,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #51cf66;">Proposed</h4>`;
          
          // Show the proposed values for the same fields
          if (data.name !== undefined && data.name !== current?.name) {
            desc += `<p><strong>Name:</strong> ${data.name}</p>`;
          }
          if (data.description !== undefined && data.description !== current?.description) {
            desc += `<p><strong>Description:</strong> ${data.description || 'None'}</p>`;
          }
          if (data.type_id !== undefined && data.type_id !== current?.type_id) {
            desc += `<p><strong>Type:</strong> ${proposal.type_name || 'Type #' + data.type_id}</p>`;
          }
          if (data.npc_id !== undefined && data.npc_id !== current?.npc_id) {
            desc += `<p><strong>NPC:</strong> ${data.npc_id ? (proposal.npc_name || 'NPC #' + data.npc_id) : 'None'}</p>`;
          }
          if (data.item_id !== undefined && data.item_id !== current?.item_id) {
            desc += `<p><strong>Item:</strong> ${data.item_id ? (proposal.item_name || 'Item #' + data.item_id) : 'None'}</p>`;
          }
          
          desc += `</div>`;
          desc += `</div>`;
          break;
          
        case 'move_poi':
          desc += `<div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem;">`;
          desc += `<p><strong>POI:</strong> ${data.name || 'Unnamed POI'}</p>`;
          desc += `<p><strong>Map:</strong> ${proposal.map_name || `Map ${data.map_id}`}</p>`;
          if (proposal.type_name) {
            let typeIcon = '';
            if (proposal.type_icon_type === 'emoji' && proposal.type_icon_value) {
              typeIcon = `<span style="font-size: 1.2em; margin-right: 0.25rem;">${proposal.type_icon_value}</span>`;
            } else if (proposal.type_icon_type === 'iconify' && proposal.type_icon_value) {
              typeIcon = `<iconify-icon icon="${proposal.type_icon_value}" width="20" style="vertical-align: middle; margin-right: 0.25rem;"></iconify-icon>`;
            }
            desc += `<p><strong>Type:</strong> ${typeIcon}${proposal.type_name}</p>`;
          }
          desc += `</div>`;
          desc += `<div class="proposal-diff-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">`;
          desc += `<div style="background: rgba(255,0,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b;">Current Location</h4>`;
          desc += `<p><strong>X:</strong> ${current.x}, <strong>Y:</strong> ${current.y}</p>`;
          desc += `</div>`;
          desc += `<div style="background: rgba(0,255,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #51cf66;">Proposed Location</h4>`;
          desc += `<p><strong>X:</strong> ${data.x}, <strong>Y:</strong> ${data.y}</p>`;
          desc += `</div>`;
          desc += `</div>`;
          break;
          
        case 'delete_poi':
          // Debug log for delete_poi
          console.log('Delete POI proposal data:', {
            proposal,
            current,
            type_name: proposal.type_name,
            type_id: current?.type_id,
            type_icon_type: proposal.type_icon_type,
            type_icon_value: proposal.type_icon_value
          });
          
          desc += `<div style="background: rgba(255,0,0,0.15); padding: 1rem; border-radius: 8px; border: 2px solid rgba(255,0,0,0.3);">`;
          desc += `<div style="display: flex; align-items: center; margin-bottom: 1rem;">`;
          desc += `<span style="font-size: 2rem; margin-right: 0.5rem;">⚠️</span>`;
          desc += `<h3 style="margin: 0; color: #ff6b6b;">This POI will be permanently deleted</h3>`;
          desc += `</div>`;
          
          desc += `<div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<p><strong>POI Name:</strong> ${current?.name || 'Unnamed POI'}</p>`;
          desc += `<p><strong>Zone:</strong> ${proposal.map_name || 'Unknown'}</p>`;
          
          if (proposal.type_name || current?.type_id) {
            let typeIcon = '';
            if (proposal.type_icon_type === 'emoji' && proposal.type_icon_value) {
              typeIcon = `<span style="font-size: 1.2em; margin-right: 0.25rem;">${proposal.type_icon_value}</span>`;
            } else if (proposal.type_icon_type === 'iconify' && proposal.type_icon_value) {
              typeIcon = `<iconify-icon icon="${proposal.type_icon_value}" width="20" style="vertical-align: middle; margin-right: 0.25rem;"></iconify-icon>`;
            }
            desc += `<p><strong>Type:</strong> ${typeIcon}${proposal.type_name || proposal.current_type_name || current?.type_name || 'Type #' + (current?.type_id || 'Unknown')}</p>`;
          }
          
          if (proposal.poi_x !== null && proposal.poi_y !== null) {
            desc += `<p><strong>Location:</strong> ${proposal.poi_x}, ${proposal.poi_y}</p>`;
          }
          
          if (current?.description) {
            desc += `<p><strong>Description:</strong> ${current.description}</p>`;
          }
          
          if (proposal.npc_name || current?.npc_id) {
            desc += `<p><strong>Associated NPC:</strong> ${proposal.npc_name || 'NPC #' + current.npc_id}</p>`;
          }
          
          if (proposal.item_name || current?.item_id) {
            desc += `<p><strong>Associated Item:</strong> ${proposal.item_name || 'Item #' + current.item_id}</p>`;
          }
          
          desc += `</div>`;
          desc += `</div>`;
          break;
          
        case 'add_npc':
          desc += `<div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem;">`;
          
          // Show NPC icon based on type (Combat NPC = 💀, Quest NPC = ❓)
          const npcIcon = data.npc_type === 'Combat NPC' ? '💀' : '❓';
          desc += `<p style="display: flex; align-items: center;">`;
          desc += `<span style="font-size: 2em; margin-right: 0.5rem;">${npcIcon}</span>`;
          desc += `<strong>${data.name}</strong>`;
          desc += `</p>`;
          
          desc += `<p><strong>Type:</strong> ${data.npc_type || 'NPC'}</p>`;
          desc += `<p><strong>Level:</strong> ${data.level} • <strong>HP:</strong> ${data.hp} • <strong>AC:</strong> ${data.ac}</p>`;
          
          // Show damage if specified
          if (data.min_dmg || data.max_dmg) {
            desc += `<p><strong>Damage:</strong> ${data.min_dmg || 0}-${data.max_dmg || 0}</p>`;
          }
          
          // Show stats if any are non-zero
          const npcStats = [];
          if (data.str && data.str !== 10) npcStats.push(`STR: ${data.str}`);
          if (data.sta && data.sta !== 10) npcStats.push(`STA: ${data.sta}`);
          if (data.agi && data.agi !== 10) npcStats.push(`AGI: ${data.agi}`);
          if (data.dex && data.dex !== 10) npcStats.push(`DEX: ${data.dex}`);
          if (data.wis && data.wis !== 10) npcStats.push(`WIS: ${data.wis}`);
          if (data.int && data.int !== 10) npcStats.push(`INT: ${data.int}`);
          if (data.cha && data.cha !== 10) npcStats.push(`CHA: ${data.cha}`);
          
          if (npcStats.length > 0) {
            desc += `<p><strong>Stats:</strong> ${npcStats.join(', ')}</p>`;
          }
          
          desc += `</div>`;
          
          if (data.description) desc += `<p><strong>Description:</strong> ${data.description}</p>`;
          break;
          
        case 'add_item':
          desc += `<div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem;">`;
          
          // Show item icon if available
          if (data.icon_value) {
            let iconHtml = '';
            if (data.icon_type === 'emoji') {
              iconHtml = `<span style="font-size: 2em; margin-right: 0.5rem;">${data.icon_value}</span>`;
            } else if (data.icon_type === 'iconify') {
              iconHtml = `<iconify-icon icon="${data.icon_value}" width="32" style="vertical-align: middle; margin-right: 0.5rem;"></iconify-icon>`;
            }
            if (iconHtml) {
              desc += `<p style="display: flex; align-items: center;">${iconHtml}<strong>${data.name}</strong></p>`;
            }
          }
          
          if (data.item_type) desc += `<p><strong>Type:</strong> ${data.item_type}</p>`;
          if (data.slot) desc += `<p><strong>Slot:</strong> ${data.slot}</p>`;
          
          // Show stats if any are non-zero
          const stats = [];
          if (data.str) stats.push(`STR: ${data.str}`);
          if (data.sta) stats.push(`STA: ${data.sta}`);
          if (data.agi) stats.push(`AGI: ${data.agi}`);
          if (data.dex) stats.push(`DEX: ${data.dex}`);
          if (data.wis) stats.push(`WIS: ${data.wis}`);
          if (data.int) stats.push(`INT: ${data.int}`);
          if (data.cha) stats.push(`CHA: ${data.cha}`);
          
          if (stats.length > 0) {
            desc += `<p><strong>Stats:</strong> ${stats.join(', ')}</p>`;
          }
          
          // Show other modifiers
          const mods = [];
          if (data.ac) mods.push(`AC: ${data.ac}`);
          if (data.health) mods.push(`Health: +${data.health}`);
          if (data.mana) mods.push(`Mana: +${data.mana}`);
          if (data.attack_speed) mods.push(`Attack Speed: ${data.attack_speed}`);
          
          if (mods.length > 0) {
            desc += `<p><strong>Modifiers:</strong> ${mods.join(', ')}</p>`;
          }
          desc += `</div>`;
          
          if (data.description) desc += `<p><strong>Description:</strong> ${data.description}</p>`;
          break;
          
        case 'edit_item':
          // Show item name and info at the top
          desc += `<div style="margin-bottom: 1rem; padding: 0.5rem; background: rgba(255,215,0,0.1); border-radius: 4px;">`;
          desc += `<p style="margin: 0;"><strong>Item:</strong> ${data.name || 'Unknown'}</p>`;
          if (data.item_type) desc += `<p style="margin: 0.25rem 0 0 0;"><strong>Type:</strong> ${data.item_type}</p>`;
          if (data.slot) desc += `<p style="margin: 0.25rem 0 0 0;"><strong>Slot:</strong> ${data.slot}</p>`;
          desc += `</div>`;
          
          // Create comparison grid for changed fields
          desc += `<div class="proposal-diff-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">`;
          desc += `<div style="background: rgba(255,0,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b;">Current</h4>`;
          
          // Show all fields that could be changed
          const itemFields = {
            'name': 'Name',
            'description': 'Description',
            'item_type': 'Type',
            'slot': 'Slot',
            'str': 'STR',
            'sta': 'STA',
            'agi': 'AGI',
            'dex': 'DEX',
            'wis': 'WIS',
            'int': 'INT',
            'cha': 'CHA',
            'ac': 'AC',
            'health': 'HP',
            'mana': 'MP',
            'attack_speed': 'Attack Speed'
          };
          
          for (const [field, label] of Object.entries(itemFields)) {
            if (current && current[field] !== undefined && current[field] !== data[field]) {
              desc += `<div style="margin: 0.25rem 0;"><strong>${label}:</strong> ${current[field] || 'None'}</div>`;
            }
          }
          
          desc += `</div>`;
          desc += `<div style="background: rgba(0,255,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #51cf66;">Proposed</h4>`;
          
          for (const [field, label] of Object.entries(itemFields)) {
            if (current && current[field] !== undefined && current[field] !== data[field]) {
              desc += `<div style="margin: 0.25rem 0;"><strong>${label}:</strong> ${data[field] || 'None'}</div>`;
            }
          }
          
          desc += `</div>`;
          desc += `</div>`;
          break;
          
        case 'edit_npc':
          // Show NPC name and info at the top
          desc += `<div style="margin-bottom: 1rem; padding: 0.5rem; background: rgba(139,69,19,0.1); border-radius: 4px;">`;
          desc += `<p style="margin: 0;"><strong>NPC:</strong> ${data.name || 'Unknown'}</p>`;
          if (data.npc_type) desc += `<p style="margin: 0.25rem 0 0 0;"><strong>Type:</strong> ${data.npc_type}</p>`;
          desc += `</div>`;
          
          // Create comparison grid for changed stats
          desc += `<div class="proposal-diff-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">`;
          desc += `<div style="background: rgba(255,0,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b;">Current</h4>`;
          
          // Show only changed fields
          const npcStatFields = {
            'level': 'Level',
            'hp': 'HP',
            'mp': 'MP',
            'ac': 'AC',
            'str': 'STR',
            'sta': 'STA',
            'agi': 'AGI',
            'dex': 'DEX',
            'wis': 'WIS',
            'int': 'INT',
            'cha': 'CHA',
            'min_dmg': 'Min Damage',
            'max_dmg': 'Max Damage',
            'attack_speed': 'Attack Speed'
          };
          
          Object.keys(npcStatFields).forEach(field => {
            if (current[field] !== undefined) {
              desc += `<p style="margin: 0.25rem 0;"><strong>${npcStatFields[field]}:</strong> ${current[field]}</p>`;
            }
          });
          
          desc += `</div>`;
          desc += `<div style="background: rgba(0,255,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #51cf66;">Proposed</h4>`;
          
          Object.keys(npcStatFields).forEach(field => {
            if (current[field] !== undefined) {
              const changed = data[field] !== current[field];
              desc += `<p style="margin: 0.25rem 0; ${changed ? 'font-weight: bold;' : ''}">`;
              desc += `<strong>${npcStatFields[field]}:</strong> ${data[field] !== undefined ? data[field] : current[field]}`;
              desc += `</p>`;
            }
          });
          
          desc += `</div>`;
          desc += `</div>`;
          break;
          
        case 'edit_item':
          desc += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">`;
          desc += `<div style="background: rgba(255,0,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b;">Current</h4>`;
          desc += `<pre style="font-size: 0.8rem; overflow-x: auto;">${JSON.stringify(current, null, 2)}</pre>`;
          desc += `</div>`;
          desc += `<div style="background: rgba(0,255,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #51cf66;">Proposed</h4>`;
          desc += `<pre style="font-size: 0.8rem; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>`;
          desc += `</div>`;
          desc += `</div>`;
          break;
          
        case 'change_loot':
          // Show zone, POI and NPC info at the top
          desc += `<div style="margin-bottom: 1rem; padding: 0.5rem; background: rgba(139,69,19,0.1); border-radius: 4px;">`;
          desc += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
          desc += `<div>`;
          desc += `<span style="margin-right: 1rem;"><strong>Zone:</strong> ${current.map_name || 'Unknown Zone'}</span>`;
          desc += `<span style="margin-right: 1rem;"><strong>POI:</strong> ${current.poi_name || 'Unknown POI'}</span>`;
          desc += `<span><strong>NPC:</strong> ${current.npc_name || 'Unknown NPC'}</span>`;
          desc += `</div>`;
          desc += `</div>`;
          desc += `</div>`;
          
          // Red/Green comparison grid
          desc += `<div class="proposal-diff-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">`;
          
          // Current loot (left side - red)
          desc += `<div style="background: rgba(255,0,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #ff6b6b;">Current Loot</h4>`;
          if (current.existing_loot && current.existing_loot.length > 0) {
            desc += `<ul style="margin: 0; padding-left: 1.5rem;">`;
            current.existing_loot.forEach(item => {
              desc += `<li style="margin-bottom: 0.5rem;">`;
              desc += `<strong>${item.item_name}</strong>`;
              desc += `</li>`;
            });
            desc += `</ul>`;
          } else {
            desc += `<p style="margin: 0; color: #888;">No current loot items</p>`;
          }
          desc += `</div>`;
          
          // Proposed loot (right side - green)
          desc += `<div style="background: rgba(0,255,0,0.1); padding: 0.75rem; border-radius: 4px;">`;
          desc += `<h4 style="margin: 0 0 0.5rem 0; color: #51cf66;">Proposed Loot</h4>`;
          
          // Create a map of current items for easy lookup
          const currentItemMap = new Map();
          if (current.existing_loot && current.existing_loot.length > 0) {
            current.existing_loot.forEach(item => {
              currentItemMap.set(item.item_id, item);
            });
          }
          
          // Create a map of proposed items
          const proposedItemMap = new Map();
          if (data.loot_items && data.loot_items.length > 0) {
            data.loot_items.forEach(item => {
              proposedItemMap.set(item.item_id, item);
            });
          }
          
          // Build the final list showing all items with their status
          const allItems = [];
          
          // Add all current items, marking which ones are removed
          currentItemMap.forEach((item, itemId) => {
            if (!proposedItemMap.has(itemId)) {
              // Item is being removed
              allItems.push({ ...item, status: 'removed' });
            } else {
              // Item is kept
              const proposedItem = proposedItemMap.get(itemId);
              allItems.push({ ...proposedItem, status: 'kept' });
            }
          });
          
          // Add new items
          proposedItemMap.forEach((item, itemId) => {
            if (!currentItemMap.has(itemId)) {
              allItems.push({ ...item, status: 'added' });
            }
          });
          
          if (allItems.length > 0) {
            desc += `<ul style="margin: 0; padding-left: 1.5rem;">`;
            allItems.forEach(item => {
              desc += `<li style="margin-bottom: 0.5rem;">`;
              
              // Add status indicator
              if (item.status === 'added') {
                desc += `<span style="color: #51cf66; font-weight: bold;">+ </span>`;
              } else if (item.status === 'removed') {
                desc += `<span style="color: #ff6b6b; font-weight: bold;">- </span>`;
                desc += `<span style="text-decoration: line-through; opacity: 0.7;">`;
              }
              
              desc += `<strong>${item.item_name}</strong>`;
              
              if (item.status === 'removed') {
                desc += `</span>`; // Close strikethrough span
              }
              
              desc += `</li>`;
            });
            desc += `</ul>`;
          } else {
            desc += `<p style="margin: 0; color: #888;">No items</p>`;
          }
          desc += `</div>`;
          desc += `</div>`;
          break;
      }
      
      return desc;
    }

    function formatChangeType(type) {
      const types = {
        'add_poi': 'New POI',
        'edit_poi': 'Edit POI',
        'move_poi': 'Move POI',
        'delete_poi': 'Delete POI',
        'add_npc': 'New NPC',
        'edit_npc': 'Edit NPC',
        'add_item': 'New Item',
        'edit_item': 'Edit Item',
        'change_loot': 'Change Loot'
      };
      return types[type] || type;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
      if (diffMins < 10080) return `${Math.floor(diffMins / 1440)}d ago`;
      
      return date.toLocaleDateString();
    }

    async function voteProposal(proposalId, vote) {
      try {
        // Check if this is the proposer trying to downvote their own proposal
        const proposal = currentProposals.find(p => p.id === proposalId);
        if (proposal && proposal.proposer_id === currentUser.id && vote === -1) {
          showConfirmDialog(
            'Are you sure you want to withdraw your proposal? This action cannot be undone.',
            async () => {
              // Proceed with the vote
              await performVote(proposalId, vote);
            }
          );
          return;
        }
        
        // Normal vote - proceed directly
        await performVote(proposalId, vote);
      } catch (error) {
        console.error('Error voting:', error);
        showMessage('Failed to vote', 'error');
      }
    }
    
    async function performVote(proposalId, vote) {
      const response = await window.csrfHelper.fetchWithCSRF(`/api/change-proposals/${proposalId}/vote`, {
        method: 'POST',
        body: { vote }
      });
      
      if (response.ok) {
        const result = await response.json();
        
        if (result.withdrawn) {
          showMessage('Proposal withdrawn', 'info');
        } else if (result.approved) {
          showMessage('Proposal approved!', 'success');
        } else if (result.rejected) {
          showMessage('Proposal rejected', 'info');
        }
        
        // Reload proposals and update count
        loadProposals();
        loadVotingStats();
        loadInitialProposalCount();
      } else {
        const error = await response.json();
        showMessage(error.error || 'Failed to vote', 'error');
      }
    }

    async function deleteProposal(proposalId) {
      if (!confirm('Are you sure you want to delete this proposal?')) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/change-proposals/${proposalId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showMessage('Proposal deleted', 'success');
          loadProposals();
          loadVotingStats();
          loadInitialProposalCount();
          
          // Mark that the main map page should refresh POI data
          sessionStorage.setItem('refresh_pois', 'true');
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to delete proposal', 'error');
        }
      } catch (error) {
        console.error('Error deleting proposal:', error);
        showMessage('Failed to delete proposal', 'error');
      }
    }

    // Function to view a POI proposal on the map temporarily
    function viewProposalPOI(proposalId) {
      const proposal = currentProposals.find(p => p.id === proposalId);
      if (!proposal) return;
      
      console.log('Full proposal object:', proposal);
      console.log('Proposal change_type:', proposal.change_type);
      console.log('Proposal map_id:', proposal.map_id);
      console.log('Proposal poi_x:', proposal.poi_x);
      console.log('Proposal poi_y:', proposal.poi_y);
      
      const data = proposal.proposed_data;
      const current = proposal.current_data;
      
      // Store the proposal data in sessionStorage for the map page to read
      const previewData = {
        proposalId: proposalId,
        changeType: proposal.change_type,
        targetId: proposal.target_id,  // Add target_id for finding the original POI
        mapId: proposal.map_id,  // Include map_id at top level for easier access
        proposed: {
          ...data,
          map_id: data.map_id || proposal.map_id,  // Include map_id
          map_name: proposal.map_name,
          type_name: proposal.type_name,
          npc_name: proposal.npc_name,
          item_name: proposal.item_name,
          // Include coordinates for edit/delete proposals
          x: data.x || proposal.poi_x,
          y: data.y || proposal.poi_y
        },
        current: {
          ...current,
          id: proposal.target_id,  // Include the POI id
          map_id: proposal.map_id,  // Include map_id for current
          // Include coordinates for edit/delete proposals
          x: current?.x || proposal.poi_x,
          y: current?.y || proposal.poi_y
        },
        proposerName: proposal.proposer_name,
        // Pass the type icon data for proper display
        type_icon_type: proposal.type_icon_type,
        type_icon_value: proposal.type_icon_value
      };
      
      console.log('Setting proposal preview data:', previewData);
      console.log('Map ID for proposal:', proposal.map_id);
      console.log('Proposed data npcid:', proposal.proposed_data?.npcid);
      console.log('Current data:', proposal.current_data);
      
      sessionStorage.setItem('poi_proposal_preview', JSON.stringify(previewData));
      
      // Mark that we need to refresh when returning
      sessionStorage.setItem('refresh_on_return', 'true');
      
      // Navigate to the map page
      // The map_id isn't in proposed_data for edit proposals
      // For edit/move/delete/loot/edit_npc proposals, the backend provides map_id at the proposal level
      let mapId = proposal.map_id || data.map_id;
      
      if (!mapId) {
        console.error('No map_id found for proposal:', proposal);
        showMessage('Unable to locate map for this proposal', 'error');
        return;
      }
      
      // Navigate to the map page in a new tab
      window.open(`/?map_id=${mapId}`, '_blank');
      
      // Clear the preview data from this tab's sessionStorage after a short delay
      // This prevents the preview from showing if the user navigates to the map in this tab
      setTimeout(() => {
        sessionStorage.removeItem('poi_proposal_preview');
        sessionStorage.removeItem('refresh_on_return');
      }, 100);
    }
    
    function updateProposalsPagination(totalPages) {
      const pagination = document.getElementById('proposals-pagination');
      const pageInfo = document.getElementById('proposals-page-info');
      const prevBtn = document.getElementById('proposals-prev');
      const nextBtn = document.getElementById('proposals-next');
      
      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }
      
      pagination.style.display = 'flex';
      pageInfo.textContent = `Page ${proposalsPage} of ${totalPages}`;
      
      prevBtn.disabled = proposalsPage === 1;
      nextBtn.disabled = proposalsPage === totalPages;
      
      prevBtn.onclick = () => {
        if (proposalsPage > 1) {
          proposalsPage--;
          loadProposals();
        }
      };
      
      nextBtn.onclick = () => {
        if (proposalsPage < totalPages) {
          proposalsPage++;
          loadProposals();
        }
      };
    }

    // Filter event handlers
    document.getElementById('proposal-type-filter')?.addEventListener('change', (e) => {
      proposalFilters.type = e.target.value;
      proposalsPage = 1;
      clearActiveCards(); // Clear active card states when filter changes
      loadProposals();
    });

    document.getElementById('proposal-filter')?.addEventListener('change', (e) => {
      proposalFilters.show = e.target.value;
      proposalsPage = 1;
      clearActiveCards(); // Clear active card states when filter changes
      loadProposals();
    });

    function showCreateProposalModal() {
      document.getElementById('create-proposal-modal').style.display = 'block';
      document.getElementById('proposal-change-type').value = '';
      document.getElementById('proposal-form-content').style.display = 'none';
      document.getElementById('proposal-notes').value = '';
    }

    function closeCreateProposalModal() {
      document.getElementById('create-proposal-modal').style.display = 'none';
    }

    function updateProposalForm() {
      const changeType = document.getElementById('proposal-change-type').value;
      const formContent = document.getElementById('proposal-form-content');
      
      if (!changeType) {
        formContent.style.display = 'none';
        return;
      }
      
      formContent.style.display = 'block';
      
      switch (changeType) {
        case 'add_npc':
          formContent.innerHTML = `
            <div class="form-group">
              <label>NPC Name *</label>
              <input type="text" id="proposal-npc-name" class="form-control" required>
            </div>
            <div class="form-group">
              <label>Level *</label>
              <input type="number" id="proposal-npc-level" class="form-control" min="1" max="100" required>
            </div>
            <div class="form-group">
              <label>Stats</label>
              <div class="stat-inputs-grid">
                <input type="number" id="proposal-npc-hp" class="form-control" placeholder="HP" min="1">
                <input type="number" id="proposal-npc-ac" class="form-control" placeholder="AC" min="0">
                <input type="number" id="proposal-npc-min-dmg" class="form-control" placeholder="Min Dmg" min="0">
                <input type="number" id="proposal-npc-max-dmg" class="form-control" placeholder="Max Dmg" min="0">
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="proposal-npc-description" class="form-control" rows="2"></textarea>
            </div>
          `;
          break;
          
        case 'add_item':
          formContent.innerHTML = `
            <div class="form-group">
              <label>Item Name *</label>
              <input type="text" id="proposal-item-name" class="form-control" required>
            </div>
            <div class="form-group">
              <label>Type *</label>
              <select id="proposal-item-type" class="form-control">
                <option value="weapon">Weapon</option>
                <option value="armor">Armor</option>
                <option value="consumable">Consumable</option>
                <option value="quest">Quest Item</option>
                <option value="misc">Miscellaneous</option>
              </select>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="proposal-item-description" class="form-control" rows="2"></textarea>
            </div>
          `;
          break;
          
        case 'edit_poi':
        case 'edit_npc':
        case 'edit_item':
          formContent.innerHTML = `
            <div class="form-group">
              <label>${changeType.includes('poi') ? 'POI' : changeType.includes('npc') ? 'NPC' : 'Item'} ID *</label>
              <input type="number" id="proposal-target-id" class="form-control" placeholder="Enter ID to edit" required>
            </div>
            <div class="form-group">
              <label>What changes do you want to make?</label>
              <textarea id="proposal-changes" class="form-control" rows="3" placeholder="Describe the changes..."></textarea>
            </div>
          `;
          break;
      }
    }

    async function submitProposal() {
      const changeType = document.getElementById('proposal-change-type').value;
      const notes = document.getElementById('proposal-notes').value;
      
      if (!changeType) {
        showMessage('Please select a change type', 'error');
        return;
      }
      
      let proposedData = {};
      let targetId = null;
      
      try {
        switch (changeType) {
          case 'add_npc':
            proposedData = {
              name: document.getElementById('proposal-npc-name').value,
              level: parseInt(document.getElementById('proposal-npc-level').value),
              hp: parseInt(document.getElementById('proposal-npc-hp').value) || 100,
              ac: parseInt(document.getElementById('proposal-npc-ac').value) || 10,
              min_dmg: parseInt(document.getElementById('proposal-npc-min-dmg').value) || 1,
              max_dmg: parseInt(document.getElementById('proposal-npc-max-dmg').value) || 10,
              description: document.getElementById('proposal-npc-description').value
            };
            if (!proposedData.name || !proposedData.level) {
              showMessage('Please fill in all required fields', 'error');
              return;
            }
            break;
            
          case 'add_item':
            proposedData = {
              name: document.getElementById('proposal-item-name').value,
              type: document.getElementById('proposal-item-type').value,
              description: document.getElementById('proposal-item-description').value,
              icon_type: 'emoji',
              icon_value: '📦'
            };
            if (!proposedData.name) {
              showMessage('Please fill in all required fields', 'error');
              return;
            }
            break;
            
          case 'edit_poi':
          case 'edit_npc':
          case 'edit_item':
            targetId = parseInt(document.getElementById('proposal-target-id').value);
            proposedData = {
              changes: document.getElementById('proposal-changes').value
            };
            if (!targetId || !proposedData.changes) {
              showMessage('Please fill in all required fields', 'error');
              return;
            }
            break;
        }
        
        const response = await window.csrfHelper.fetchWithCSRF('/api/change-proposals', {
          method: 'POST',
          body: {
            change_type: changeType,
            target_type: changeType.includes('poi') ? 'poi' : changeType.includes('npc') ? 'npc' : 'item',
            target_id: targetId,
            current_data: null,
            proposed_data: proposedData,
            notes: notes
          }
        });
        
        if (response.ok) {
          showMessage('Proposal submitted successfully!', 'success');
          closeCreateProposalModal();
          // Add small delay to ensure database transaction is complete
          setTimeout(() => {
            loadProposals();
            loadVotingStats();
            loadInitialProposalCount();
          }, 100);
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to submit proposal', 'error');
        }
      } catch (error) {
        console.error('Error submitting proposal:', error);
        showMessage('Failed to submit proposal', 'error');
      }
    }

    async function showAdminProposalModal(proposalId) {
      const modal = document.getElementById('admin-proposal-modal');
      const content = document.getElementById('admin-proposal-content');
      
      modal.style.display = 'block';
      content.innerHTML = '<p>Loading proposal details...</p>';
      
      try {
        const response = await fetch('/api/change-proposals');
        if (response.ok) {
          const proposals = await response.json();
          const proposal = proposals.find(p => p.id === proposalId);
          
          if (!proposal) {
            content.innerHTML = '<p style="color: #f44336;">Proposal not found</p>';
            return;
          }
          
          content.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
              <h3>${getProposalTitle(proposal)}</h3>
              <div class="proposal-meta">
                <span>Proposed by ${proposal.proposer_name}</span>
                <span>•</span>
                <span>${formatDate(proposal.created_at)}</span>
              </div>
            </div>
            
            <div style="background: #2d2d2d; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <h4>Proposal Details</h4>
              ${getProposalDescription(proposal)}
              ${proposal.notes ? `<p><strong>Notes:</strong> ${proposal.notes}</p>` : ''}
            </div>
            
            <div style="background: #2d2d2d; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <h4>Current Voting</h4>
              <p>Score: ${proposal.vote_score >= 0 ? '+' : ''}${proposal.vote_score}</p>
              <p>Upvotes: ${proposal.upvotes || 0} | Downvotes: ${proposal.downvotes || 0}</p>
            </div>
            
            <div class="form-group">
              <label>Admin Notes</label>
              <textarea id="admin-proposal-notes" class="form-control" rows="3" placeholder="Add notes about your decision..."></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
              <button class="btn secondary-btn" onclick="closeAdminProposalModal()">Cancel</button>
              <button class="btn danger-btn" onclick="adminRejectProposal(${proposalId})">Reject</button>
              <button class="btn success-btn" onclick="adminApproveProposal(${proposalId})">Approve</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading proposal:', error);
        content.innerHTML = '<p style="color: #f44336;">Failed to load proposal details</p>';
      }
    }

    function closeAdminProposalModal() {
      document.getElementById('admin-proposal-modal').style.display = 'none';
    }

    async function adminApproveProposal(proposalId) {
      const notes = document.getElementById('admin-proposal-notes').value;
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/change-proposals/${proposalId}/action`, {
          method: 'POST',
          body: {
            action: 'approved',
            notes: notes
          }
        });
        
        if (response.ok) {
          showMessage('Proposal approved!', 'success');
          closeAdminProposalModal();
          loadProposals();
          loadInitialProposalCount();
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to approve proposal', 'error');
        }
      } catch (error) {
        console.error('Error approving proposal:', error);
        showMessage('Failed to approve proposal', 'error');
      }
    }

    async function adminRejectProposal(proposalId) {
      const notes = document.getElementById('admin-proposal-notes').value;
      
      if (!notes) {
        showMessage('Please provide a reason for rejection', 'error');
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/admin/change-proposals/${proposalId}/action`, {
          method: 'POST',
          body: {
            action: 'rejected',
            notes: notes
          }
        });
        
        if (response.ok) {
          showMessage('Proposal rejected', 'info');
          closeAdminProposalModal();
          loadProposals();
          loadInitialProposalCount();
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to reject proposal', 'error');
        }
      } catch (error) {
        console.error('Error rejecting proposal:', error);
        showMessage('Failed to reject proposal', 'error');
      }
    }
    
    // Expose voting functions to window after they're defined
    window.voteProposal = voteProposal;
    window.deleteProposal = deleteProposal;
    window.showCreateProposalModal = showCreateProposalModal;
    window.showAdminProposalModal = showAdminProposalModal;
    window.closeCreateProposalModal = closeCreateProposalModal;
    window.updateProposalForm = updateProposalForm;
    window.submitProposal = submitProposal;
    window.closeAdminProposalModal = closeAdminProposalModal;
    window.adminApproveProposal = adminApproveProposal;
    window.adminRejectProposal = adminRejectProposal;
    window.viewProposalPOI = viewProposalPOI;
    window.filterByCard = filterByCard;

    async function loadAdminData() {
      // Load users
      loadUsers();
      // Load POI types
      loadPOITypes();
      // Load POI editor
      loadPOIEditor();
      // Load Item editor
      loadItemEditor();
      // Load NPC editor
      loadNPCEditor();
    }
    
    async function loadPOITypes() {
      const loading = document.getElementById('poi-types-loading');
      const content = document.getElementById('poi-types-content');
      
      try {
        const response = await fetch('/api/poi-types');
        if (response.ok) {
          poiTypes = await response.json();
          displayPOITypes();
          loading.style.display = 'none';
          content.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading POI types:', error);
        loading.innerHTML = '<p style="color: #dc3545;">Failed to load POI types</p>';
      }
    }
    
    function displayPOITypes() {
      const tbody = document.getElementById('poi-types-tbody');
      tbody.innerHTML = '';
      
      if (poiTypes.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="6" style="text-align: center; color: #666; padding: 2rem;">
            No POI types defined. Click "Add POI Type" to create one.
          </td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      // Calculate pagination
      const totalPages = Math.ceil(poiTypes.length / POI_TYPES_PER_PAGE);
      const startIndex = currentPOITypePage * POI_TYPES_PER_PAGE;
      const endIndex = Math.min(startIndex + POI_TYPES_PER_PAGE, poiTypes.length);
      const paginatedTypes = poiTypes.slice(startIndex, endIndex);
      
      paginatedTypes.forEach((type, index) => {
        const row = document.createElement('tr');
        row.dataset.typeId = type.id;
        
        // Icon cell
        const iconCell = document.createElement('td');
        iconCell.style.textAlign = 'center';
        if (type.icon_type === 'emoji') {
          iconCell.style.fontSize = '1.5rem';
          iconCell.textContent = type.icon_value;
        } else if (type.icon_type === 'iconify' || type.icon_type === 'fontawesome') {
          iconCell.innerHTML = `<iconify-icon icon="${type.icon_value}" width="24" height="24"></iconify-icon>`;
        } else if (type.icon_type === 'upload') {
          const img = document.createElement('img');
          img.src = type.icon_value;
          img.style.width = '32px';
          img.style.height = '32px';
          img.style.objectFit = 'contain';
          iconCell.appendChild(img);
        }
        row.appendChild(iconCell);
        
        // Name cell
        const nameCell = document.createElement('td');
        nameCell.textContent = type.name;
        row.appendChild(nameCell);
        
        // Type cell
        const typeCell = document.createElement('td');
        typeCell.textContent = type.icon_type.charAt(0).toUpperCase() + type.icon_type.slice(1);
        row.appendChild(typeCell);
        
        // Default cell
        const defaultCell = document.createElement('td');
        defaultCell.style.textAlign = 'center';
        if (type.is_default) {
          const badge = document.createElement('span');
          badge.style.background = '#28a745';
          badge.style.color = 'white';
          badge.style.padding = '0.2rem 0.5rem';
          badge.style.borderRadius = '4px';
          badge.style.fontSize = '0.8rem';
          badge.textContent = 'Default';
          defaultCell.appendChild(badge);
        }
        row.appendChild(defaultCell);
        
        // Order cell
        const orderCell = document.createElement('td');
        orderCell.style.textAlign = 'center';
        
        const orderButtons = document.createElement('div');
        orderButtons.style.display = 'flex';
        orderButtons.style.gap = '0.25rem';
        orderButtons.style.justifyContent = 'center';
        
        if (index > 0) {
          const upBtn = document.createElement('button');
          upBtn.className = 'small-btn';
          upBtn.style.padding = '0.2rem 0.4rem';
          upBtn.textContent = '↑';
          upBtn.onclick = () => movePOIType(type.id, -1);
          orderButtons.appendChild(upBtn);
        }
        
        if (index < poiTypes.length - 1) {
          const downBtn = document.createElement('button');
          downBtn.className = 'small-btn';
          downBtn.style.padding = '0.2rem 0.4rem';
          downBtn.textContent = '↓';
          downBtn.onclick = () => movePOIType(type.id, 1);
          orderButtons.appendChild(downBtn);
        }
        
        orderCell.appendChild(orderButtons);
        row.appendChild(orderCell);
        
        // Actions cell
        const actionsCell = document.createElement('td');
        const actionsDiv = document.createElement('div');
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '0.5rem';
        actionsDiv.style.justifyContent = 'center';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'small-btn';
        editBtn.innerHTML = '<span class="btn-icon">✏️</span>Edit';
        editBtn.onclick = () => editPOIType(type.id);
        actionsDiv.appendChild(editBtn);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'small-btn danger-btn';
        deleteBtn.innerHTML = '<span class="btn-icon">🗑️</span>Delete';
        deleteBtn.onclick = () => deletePOIType(type.id);
        actionsDiv.appendChild(deleteBtn);
        
        actionsCell.appendChild(actionsDiv);
        row.appendChild(actionsCell);
        
        tbody.appendChild(row);
      });
      
      // Update pagination info
      const paginationInfo = document.getElementById('poi-types-pagination-info');
      paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${poiTypes.length} types`;
      
      // Update pagination controls
      const paginationDiv = document.getElementById('poi-types-pagination');
      if (totalPages > 1) {
        paginationDiv.style.display = 'block';
        paginationDiv.innerHTML = '';
        
        // First page button
        const firstBtn = document.createElement('button');
        firstBtn.className = 'pagination-btn';
        firstBtn.innerHTML = '«';
        firstBtn.title = 'First page';
        firstBtn.disabled = currentPOITypePage === 0;
        firstBtn.onclick = () => {
          currentPOITypePage = 0;
          displayPOITypes();
        };
        paginationDiv.appendChild(firstBtn);
        
        // Previous page button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn';
        prevBtn.innerHTML = '‹';
        prevBtn.title = 'Previous page';
        prevBtn.disabled = currentPOITypePage === 0;
        prevBtn.onclick = () => {
          currentPOITypePage--;
          displayPOITypes();
        };
        paginationDiv.appendChild(prevBtn);
        
        // Page numbers
        const maxVisible = 5;
        let startPage = Math.max(0, currentPOITypePage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages - 1, startPage + maxVisible - 1);
        
        if (endPage - startPage < maxVisible - 1) {
          startPage = Math.max(0, endPage - maxVisible + 1);
        }
        
        if (startPage > 0) {
          const pageBtn = document.createElement('button');
          pageBtn.className = 'pagination-btn';
          pageBtn.textContent = '1';
          pageBtn.onclick = () => {
            currentPOITypePage = 0;
            displayPOITypes();
          };
          paginationDiv.appendChild(pageBtn);
          
          if (startPage > 1) {
            const ellipsis = document.createElement('span');
            ellipsis.style.padding = '0 0.5rem';
            ellipsis.style.color = '#666';
            ellipsis.textContent = '...';
            paginationDiv.appendChild(ellipsis);
          }
        }
        
        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.className = 'pagination-btn';
          if (i === currentPOITypePage) {
            pageBtn.className += ' active';
          }
          pageBtn.textContent = i + 1;
          pageBtn.onclick = () => {
            currentPOITypePage = i;
            displayPOITypes();
          };
          paginationDiv.appendChild(pageBtn);
        }
        
        if (endPage < totalPages - 1) {
          if (endPage < totalPages - 2) {
            const ellipsis = document.createElement('span');
            ellipsis.style.padding = '0 0.5rem';
            ellipsis.style.color = '#666';
            ellipsis.textContent = '...';
            paginationDiv.appendChild(ellipsis);
          }
          
          const pageBtn = document.createElement('button');
          pageBtn.className = 'pagination-btn';
          pageBtn.textContent = totalPages;
          pageBtn.onclick = () => {
            currentPOITypePage = totalPages - 1;
            displayPOITypes();
          };
          paginationDiv.appendChild(pageBtn);
        }
        
        // Next page button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn';
        nextBtn.innerHTML = '›';
        nextBtn.title = 'Next page';
        nextBtn.disabled = currentPOITypePage === totalPages - 1;
        nextBtn.onclick = () => {
          currentPOITypePage++;
          displayPOITypes();
        };
        paginationDiv.appendChild(nextBtn);
        
        // Last page button
        const lastBtn = document.createElement('button');
        lastBtn.className = 'pagination-btn';
        lastBtn.innerHTML = '»';
        lastBtn.title = 'Last page';
        lastBtn.disabled = currentPOITypePage === totalPages - 1;
        lastBtn.onclick = () => {
          currentPOITypePage = totalPages - 1;
          displayPOITypes();
        };
        paginationDiv.appendChild(lastBtn);
      } else {
        paginationDiv.style.display = 'none';
      }
    }
    
    function showAddPOITypeModal() {
      editingPOIType = null;
      document.getElementById('poi-type-modal-title').textContent = 'Add POI Type';
      document.getElementById('poi-type-form').reset();
      document.getElementById('emoji-input-group').style.display = 'block';
      document.getElementById('iconify-input-group').style.display = 'none';
      document.getElementById('upload-input-group').style.display = 'none';
      document.getElementById('icon-preview').innerHTML = '';
      document.getElementById('selected-iconify-preview').innerHTML = '<span style="color: #666;">?</span>';
      document.getElementById('poi-type-modal').style.display = 'flex';
      
      // Populate emoji picker with default category
      populateEmojiPicker('harvest');
    }
    
    function editPOIType(id) {
      const type = poiTypes.find(t => t.id === id);
      if (!type) return;
      
      editingPOIType = type;
      document.getElementById('poi-type-modal-title').textContent = 'Edit POI Type';
      document.getElementById('poi-type-name').value = type.name;
      
      // Set icon type
      document.querySelector(`input[name="icon-type"][value="${type.icon_type}"]`).checked = true;
      updateIconTypeDisplay();
      
      // Set icon value
      if (type.icon_type === 'emoji') {
        document.getElementById('poi-type-emoji').value = type.icon_value;
      } else if (type.icon_type === 'iconify' || type.icon_type === 'fontawesome') {
        document.getElementById('poi-type-iconify-value').value = type.icon_value;
        document.getElementById('poi-type-iconify').value = '';
        const preview = document.getElementById('selected-iconify-preview');
        preview.innerHTML = `<iconify-icon icon="${type.icon_value}" width="24" height="24"></iconify-icon>`;
      } else if (type.icon_type === 'upload') {
        const preview = document.getElementById('icon-preview');
        preview.innerHTML = `<img src="${type.icon_value}" style="width: 64px; height: 64px; object-fit: contain;">`;
      }
      
      document.getElementById('poi-type-modal').style.display = 'flex';
    }
    
    async function savePOIType(event) {
      event.preventDefault();
      
      const name = document.getElementById('poi-type-name').value.trim();
      const iconType = document.querySelector('input[name="icon-type"]:checked').value;
      let iconValue = '';
      
      // Get icon value based on type
      if (iconType === 'emoji') {
        iconValue = document.getElementById('poi-type-emoji').value.trim();
        if (!iconValue) {
          showMessage('Please enter an emoji', 'error');
          return;
        }
      } else if (iconType === 'iconify') {
        iconValue = document.getElementById('poi-type-iconify-value').value.trim();
        if (!iconValue) {
          showMessage('Please select an icon from the library', 'error');
          return;
        }
      } else if (iconType === 'upload') {
        const fileInput = document.getElementById('poi-type-upload');
        if (!editingPOIType && !fileInput.files[0]) {
          showMessage('Please select an image', 'error');
          return;
        }
      }
      
      try {
        if (iconType === 'upload' && document.getElementById('poi-type-upload').files[0]) {
          // Upload image first
          const formData = new FormData();
          formData.append('icon', document.getElementById('poi-type-upload').files[0]);
          
          const uploadResponse = await window.csrfHelper.fetchWithCSRF('/api/poi-types/upload-icon', {
            method: 'POST',
            body: formData
          });
          
          if (!uploadResponse.ok) {
            throw new Error('Failed to upload icon');
          }
          
          const uploadData = await uploadResponse.json();
          iconValue = uploadData.iconUrl;
        } else if (iconType === 'upload' && editingPOIType) {
          // Keep existing upload value
          iconValue = editingPOIType.icon_value;
        }
        
        const body = {
          name,
          icon_type: iconType,
          icon_value: iconValue
        };
        
        const url = editingPOIType 
          ? `/api/poi-types/${editingPOIType.id}`
          : '/api/poi-types';
          
        const method = editingPOIType ? 'PUT' : 'POST';
        
        const response = await window.csrfHelper.fetchWithCSRF(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        if (response.ok) {
          showMessage(`POI type ${editingPOIType ? 'updated' : 'created'} successfully. Refresh the map to see icon changes on existing POIs.`, 'success');
          closePOITypeModal();
          loadPOITypes();
          
          // If POI editor is loaded, refresh it to show updated icons
          if (document.getElementById('poi-editor-content').style.display !== 'none') {
            loadPOIEditor();
          }
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to save POI type', 'error');
        }
      } catch (error) {
        showMessage('Failed to save POI type', 'error');
      }
    }
    
    async function deletePOIType(id) {
      const type = poiTypes.find(t => t.id === id);
      if (!type) return;
      
      if (!confirm(`Are you sure you want to delete the POI type "${type.name}"? This cannot be undone.`)) {
        return;
      }
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF(`/api/poi-types/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showMessage('POI type deleted successfully', 'success');
          loadPOITypes();
        } else {
          const error = await response.json();
          showMessage(error.error || 'Failed to delete POI type', 'error');
        }
      } catch (error) {
        showMessage('Failed to delete POI type', 'error');
      }
    }
    
    async function movePOIType(id, direction) {
      const currentIndex = poiTypes.findIndex(t => t.id === id);
      const newIndex = currentIndex + direction;
      
      if (newIndex < 0 || newIndex >= poiTypes.length) return;
      
      // Create a copy of the array and swap positions
      const reorderedTypes = [...poiTypes];
      [reorderedTypes[currentIndex], reorderedTypes[newIndex]] = 
        [reorderedTypes[newIndex], reorderedTypes[currentIndex]];
      
      // Update display_order for all types based on their new positions
      const orderData = reorderedTypes.map((type, index) => ({
        id: type.id,
        display_order: index
      }));
      
      try {
        const response = await window.csrfHelper.fetchWithCSRF('/api/poi-types/reorder', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order: orderData })
        });
        
        if (response.ok) {
          loadPOITypes();
          showMessage('POI type reordered successfully', 'success');
        } else {
          showMessage('Failed to reorder POI type', 'error');
        }
      } catch (error) {
        showMessage('Failed to reorder POI type', 'error');
      }
    }
    
    function closePOITypeModal() {
      document.getElementById('poi-type-modal').style.display = 'none';
      editingPOIType = null;
      document.getElementById('poi-type-form').reset();
      document.getElementById('icon-preview').innerHTML = '';
      document.getElementById('emoji-picker').style.display = 'none';
    }
    
    function updateIconTypeDisplay() {
      const iconType = document.querySelector('input[name="icon-type"]:checked').value;
      
      document.getElementById('emoji-input-group').style.display = iconType === 'emoji' ? 'block' : 'none';
      document.getElementById('iconify-input-group').style.display = iconType === 'iconify' ? 'block' : 'none';
      document.getElementById('upload-input-group').style.display = iconType === 'upload' ? 'block' : 'none';
      
      // Reset file input when switching away from upload
      if (iconType !== 'upload') {
        document.getElementById('poi-type-upload').value = '';
        document.getElementById('icon-preview').innerHTML = '';
      }
      
      // Reset iconify when switching away
      if (iconType !== 'iconify') {
        document.getElementById('poi-type-iconify').value = '';
        document.getElementById('poi-type-iconify-value').value = '';
        document.getElementById('selected-iconify-preview').innerHTML = '<span style="color: #666;">?</span>';
      }
    }
    
    function toggleEmojiPicker() {
      const picker = document.getElementById('emoji-picker');
      picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
      
      if (picker.style.display === 'block') {
        populateEmojiPicker(currentEmojiCategory);
      }
    }
    
    function selectEmojiCategory(category) {
      currentEmojiCategory = category;
      
      // Update active button
      document.querySelectorAll('.emoji-category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      populateEmojiPicker(category);
    }
    
    function populateEmojiPicker(category) {
      const grid = document.getElementById('emoji-grid');
      grid.innerHTML = '';
      
      const emojis = emojiCategories[category] || [];
      emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.style.fontSize = '1.75rem';
        btn.style.padding = '0.5rem';
        btn.style.border = '1px solid transparent';
        btn.style.background = '#2d2d2d';
        btn.style.cursor = 'pointer';
        btn.style.borderRadius = '6px';
        btn.style.minWidth = '45px';
        btn.style.minHeight = '45px';
        btn.style.display = 'flex';
        btn.style.alignItems = 'center';
        btn.style.justifyContent = 'center';
        btn.style.transition = 'all 0.2s ease';
        btn.textContent = emoji;
        
        btn.onmouseover = () => {
          btn.style.background = '#3d3d3d';
          btn.style.border = '1px solid #FFD700';
          btn.style.transform = 'scale(1.1)';
        };
        
        btn.onmouseout = () => {
          btn.style.background = '#2d2d2d';
          btn.style.border = '1px solid transparent';
          btn.style.transform = 'scale(1)';
        };
        
        btn.onclick = () => {
          document.getElementById('poi-type-emoji').value = emoji;
          document.getElementById('emoji-picker').style.display = 'none';
        };
        
        grid.appendChild(btn);
      });
    }
    
    // Handle file upload preview
    document.getElementById('poi-type-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('icon-preview').innerHTML = 
            `<img src="${e.target.result}" style="width: 64px; height: 64px; object-fit: contain;">`;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Iconify functions
    let iconifySearchTimeout;
    let currentIconSet = null;
    
    // Wait for Iconify to be loaded
    window.addEventListener('DOMContentLoaded', () => {
      // Force Iconify to scan for icons after DOM is ready
      if (window.Iconify) {
        window.Iconify.scan();
      }
    });
    
    // Popular RPG-related icon searches
    const rpgIconSearches = {
      'game-icons': ['sword', 'shield', 'potion', 'treasure', 'castle', 'dragon', 'tavern', 'spell', 'armor', 'bow', 'axe', 'helmet', 'chest', 'crown', 'gem', 'scroll', 'dagger', 'mace', 'staff', 'wand', 'arrow', 'quiver', 'book', 'tome', 'crystal', 'orb', 'ring', 'amulet', 'coin', 'bag', 'merchant', 'shop', 'inn', 'temple', 'church', 'tower', 'dungeon', 'cave', 'forest', 'mountain', 'village', 'camp', 'fire', 'torch', 'lantern', 'key', 'lock', 'door', 'gate', 'bridge', 'altar', 'throne', 'banner', 'flag', 'emblem', 'crest',
        // Monsters
        'goblin', 'orc', 'troll', 'giant', 'skeleton', 'zombie', 'vampire', 'werewolf', 'demon', 'angel', 'dragon', 'wyvern', 'drake', 'hydra', 'basilisk', 'griffin', 'phoenix', 'unicorn', 'centaur', 'minotaur', 'harpy', 'siren', 'medusa', 'cyclops', 'ogre', 'imp', 'devil', 'lich', 'wraith', 'ghost', 'banshee', 'specter', 'phantom', 'gargoyle', 'golem', 'elemental', 'spider', 'rat', 'bat', 'snake', 'scorpion', 'beetle', 'wolf', 'bear', 'boar', 'lion', 'tiger', 'panther', 'eagle', 'hawk', 'raven', 'owl', 'crocodile', 'lizard', 'dinosaur', 'tentacle', 'kraken', 'leviathan', 'behemoth', 'chimera', 'manticore', 'sphinx', 'cerberus', 'hellhound', 'dire', 'swarm', 'slime', 'ooze', 'blob', 'fungus', 'plant', 'treant', 'dryad', 'fairy', 'pixie', 'sprite', 'wisp', 'shade', 'shadow', 'nightmare', 'fiend', 'aberration', 'monstrosity', 'beast', 'undead', 'construct', 'fey', 'celestial', 'infernal', 'abyssal',
        // Classes & Professions
        'wizard', 'knight', 'rogue', 'archer', 'cleric', 'paladin', 'barbarian', 'monk', 'druid', 'ranger', 'bard', 'necromancer', 'sorcerer', 'warlock', 'witch', 'shaman', 'priest', 'templar', 'crusader', 'inquisitor', 'assassin', 'thief', 'scout', 'hunter', 'tracker', 'berserker', 'warrior', 'fighter', 'gladiator', 'champion', 'hero', 'adventurer', 'mercenary', 'soldier', 'guard', 'captain', 'general', 'king', 'queen', 'prince', 'princess', 'noble', 'lord', 'lady', 'duke', 'duchess', 'baron', 'count', 'emperor', 'empress', 'merchant', 'blacksmith', 'alchemist', 'enchanter', 'artificer', 'scholar', 'sage', 'mage', 'battlemage', 'spellsword', 'bladedancer', 'shadowdancer', 'arcane', 'divine', 'nature', 'elemental', 'summoner', 'conjurer', 'illusionist', 'diviner', 'transmuter', 'abjurer', 'evoker',
        // Harvesting & Crafting
        'pickaxe', 'mining', 'ore', 'stone', 'coal', 'iron', 'gold', 'silver', 'copper', 'fishing', 'fish', 'rod', 'net', 'hook', 'bait', 'wood', 'log', 'lumber', 'tree', 'forest', 'axe', 'saw', 'harvest', 'farm', 'crop', 'wheat', 'corn', 'herb', 'plant', 'flower', 'mushroom', 'berry', 'fruit', 'vegetable', 'basket', 'sack', 'barrel', 'crate', 'shovel', 'hoe', 'scythe', 'rake', 'anvil', 'hammer', 'tongs', 'forge', 'smelting', 'crafting'],
      'mdi': ['sword', 'shield', 'castle', 'treasure', 'map', 'compass', 'flag', 'star', 'heart', 'diamond', 'crown', 'key', 'lock', 'book', 'flask', 'fire'],
      'tabler': ['sword', 'shield', 'home', 'flag', 'star', 'map', 'location', 'building', 'trophy', 'flame', 'book', 'key'],
      'ri': ['sword', 'shield', 'treasure', 'map', 'compass', 'flag', 'building', 'home', 'star', 'book', 'key', 'fire'],
      'heroicons': ['shield', 'flag', 'star', 'home', 'map', 'location-marker', 'sparkles', 'fire', 'book-open', 'key'],
      'lucide': ['sword', 'shield', 'castle', 'crown', 'gem', 'map', 'compass', 'flag', 'star', 'home', 'flame', 'book', 'key', 'scroll', 'wand']
    };
    
    async function searchIconifyIcons(query) {
      clearTimeout(iconifySearchTimeout);
      
      if (query.length < 2) {
        document.getElementById('iconify-picker').style.display = 'none';
        return;
      }
      
      iconifySearchTimeout = setTimeout(async () => {
        const resultsContainer = document.getElementById('iconify-search-results');
        resultsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem;">Searching...</div>';
        document.getElementById('iconify-picker').style.display = 'block';
        
        try {
          // Search across multiple icon sets
          const iconSets = ['mdi', 'tabler', 'game-icons', 'ri', 'heroicons', 'lucide', 'material-symbols'];
          const results = [];
          
          // Use Iconify's search API
          const response = await fetch(`https://api.iconify.design/search?query=${encodeURIComponent(query)}&limit=48`);
          const data = await response.json();
          
          if (data.icons && data.icons.length > 0) {
            resultsContainer.innerHTML = '';
            for (const iconName of data.icons) {
              const iconItem = await createIconifyIconItem(iconName);
              resultsContainer.appendChild(iconItem);
            }
          } else {
            // Fallback: search in specific sets
            resultsContainer.innerHTML = '';
            let foundIcons = false;
            
            for (const set of iconSets) {
              try {
                const setResponse = await fetch(`https://api.iconify.design/collection?prefix=${set}`);
                const setData = await setResponse.json();
                
                if (setData.uncategorized) {
                  const matchingIcons = setData.uncategorized.filter(icon => 
                    icon.toLowerCase().includes(query.toLowerCase())
                  );
                  
                  for (const iconName of matchingIcons.slice(0, 8)) {
                    const fullIconName = `${set}:${iconName}`;
                    const iconItem = await createIconifyIconItem(fullIconName);
                    resultsContainer.appendChild(iconItem);
                    foundIcons = true;
                  }
                }
              } catch (err) {
                console.log(`Failed to search ${set}:`, err);
              }
            }
            
            if (!foundIcons) {
              resultsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #999;">No icons found. Try browsing icon sets below.</div>';
            }
          }
        } catch (error) {
          console.error('Icon search error:', error);
          resultsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #dc3545;">Search failed. Try browsing icon sets.</div>';
        }
      }, 300);
    }
    
    async function loadIconifySet(setName) {
      const resultsContainer = document.getElementById('iconify-search-results');
      resultsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem;">Loading icons...</div>';
      document.getElementById('iconify-picker').style.display = 'block';
      
      // Update active button
      document.querySelectorAll('.icon-set-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      currentIconSet = setName;
      
      try {
        // Get RPG-related icons for this set
        const iconSearchTerms = rpgIconSearches[setName] || ['icon'];
        const allIcons = [];
        
        // Fetch collection info
        const response = await fetch(`https://api.iconify.design/collection?prefix=${setName}`);
        const data = await response.json();
        
        if (data.uncategorized) {
          // Filter icons based on RPG-related terms
          const rpgIcons = data.uncategorized.filter(iconName => {
            const lowerName = iconName.toLowerCase();
            return iconSearchTerms.some(term => lowerName.includes(term)) ||
                   lowerName.includes('game') || lowerName.includes('rpg') || 
                   lowerName.includes('quest') || lowerName.includes('adventure');
          });
          
          // If we found RPG icons, use them; otherwise show first 48 icons
          const iconsToShow = rpgIcons.length > 0 ? rpgIcons.slice(0, 48) : data.uncategorized.slice(0, 48);
          
          resultsContainer.innerHTML = '';
          for (const iconName of iconsToShow) {
            const fullIconName = `${setName}:${iconName}`;
            const iconItem = await createIconifyIconItem(fullIconName);
            resultsContainer.appendChild(iconItem);
          }
        }
      } catch (error) {
        console.error('Failed to load icon set:', error);
        resultsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #dc3545;">Failed to load icons</div>';
      }
    }
    
    async function createIconifyIconItem(iconName) {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'iconify-icon-item';
      button.setAttribute('data-icon', iconName);
      button.onclick = () => selectIconifyIcon(iconName);
      
      // Create a loading placeholder
      button.innerHTML = '<span style="color: #666;">...</span>';
      
      // Try to load the SVG directly - keep original colors
      try {
        const response = await fetch(`https://api.iconify.design/${iconName}.svg?width=24&height=24`);
        if (response.ok) {
          const svg = await response.text();
          button.innerHTML = svg;
        } else {
          // Fallback to web component
          button.innerHTML = `<iconify-icon icon="${iconName}" width="24" height="24"></iconify-icon>`;
        }
      } catch (error) {
        // Fallback to web component
        button.innerHTML = `<iconify-icon icon="${iconName}" width="24" height="24"></iconify-icon>`;
      }
      
      return button;
    }
    
    function selectIconifyIcon(iconName) {
      // Update hidden input
      document.getElementById('poi-type-iconify-value').value = iconName;
      
      // Update preview
      const preview = document.getElementById('selected-iconify-preview');
      preview.innerHTML = `<iconify-icon icon="${iconName}" width="24" height="24"></iconify-icon>`;
      
      // Highlight selected icon
      document.querySelectorAll('.iconify-icon-item').forEach(item => {
        item.classList.remove('selected');
      });
      event.target.closest('.iconify-icon-item').classList.add('selected');
      
      // Clear search
      document.getElementById('poi-type-iconify').value = '';
      
      // Hide picker after short delay
      setTimeout(() => {
        document.getElementById('iconify-picker').style.display = 'none';
      }, 200);
    }

    // POI Editor Functions
    let allPOIs = [];
    let filteredPOIs = [];
    let poiChanges = new Map(); // Map of poi.id -> changes object
    let currentPOIEditorPage = 0;
    const POI_EDITOR_PER_PAGE = 10;
    let maps = [];
    
    // Make POI Editor table columns resizable
    function makeColumnsResizable() {
      const table = document.querySelector('.poi-editor-table');
      if (!table) return;
      
      const headers = table.querySelectorAll('thead th');
      headers.forEach((header, index) => {
        // Don't add resizer to the last column (Delete)
        if (index === headers.length - 1) return;
        
        // Remove existing resizer if any
        const existingResizer = header.querySelector('.column-resizer');
        if (existingResizer) {
          existingResizer.remove();
        }
        
        // Create resizer element
        const resizer = document.createElement('div');
        resizer.className = 'column-resizer';
        header.appendChild(resizer);
        
        let startX = 0;
        let startWidth = 0;
        let isResizing = false;
        
        resizer.addEventListener('mousedown', (e) => {
          isResizing = true;
          startX = e.pageX;
          startWidth = header.offsetWidth;
          resizer.classList.add('resizing');
          header.classList.add('resizing');
          document.body.style.cursor = 'col-resize';
          e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          
          const diff = e.pageX - startX;
          const newWidth = Math.max(50, startWidth + diff); // Minimum width of 50px
          header.style.width = newWidth + 'px';
        });
        
        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            resizer.classList.remove('resizing');
            header.classList.remove('resizing');
            document.body.style.cursor = '';
            
            // Save column widths to localStorage
            saveColumnWidths();
          }
        });
      });
      
      // Restore saved column widths
      restoreColumnWidths();
    }
    
    // Save column widths to localStorage
    function saveColumnWidths() {
      const table = document.querySelector('.poi-editor-table');
      if (!table) return;
      
      const headers = table.querySelectorAll('thead th');
      const widths = Array.from(headers).map(header => header.style.width || header.offsetWidth + 'px');
      localStorage.setItem('poiEditorColumnWidths', JSON.stringify(widths));
    }
    
    // Restore column widths from localStorage
    function restoreColumnWidths() {
      const table = document.querySelector('.poi-editor-table');
      if (!table) return;
      
      const savedWidths = localStorage.getItem('poiEditorColumnWidths');
      if (!savedWidths) return;
      
      try {
        const widths = JSON.parse(savedWidths);
        const headers = table.querySelectorAll('thead th');
        headers.forEach((header, index) => {
          if (widths[index]) {
            header.style.width = widths[index];
          }
        });
      } catch (e) {
        console.error('Error restoring column widths:', e);
      }
    }
    
    async function loadPOIEditor() {
      const loading = document.getElementById('poi-editor-loading');
      const content = document.getElementById('poi-editor-content');
      
      try {
        // Load maps first
        const mapsResponse = await fetch('/api/maps');
        if (mapsResponse.ok) {
          maps = await mapsResponse.json();
          populateMapFilter();
        }
        
        // Load all POIs
        const response = await fetch('/api/pois/all');
        if (response.ok) {
          allPOIs = await response.json();
          filterPOIsByMap();
          loading.style.display = 'none';
          content.style.display = 'block';
          updateStats();
        } else {
          const error = await response.json();
          loading.innerHTML = `<p style="color: #dc3545;">Failed to load POIs: ${error.error || 'Unknown error'}</p>`;
        }
      } catch (error) {
        console.error('Error loading POIs:', error);
        loading.innerHTML = '<p style="color: #dc3545;">Failed to load POIs</p>';
      }
    }
    
    function populateMapFilter() {
      const select = document.getElementById('poi-map-filter');
      select.innerHTML = '<option value="all">All Maps</option>';
      
      maps.forEach(map => {
        const option = document.createElement('option');
        option.value = map.id;
        option.textContent = map.name;
        select.appendChild(option);
      });
    }
    
    function filterPOIsByMap() {
      // Check for unsaved changes before filtering
      if (poiChanges.size > 0) {
        if (!confirm('You have unsaved changes. Are you sure you want to change the map filter? Your changes will be lost.')) {
          // Reset the select to the previous value
          // Note: This is a simple approach, a more robust solution would track the previous value
          return;
        }
        // Clear changes if user confirms
        poiChanges.clear();
        updateChangeButtons();
      }
      
      const mapId = document.getElementById('poi-map-filter').value;
      
      if (mapId === 'all') {
        filteredPOIs = [...allPOIs];
      } else {
        filteredPOIs = allPOIs.filter(poi => poi.map_id === parseInt(mapId));
      }
      
      currentPOIEditorPage = 0;
      applySearchFilter();
      updateStats();
    }
    
    function displayPOIEditor() {
      const tbody = document.getElementById('poi-editor-tbody');
      tbody.innerHTML = '';
      
      if (filteredPOIs.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="11" style="text-align: center; color: #666; padding: 2rem;">
            No POIs found for the selected filter.
          </td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      // Calculate pagination
      const totalPages = Math.ceil(filteredPOIs.length / POI_EDITOR_PER_PAGE);
      const startIndex = currentPOIEditorPage * POI_EDITOR_PER_PAGE;
      const endIndex = Math.min(startIndex + POI_EDITOR_PER_PAGE, filteredPOIs.length);
      const paginatedPOIs = filteredPOIs.slice(startIndex, endIndex);
      
      paginatedPOIs.forEach(poi => {
        const row = createPOIEditorRow(poi);
        
        // Highlight if this is the POI we're looking for
        if (window.poiEditorHighlightId && poi.id == window.poiEditorHighlightId) {
          row.classList.add('highlighted-poi');
          // Store the highlighted POI ID permanently
          window.permanentHighlightId = poi.id;
          // Scroll into view after a short delay
          setTimeout(() => {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 500);
        }
        
        // Re-apply highlight if it matches the permanent highlight
        if (window.permanentHighlightId && poi.id == window.permanentHighlightId) {
          row.classList.add('highlighted-poi');
        }
        
        tbody.appendChild(row);
      });
      
      // Update pagination info
      const paginationInfo = document.getElementById('poi-editor-pagination-info');
      paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredPOIs.length} POIs`;
      
      // Update pagination controls
      updatePOIEditorPagination(totalPages);
      
      // Make columns resizable after table is populated
      makeColumnsResizable();
    }
    
    function createPOIEditorRow(poi) {
      const row = document.createElement('tr');
      row.dataset.poiId = poi.id;
      
      // ID cell (read-only)
      const idCell = document.createElement('td');
      idCell.textContent = poi.id;
      idCell.style.color = '#666';
      idCell.style.textAlign = 'center';
      row.appendChild(idCell);
      
      // Name cell
      const nameCell = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = poi.name || '';
      nameInput.dataset.field = 'name';
      nameInput.dataset.original = poi.name || '';
      nameInput.placeholder = 'POI Name';
      nameInput.onkeypress = (e) => handleCellKeypress(e, poi.id);
      nameInput.onblur = () => stagePOIChange(poi.id, 'name', nameInput.value);
      nameCell.appendChild(nameInput);
      row.appendChild(nameCell);
      
      // Description cell
      const descCell = document.createElement('td');
      const descTextarea = document.createElement('textarea');
      descTextarea.value = poi.description || '';
      descTextarea.dataset.field = 'description';
      descTextarea.dataset.original = poi.description || '';
      descTextarea.placeholder = 'Description (optional)';
      descTextarea.rows = 2;
      descTextarea.onkeypress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          stagePOIChange(poi.id, 'description', descTextarea.value);
          descTextarea.blur();
        }
      };
      descTextarea.onblur = () => stagePOIChange(poi.id, 'description', descTextarea.value);
      descCell.appendChild(descTextarea);
      row.appendChild(descCell);
      
      // Type cell (dropdown)
      const typeCell = document.createElement('td');
      const typeSelect = createPOITypeSelect(poi);
      typeCell.appendChild(typeSelect);
      row.appendChild(typeCell);
      
      // Icon cell (display only, updates with type)
      const iconCell = document.createElement('td');
      iconCell.style.textAlign = 'center';
      iconCell.className = 'poi-type-icon';
      iconCell.innerHTML = renderPOIIcon(poi);
      row.appendChild(iconCell);
      
      // Icon size
      const iconSizeCell = document.createElement('td');
      const iconSizeInput = document.createElement('input');
      iconSizeInput.type = 'number';
      iconSizeInput.value = poi.icon_size || 34;
      iconSizeInput.dataset.field = 'icon_size';
      iconSizeInput.dataset.original = poi.icon_size || 34;
      iconSizeInput.min = '10';
      iconSizeInput.max = '100';
      iconSizeInput.step = '1';
      iconSizeInput.style.width = '100%';
      iconSizeInput.onkeypress = (e) => handleCellKeypress(e, poi.id);
      iconSizeInput.onblur = () => stagePOIChange(poi.id, 'icon_size', parseInt(iconSizeInput.value));
      iconSizeCell.appendChild(iconSizeInput);
      row.appendChild(iconSizeCell);
      
      // NPC ID cell
      const npcIdCell = document.createElement('td');
      const npcIdContainer = document.createElement('div');
      npcIdContainer.style.cssText = 'display: flex; align-items: center; gap: 4px;';
      
      const npcIdInput = document.createElement('input');
      npcIdInput.type = 'text';
      npcIdInput.value = poi.npc_id ? `NPC ID: ${poi.npc_id}` : '';
      npcIdInput.dataset.field = 'npc_id';
      npcIdInput.dataset.original = poi.npc_id || '';
      npcIdInput.dataset.npcId = poi.npc_id || '';
      npcIdInput.placeholder = 'Select NPC';
      npcIdInput.style.cssText = 'flex: 1; min-width: 0;';
      npcIdInput.readOnly = true;
      
      const npcSelectBtn = document.createElement('button');
      npcSelectBtn.innerHTML = '🔍';
      npcSelectBtn.title = 'Select NPC';
      npcSelectBtn.style.cssText = 'padding: 2px 6px; font-size: 0.9rem; cursor: pointer; background: #3a3a3a; border: 1px solid #555; border-radius: 3px; color: #e0e0e0; transition: all 0.2s;';
      npcSelectBtn.onmouseover = () => { npcSelectBtn.style.background = '#4a4a4a'; npcSelectBtn.style.borderColor = '#666'; };
      npcSelectBtn.onmouseout = () => { npcSelectBtn.style.background = '#3a3a3a'; npcSelectBtn.style.borderColor = '#555'; };
      npcSelectBtn.onclick = () => openNPCSelector(poi.id, row);
      
      const npcClearBtn = document.createElement('button');
      npcClearBtn.innerHTML = '❌';
      npcClearBtn.title = 'Clear NPC';
      npcClearBtn.style.cssText = 'padding: 2px 6px; font-size: 0.8rem; cursor: pointer; background: #3a3a3a; border: 1px solid #555; border-radius: 3px; color: #e0e0e0; transition: all 0.2s;';
      npcClearBtn.onmouseover = () => { npcClearBtn.style.background = '#5a3a3a'; npcClearBtn.style.borderColor = '#666'; };
      npcClearBtn.onmouseout = () => { npcClearBtn.style.background = '#3a3a3a'; npcClearBtn.style.borderColor = '#555'; };
      npcClearBtn.onclick = () => {
        npcIdInput.value = '';
        npcIdInput.dataset.npcId = '';
        stagePOIChange(poi.id, 'npc_id', null);
      };
      
      npcIdContainer.appendChild(npcIdInput);
      npcIdContainer.appendChild(npcSelectBtn);
      if (poi.npc_id) {
        npcIdContainer.appendChild(npcClearBtn);
      }
      npcIdCell.appendChild(npcIdContainer);
      row.appendChild(npcIdCell);
      
      // Item ID cell
      const itemIdCell = document.createElement('td');
      const itemIdContainer = document.createElement('div');
      itemIdContainer.style.cssText = 'display: flex; align-items: center; gap: 4px;';
      
      const itemIdInput = document.createElement('input');
      itemIdInput.type = 'text';
      itemIdInput.value = poi.item_id ? `Item ID: ${poi.item_id}` : '';
      itemIdInput.dataset.field = 'item_id';
      itemIdInput.dataset.original = poi.item_id || '';
      itemIdInput.dataset.itemId = poi.item_id || '';
      itemIdInput.placeholder = 'Select Item';
      itemIdInput.style.cssText = 'flex: 1; min-width: 0;';
      itemIdInput.readOnly = true;
      
      const itemSelectBtn = document.createElement('button');
      itemSelectBtn.innerHTML = '🔍';
      itemSelectBtn.title = 'Select Item';
      itemSelectBtn.style.cssText = 'padding: 2px 6px; font-size: 0.9rem; cursor: pointer; background: #3a3a3a; border: 1px solid #555; border-radius: 3px; color: #e0e0e0; transition: all 0.2s;';
      itemSelectBtn.onmouseover = () => { itemSelectBtn.style.background = '#4a4a4a'; itemSelectBtn.style.borderColor = '#666'; };
      itemSelectBtn.onmouseout = () => { itemSelectBtn.style.background = '#3a3a3a'; itemSelectBtn.style.borderColor = '#555'; };
      itemSelectBtn.onclick = () => openItemSelector(poi.id, row);
      
      const itemClearBtn = document.createElement('button');
      itemClearBtn.innerHTML = '❌';
      itemClearBtn.title = 'Clear Item';
      itemClearBtn.style.cssText = 'padding: 2px 6px; font-size: 0.8rem; cursor: pointer; background: #3a3a3a; border: 1px solid #555; border-radius: 3px; color: #e0e0e0; transition: all 0.2s;';
      itemClearBtn.onmouseover = () => { itemClearBtn.style.background = '#5a3a3a'; itemClearBtn.style.borderColor = '#666'; };
      itemClearBtn.onmouseout = () => { itemClearBtn.style.background = '#3a3a3a'; itemClearBtn.style.borderColor = '#555'; };
      itemClearBtn.onclick = () => {
        itemIdInput.value = '';
        itemIdInput.dataset.itemId = '';
        stagePOIChange(poi.id, 'item_id', null);
      };
      
      itemIdContainer.appendChild(itemIdInput);
      itemIdContainer.appendChild(itemSelectBtn);
      if (poi.item_id) {
        itemIdContainer.appendChild(itemClearBtn);
      }
      itemIdCell.appendChild(itemIdContainer);
      row.appendChild(itemIdCell);
      
      // Created by cell (read-only)
      const createdByCell = document.createElement('td');
      createdByCell.textContent = poi.created_by_name || poi.created_by_user_id || 'System';
      createdByCell.style.color = '#999';
      createdByCell.style.fontSize = '0.85rem';
      row.appendChild(createdByCell);
      
      // Map cell (read-only)
      const mapCell = document.createElement('td');
      mapCell.textContent = poi.map_name || `Map ${poi.map_id}`;
      mapCell.style.color = '#999';
      mapCell.style.fontSize = '0.85rem';
      row.appendChild(mapCell);
      
      // Delete cell
      const deleteCell = document.createElement('td');
      deleteCell.style.textAlign = 'center';
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.textContent = '🗑️';
      deleteBtn.title = 'Mark for deletion';
      deleteBtn.onclick = () => toggleDeletePOI(poi.id);
      deleteCell.appendChild(deleteBtn);
      row.appendChild(deleteCell);
      
      // Apply any existing changes
      if (poiChanges.has(poi.id)) {
        const changes = poiChanges.get(poi.id);
        
        // Check if marked for deletion
        if (changes._delete) {
          row.classList.add('marked-for-deletion');
          deleteBtn.classList.add('undo');
          deleteBtn.textContent = '↩️';
          deleteBtn.title = 'Undo deletion';
        } else {
          // Apply other field changes
          Object.keys(changes).forEach(field => {
            if (field !== '_delete') {
              const cell = row.querySelector(`[data-field="${field}"]`);
              if (cell) {
                cell.parentElement.classList.add('cell-changed');
                cell.title = `Original: ${cell.dataset.original}`;
              }
            }
          });
        }
      }
      
      return row;
    }
    
    function createPOITypeSelect(poi) {
      // Create a custom dropdown container
      const container = document.createElement('div');
      container.className = 'custom-poi-type-select';
      container.style.position = 'relative';
      container.style.width = '100%';
      
      // Create the display element
      const display = document.createElement('div');
      display.className = 'custom-select-display';
      display.style.cssText = `
        padding: 0.35rem 2rem 0.35rem 0.5rem;
        border: 1px solid transparent;
        background: transparent;
        color: #e0e0e0;
        cursor: pointer;
        position: relative;
        min-height: 30px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      `;
      display.dataset.field = 'type_id';
      display.dataset.original = poi.type_id;
      
      // Add dropdown arrow
      const arrow = document.createElement('span');
      arrow.style.cssText = `
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
      `;
      arrow.textContent = '▼';
      display.appendChild(arrow);
      
      // Create dropdown list
      const dropdown = document.createElement('div');
      dropdown.className = 'custom-select-dropdown';
      dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #2d2d2d;
        border: 1px solid #555;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      `;
      
      // Set initial display
      const currentType = poiTypes.find(type => type.id === poi.type_id);
      if (currentType) {
        updateSelectDisplay(display, currentType);
      } else if (poi.type_id) {
        display.innerHTML = `<span style="color: #ff6666;">Unknown Type (${poi.type_id})</span>${arrow.outerHTML}`;
        container.classList.add('invalid-type');
      }
      
      // Add all POI types to dropdown
      poiTypes.forEach(type => {
        const item = document.createElement('div');
        item.className = 'custom-select-item';
        item.style.cssText = `
          padding: 0.5rem;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 0.5rem;
          transition: background 0.2s;
        `;
        item.dataset.value = type.id;
        
        // Add icon
        const iconSpan = document.createElement('span');
        iconSpan.style.minWidth = '24px';
        iconSpan.style.textAlign = 'center';
        
        if (type.icon_type === 'emoji') {
          iconSpan.textContent = type.icon_value;
          iconSpan.style.fontSize = '1.2rem';
        } else if (type.icon_type === 'iconify' || type.icon_type === 'fontawesome') {
          iconSpan.innerHTML = `<iconify-icon icon="${type.icon_value}" width="20" height="20"></iconify-icon>`;
        } else if (type.icon_type === 'upload' && type.icon_value) {
          iconSpan.innerHTML = `<img src="${type.icon_value}" style="width: 20px; height: 20px; object-fit: contain;">`;
        } else {
          iconSpan.textContent = '📍';
        }
        
        item.appendChild(iconSpan);
        item.appendChild(document.createTextNode(type.name));
        
        // Hover effect
        item.onmouseenter = () => item.style.background = 'rgba(74, 124, 89, 0.2)';
        item.onmouseleave = () => item.style.background = '';
        
        // Click handler
        item.onclick = () => {
          updateSelectDisplay(display, type);
          dropdown.style.display = 'none';
          stagePOIChange(poi.id, 'type_id', parseInt(type.id));
          updatePOIIconDisplay(poi.id, parseInt(type.id));
        };
        
        dropdown.appendChild(item);
      });
      
      // Toggle dropdown
      display.onclick = (e) => {
        e.stopPropagation();
        const isOpen = dropdown.style.display === 'block';
        // Close all other dropdowns
        document.querySelectorAll('.custom-select-dropdown').forEach(d => d.style.display = 'none');
        dropdown.style.display = isOpen ? 'none' : 'block';
      };
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });
      
      container.appendChild(display);
      container.appendChild(dropdown);
      
      return container;
    }
    
    function updateSelectDisplay(display, type) {
      // Clear current content except arrow
      const arrow = display.querySelector('span:last-child');
      display.innerHTML = '';
      
      // Add icon
      const iconSpan = document.createElement('span');
      iconSpan.style.minWidth = '24px';
      iconSpan.style.textAlign = 'center';
      
      if (type.icon_type === 'emoji') {
        iconSpan.textContent = type.icon_value;
        iconSpan.style.fontSize = '1.2rem';
      } else if (type.icon_type === 'iconify' || type.icon_type === 'fontawesome') {
        iconSpan.innerHTML = `<iconify-icon icon="${type.icon_value}" width="20" height="20"></iconify-icon>`;
      } else if (type.icon_type === 'upload' && type.icon_value) {
        iconSpan.innerHTML = `<img src="${type.icon_value}" style="width: 20px; height: 20px; object-fit: contain;">`;
      } else {
        iconSpan.textContent = '📍';
      }
      
      display.appendChild(iconSpan);
      display.appendChild(document.createTextNode(type.name));
      display.appendChild(arrow);
    }
    
    function renderPOIIcon(poi) {
      // First check if POI has a type_id and matching POI type
      if (poi.type_id) {
        const poiType = poiTypes.find(type => type.id === poi.type_id);
        
        if (poiType) {
          if (poiType.icon_type === 'emoji') {
            return `<span style="font-size: 1.5rem;">${poiType.icon_value}</span>`;
          } else if (poiType.icon_type === 'iconify' || poiType.icon_type === 'fontawesome') {
            return `<iconify-icon icon="${poiType.icon_value}" width="24" height="24"></iconify-icon>`;
          } else if (poiType.icon_type === 'upload' && poiType.icon_value) {
            return `<img src="${poiType.icon_value}" style="width: 24px; height: 24px; object-fit: contain;" onerror="this.style.display='none'; this.parentElement.innerHTML='📍';">`;
          }
        } else {
          // Type ID exists but no matching type found
          return '<span style="color: #ff6666; font-size: 1.2rem;" title="Unknown POI Type">❓</span>';
        }
      }
      
      // Fallback to POI's own icon if no type
      if (poi.icon) {
        // Check if it's an emoji or custom icon
        if (poi.icon.length <= 4 && !poi.icon.includes('<')) {
          return `<span style="font-size: 1.5rem;">${poi.icon}</span>`;
        } else if (poi.custom_icon) {
          // Custom icon HTML
          return poi.icon;
        }
      }
      
      // Default icon
      return '<span style="font-size: 1.5rem;">📍</span>';
    }
    
    function updatePOIIconDisplay(poiId, typeId) {
      const row = document.querySelector(`tr[data-poi-id="${poiId}"]`);
      if (!row) return;
      
      const iconCell = row.querySelector('.poi-type-icon');
      const poi = filteredPOIs.find(p => p.id === poiId);
      if (!poi || !iconCell) return;
      
      poi.type_id = typeId;
      iconCell.innerHTML = renderPOIIcon(poi);
    }
    
    function handleCellKeypress(e, poiId) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const field = e.target.dataset.field;
        let value = e.target.value;
        
        if (field === 'x' || field === 'y') {
          value = parseFloat(value);
        }
        
        stagePOIChange(poiId, field, value);
        
        // Move to next cell on Enter
        const allInputs = Array.from(document.querySelectorAll('.poi-editor-table input:not([readonly]), .poi-editor-table textarea, .poi-editor-table select'));
        const currentIndex = allInputs.indexOf(e.target);
        if (currentIndex < allInputs.length - 1) {
          allInputs[currentIndex + 1].focus();
        } else {
          e.target.blur();
        }
      } else if (e.key === 'Tab') {
        // Let default tab behavior work, but ensure changes are staged
        setTimeout(() => {
          const field = e.target.dataset.field;
          let value = e.target.value;
          
          if (field === 'x' || field === 'y') {
            value = parseFloat(value);
          }
          
          stagePOIChange(poiId, field, value);
        }, 0);
      }
    }
    
    function stagePOIChange(poiId, field, newValue) {
      const row = document.querySelector(`tr[data-poi-id="${poiId}"]`);
      if (!row) {
        console.error(`Could not find row for POI ${poiId}`);
        return;
      }
      let cell = row.querySelector(`[data-field="${field}"]`);
      
      // For custom dropdowns, the data-field is on the display div
      if (!cell) {
        cell = row.querySelector(`.custom-select-display[data-field="${field}"]`);
      }
      
      if (!cell) {
        console.error(`Could not find cell for field ${field} in POI ${poiId}`);
        return;
      }
      
      const originalValue = cell.dataset.original;
      
      // Convert original value to appropriate type for comparison
      let originalTyped = originalValue;
      if (field === 'type_id' || field === 'icon_size' || field === 'npc_id' || field === 'item_id') {
        originalTyped = originalValue ? parseInt(originalValue) : null;
      }
      
      // Check if value actually changed
      if (newValue === originalTyped || (newValue === null && originalTyped === null) || (newValue === '' && originalTyped === '')) {
        // Remove the change if it's back to original
        if (poiChanges.has(poiId)) {
          const changes = poiChanges.get(poiId);
          delete changes[field];
          
          if (Object.keys(changes).length === 0) {
            poiChanges.delete(poiId);
          }
        }
        
        // For npc_id and item_id, the parent is the container div, then td
        let cellElement;
        if (field === 'npc_id' || field === 'item_id') {
          // Find the parent TD element more reliably
          cellElement = cell.closest('td');
        } else {
          cellElement = cell.parentElement;
        }
        
        if (cellElement) {
          cellElement.classList.remove('cell-changed');
        }
        cell.title = '';
      } else {
        // Stage the change
        if (!poiChanges.has(poiId)) {
          poiChanges.set(poiId, {});
        }
        
        poiChanges.get(poiId)[field] = newValue;
        // For npc_id and item_id, the parent is the container div, then td
        let cellElement;
        if (field === 'npc_id' || field === 'item_id') {
          // Find the parent TD element more reliably
          cellElement = cell.closest('td');
        } else {
          cellElement = cell.parentElement;
        }
        
        if (cellElement) {
          cellElement.classList.add('cell-changed');
        }
        cell.title = `Original: ${originalValue}`;
      }
      
      updateChangeButtons();
      updateStats();
    }
    
    function updateChangeButtons() {
      const hasChanges = poiChanges.size > 0;
      document.getElementById('poi-save-btn').disabled = !hasChanges;
      document.getElementById('poi-reset-btn').disabled = !hasChanges;
      
      const changeCount = poiChanges.size;
      document.getElementById('poi-change-count').textContent = changeCount;
    }
    
    async function savePOIChanges() {
      const changeCount = poiChanges.size;
      
      if (changeCount === 0) return;
      
      if (!confirm(`Save changes to ${changeCount} POI${changeCount !== 1 ? 's' : ''}?`)) {
        return;
      }
      
      // Separate updates and deletes
      const updates = [];
      const deletes = [];
      
      poiChanges.forEach((changes, poiId) => {
        if (changes._delete) {
          deletes.push(poiId);
        } else {
          updates.push({
            id: poiId,
            ...changes
          });
        }
      });
      
      try {
        let totalUpdated = 0;
        let totalDeleted = 0;
        
        // Process updates if any
        if (updates.length > 0) {
          const response = await window.csrfHelper.fetchWithCSRF('/api/pois/batch-update', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates })
          });
          
          if (response.ok) {
            const result = await response.json();
            totalUpdated = result.updated;
          } else {
            const error = await response.json();
            showMessage(error.error || 'Failed to save changes', 'error');
            return;
          }
        }
        
        // Process deletes if any
        if (deletes.length > 0) {
          const deleteResponse = await window.csrfHelper.fetchWithCSRF('/api/pois/batch-delete', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: deletes })
          });
          
          if (deleteResponse.ok) {
            const result = await deleteResponse.json();
            totalDeleted = result.deleted;
          } else {
            const error = await deleteResponse.json();
            showMessage(error.error || 'Failed to delete POIs', 'error');
            return;
          }
        }
        
        // Show success message
        const messages = [];
        if (totalUpdated > 0) messages.push(`${totalUpdated} POI${totalUpdated !== 1 ? 's' : ''} updated`);
        if (totalDeleted > 0) messages.push(`${totalDeleted} POI${totalDeleted !== 1 ? 's' : ''} deleted`);
        showMessage(`Successfully ${messages.join(' and ')}`, 'success');
        
        // Clear changes and reload
        poiChanges.clear();
        updateChangeButtons();
        await reloadPOIEditor();
      } catch (error) {
        console.error('Error saving POI changes:', error);
        showMessage('Failed to save changes', 'error');
      }
    }
    
    function resetPOIChanges() {
      if (poiChanges.size === 0) return;
      
      if (!confirm('Discard all unsaved changes?')) {
        return;
      }
      
      // Reset all changed cells to their original values
      poiChanges.forEach((changes, poiId) => {
        const row = document.querySelector(`tr[data-poi-id="${poiId}"]`);
        if (!row) return;
        
        Object.keys(changes).forEach(field => {
          const cell = row.querySelector(`[data-field="${field}"]`);
          if (!cell) return;
          
          const originalValue = cell.dataset.original;
          
          if (cell.tagName === 'INPUT' && cell.type === 'checkbox') {
            cell.checked = originalValue === 'true' || originalValue === true;
          } else if (cell.tagName === 'SELECT') {
            cell.value = originalValue;
          } else {
            cell.value = originalValue;
          }
          
          cell.parentElement.classList.remove('cell-changed');
          cell.title = '';
        });
      });
      
      poiChanges.clear();
      updateChangeButtons();
      showMessage('Changes discarded', 'info');
    }
    
    function toggleDeletePOI(poiId) {
      const row = document.querySelector(`tr[data-poi-id="${poiId}"]`);
      const deleteBtn = row.querySelector('.delete-btn');
      
      if (!poiChanges.has(poiId)) {
        poiChanges.set(poiId, {});
      }
      
      const changes = poiChanges.get(poiId);
      
      if (changes._delete) {
        // Undo deletion
        delete changes._delete;
        row.classList.remove('marked-for-deletion');
        deleteBtn.classList.remove('undo');
        deleteBtn.textContent = '🗑️';
        deleteBtn.title = 'Mark for deletion';
        
        // Remove all inputs from being disabled
        row.querySelectorAll('input, textarea, select, .custom-select-display').forEach(input => {
          input.style.pointerEvents = '';
          input.style.opacity = '';
        });
        
        // If no other changes, remove from change map
        if (Object.keys(changes).length === 0) {
          poiChanges.delete(poiId);
        }
      } else {
        // Mark for deletion
        changes._delete = true;
        row.classList.add('marked-for-deletion');
        deleteBtn.classList.add('undo');
        deleteBtn.textContent = '↩️';
        deleteBtn.title = 'Undo deletion';
        
        // Clear any other changes for this POI
        Object.keys(changes).forEach(field => {
          if (field !== '_delete') {
            delete changes[field];
          }
        });
        
        // Remove cell-changed classes
        row.querySelectorAll('.cell-changed').forEach(cell => {
          cell.classList.remove('cell-changed');
          cell.title = '';
        });
      }
      
      updateChangeButtons();
      updateStats();
    }
    
    async function reloadPOIEditor() {
      const reloadBtn = event?.target?.closest('button') || document.querySelector('button[onclick="reloadPOIEditor()"]');
      const originalContent = reloadBtn.innerHTML;
      
      // Show loading state
      reloadBtn.disabled = true;
      reloadBtn.innerHTML = '<span class="loading-spinner" style="margin-right: 0.5rem;">⏳</span>Loading...';
      
      // Add loading overlay to table
      const tableContainer = document.querySelector('.poi-editor-table-container');
      if (tableContainer) {
        const overlay = document.createElement('div');
        overlay.className = 'poi-editor-loading-overlay';
        overlay.innerHTML = '<div style="text-align: center; color: white;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">⏳</div><div>Reloading POIs...</div></div>';
        tableContainer.appendChild(overlay);
      }
      
      try {
        poiChanges.clear();
        updateChangeButtons();
        await loadPOIEditor();
        
        // Remove overlay
        const overlay = tableContainer?.querySelector('.poi-editor-loading-overlay');
        if (overlay) overlay.remove();
        
        // Show success briefly
        reloadBtn.innerHTML = '<span style="margin-right: 0.5rem;">✅</span>Reloaded!';
        setTimeout(() => {
          reloadBtn.innerHTML = originalContent;
          reloadBtn.disabled = false;
        }, 1000);
      } catch (error) {
        // Show error
        reloadBtn.innerHTML = '<span style="margin-right: 0.5rem;">❌</span>Failed';
        setTimeout(() => {
          reloadBtn.innerHTML = originalContent;
          reloadBtn.disabled = false;
        }, 2000);
      }
    }
    
    // Search and filter functionality
    let searchTerm = '';
    let sortField = null;
    let sortDirection = 'asc';
    
    function searchPOIs() {
      // Check for unsaved changes before searching (which might hide edited rows)
      if (poiChanges.size > 0) {
        const searchInput = document.getElementById('poi-search');
        const newSearchTerm = searchInput.value.toLowerCase();
        
        // Only warn if the search would actually filter results
        if (newSearchTerm && newSearchTerm !== searchTerm) {
          if (!confirm('You have unsaved changes. Searching may hide rows with pending edits. Continue?')) {
            searchInput.value = searchTerm; // Reset to previous search term
            return;
          }
        }
      }
      
      searchTerm = document.getElementById('poi-search').value.toLowerCase();
      currentPOIEditorPage = 0;
      applySearchFilter();
    }
    
    function applySearchFilter() {
      const mapId = document.getElementById('poi-map-filter').value;
      
      // Start with map-filtered POIs
      let filtered = mapId === 'all' ? [...allPOIs] : allPOIs.filter(poi => poi.map_id === parseInt(mapId));
      
      // Apply search filter
      if (searchTerm) {
        filtered = filtered.filter(poi => {
          const searchableFields = [
            poi.id?.toString(),
            poi.name,
            poi.description,
            poi.created_by_name,
            poi.poi_type_name
          ].filter(Boolean).map(field => field.toLowerCase());
          
          return searchableFields.some(field => field.includes(searchTerm));
        });
      }
      
      // Apply sorting
      if (sortField) {
        filtered.sort((a, b) => {
          let aVal = a[sortField];
          let bVal = b[sortField];
          
          // Handle null/undefined values
          if (aVal == null) aVal = '';
          if (bVal == null) bVal = '';
          
          // Handle different data types
          if (typeof aVal === 'boolean') {
            aVal = aVal ? 1 : 0;
            bVal = bVal ? 1 : 0;
          }
          
          if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
          }
          
          if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
          if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
          return 0;
        });
      }
      
      filteredPOIs = filtered;
      displayPOIEditor();
      updateStats();
    }
    
    function updateStats() {
      document.getElementById('poi-total-count').textContent = allPOIs.length;
      document.getElementById('poi-filtered-count').textContent = filteredPOIs.length;
      document.getElementById('poi-pending-count').textContent = poiChanges.size;
    }
    
    // Export functionality
    function exportPOIsToCSV() {
      const headers = ['ID', 'Name', 'Description', 'Type', 'Icon Size', 'Created By', 'Map'];
      const rows = filteredPOIs.map(poi => [
        poi.id,
        poi.name || '',
        poi.description || '',
        poi.poi_type_name || '',
        poi.icon_size || 34,
        poi.created_by_name || '',
        poi.map_name || ''
      ]);
      
      // Convert to CSV format
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => {
          // Escape quotes and wrap in quotes if contains comma or newline
          const cellStr = String(cell);
          if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
            return '"' + cellStr.replace(/"/g, '""') + '"';
          }
          return cellStr;
        }).join(','))
      ].join('\n');
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `pois_export_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function updatePOIEditorPagination(totalPages) {
      const paginationDiv = document.getElementById('poi-editor-pagination');
      
      if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
      }
      
      paginationDiv.style.display = 'block';
      paginationDiv.innerHTML = '';
      
      // Create pagination buttons similar to POI types pagination
      const createButton = (text, page, disabled = false) => {
        const btn = document.createElement('button');
        btn.className = 'pagination-btn';
        btn.textContent = text;
        btn.disabled = disabled;
        if (page === currentPOIEditorPage) {
          btn.className += ' active';
        }
        btn.onclick = () => {
          // Check for unsaved changes before changing page
          if (poiChanges.size > 0) {
            if (!confirm('You have unsaved changes. Are you sure you want to change pages? Your changes will be lost.')) {
              return;
            }
            // Clear changes if user confirms
            poiChanges.clear();
            updateChangeButtons();
            updateStats();
          }
          currentPOIEditorPage = page;
          displayPOIEditor();
        };
        return btn;
      };
      
      // First/Previous buttons
      paginationDiv.appendChild(createButton('«', 0, currentPOIEditorPage === 0));
      paginationDiv.appendChild(createButton('‹', currentPOIEditorPage - 1, currentPOIEditorPage === 0));
      
      // Page numbers
      const maxVisible = 5;
      let startPage = Math.max(0, currentPOIEditorPage - Math.floor(maxVisible / 2));
      let endPage = Math.min(totalPages - 1, startPage + maxVisible - 1);
      
      if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(0, endPage - maxVisible + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        paginationDiv.appendChild(createButton(i + 1, i));
      }
      
      // Next/Last buttons
      paginationDiv.appendChild(createButton('›', currentPOIEditorPage + 1, currentPOIEditorPage === totalPages - 1));
      paginationDiv.appendChild(createButton('»', totalPages - 1, currentPOIEditorPage === totalPages - 1));
    }

    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        if (event.target.id === 'share-code-modal') {
          closeShareCodeModal();
        } else if (event.target.id === 'add-shared-poi-modal') {
          closeAddSharedPOIModal();
        } else if (event.target.id === 'share-users-modal') {
          closeShareUsersModal();
        } else if (event.target.id === 'poi-type-modal') {
          closePOITypeModal();
        } else if (event.target.id === 'npc-selector-modal') {
          closeNPCSelector();
        } else if (event.target.id === 'item-selector-modal') {
          closeItemSelector();
        }
      }
    });
    
    // NPC Selector for POI Editor
    let currentPOIForNPC = null;
    let currentPOIRow = null;
    
    function openNPCSelector(poiId, row) {
      currentPOIForNPC = poiId;
      currentPOIRow = row;
      
      // Create modal
      const modalHtml = `
        <div class="modal" id="npc-selector-modal" style="display: block;">
          <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
            <div class="modal-header">
              <h2>Select NPC</h2>
              <button class="close-btn" onclick="closeNPCSelector()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem;">
              <div style="margin-bottom: 1rem;">
                <input type="text" id="npc-selector-search" placeholder="Search NPCs by name or ID..." 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #2d2d2d; color: #e0e0e0;"
                       oninput="filterNPCsInSelector()">
              </div>
              <div id="npc-selector-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #444; border-radius: 4px;">
                <div style="text-align: center; padding: 2rem; color: #666;">Loading NPCs...</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHtml;
      document.body.appendChild(modalContainer.firstElementChild);
      
      // Load NPCs
      loadNPCsForSelector();
    }
    
    async function loadNPCsForSelector() {
      try {
        const response = await fetch('/api/npcs');
        if (response.ok) {
          const npcs = await response.json();
          displayNPCsInSelector(npcs);
        }
      } catch (error) {
        console.error('Error loading NPCs:', error);
        document.getElementById('npc-selector-list').innerHTML = 
          '<div style="text-align: center; padding: 2rem; color: #dc3545;">Failed to load NPCs</div>';
      }
    }
    
    function displayNPCsInSelector(npcs) {
      const listDiv = document.getElementById('npc-selector-list');
      if (npcs.length === 0) {
        listDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No NPCs found</div>';
        return;
      }
      
      listDiv.innerHTML = npcs.map(npc => `
        <div class="npc-selector-item" onclick="selectNPC(${npc.id}, ${npc.npcid}, '${npc.name.replace(/'/g, "\\'")}')"
             style="padding: 0.75rem; border-bottom: 1px solid #444; cursor: pointer; transition: background 0.2s;"
             onmouseover="this.style.background='#3a3a3a'" onmouseout="this.style.background='transparent'">
          <div style="display: flex; justify-content: between; align-items: center;">
            <div>
              <strong>${npc.name}</strong> 
              <span style="color: #666; margin-left: 0.5rem;">NPC ID: ${npc.npcid}</span>
            </div>
            <div style="color: #999; font-size: 0.85rem;">
              Level ${npc.level} ${npc.npc_type}
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function filterNPCsInSelector() {
      const search = document.getElementById('npc-selector-search').value.toLowerCase();
      const items = document.querySelectorAll('.npc-selector-item');
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? 'block' : 'none';
      });
    }
    
    function selectNPC(id, npcid, name) {
      if (currentPOIForNPC && currentPOIRow) {
        // Update the input display
        const npcInput = currentPOIRow.querySelector('[data-field="npc_id"]');
        if (npcInput) {
          npcInput.value = `${name} (${npcid})`;
          npcInput.dataset.npcId = npcid;
          stagePOIChange(currentPOIForNPC, 'npc_id', npcid);
          
          // Add clear button if not already present
          const container = npcInput.parentElement;
          if (!container.querySelector('button[title="Clear NPC"]')) {
            const clearBtn = document.createElement('button');
            clearBtn.innerHTML = '❌';
            clearBtn.title = 'Clear NPC';
            clearBtn.style.cssText = 'padding: 2px 6px; font-size: 0.8rem; cursor: pointer; background: #3a3a3a; border: 1px solid #555; border-radius: 3px; color: #e0e0e0; transition: all 0.2s;';
            clearBtn.onmouseover = () => { clearBtn.style.background = '#5a3a3a'; clearBtn.style.borderColor = '#666'; };
            clearBtn.onmouseout = () => { clearBtn.style.background = '#3a3a3a'; clearBtn.style.borderColor = '#555'; };
            clearBtn.onclick = () => {
              npcInput.value = '';
              npcInput.dataset.npcId = '';
              stagePOIChange(currentPOIForNPC, 'npc_id', null);
              clearBtn.remove();
            };
            container.appendChild(clearBtn);
          }
          
          // Clear item_id if set
          const itemInput = currentPOIRow.querySelector('[data-field="item_id"]');
          if (itemInput && itemInput.value) {
            itemInput.value = '';
            itemInput.dataset.itemId = '';
            stagePOIChange(currentPOIForNPC, 'item_id', null);
            // Remove item clear button
            const itemClearBtn = itemInput.parentElement.querySelector('button[title="Clear Item"]');
            if (itemClearBtn) itemClearBtn.remove();
          }
        }
      }
      closeNPCSelector();
    }
    
    function closeNPCSelector() {
      const modal = document.getElementById('npc-selector-modal');
      if (modal) modal.remove();
      currentPOIForNPC = null;
      currentPOIRow = null;
    }
    window.closeNPCSelector = closeNPCSelector;
    window.filterNPCsInSelector = filterNPCsInSelector;
    window.selectNPC = selectNPC;
    
    // Item Selector for POI Editor
    let currentPOIForItem = null;
    let currentPOIRowForItem = null;
    
    function openItemSelector(poiId, row) {
      currentPOIForItem = poiId;
      currentPOIRowForItem = row;
      
      // Create modal
      const modalHtml = `
        <div class="modal" id="item-selector-modal" style="display: block;">
          <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
            <div class="modal-header">
              <h2>Select Item</h2>
              <button class="close-btn" onclick="closeItemSelector()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem;">
              <div style="margin-bottom: 1rem;">
                <input type="text" id="item-selector-search" placeholder="Search items by name or ID..." 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #555; border-radius: 4px; background: #2d2d2d; color: #e0e0e0;"
                       oninput="filterItemsInSelector()">
              </div>
              <div id="item-selector-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #444; border-radius: 4px;">
                <div style="text-align: center; padding: 2rem; color: #666;">Loading items...</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHtml;
      document.body.appendChild(modalContainer.firstElementChild);
      
      // Load items
      loadItemsForSelector();
    }
    
    async function loadItemsForSelector() {
      try {
        const response = await fetch('/api/items');
        if (response.ok) {
          const items = await response.json();
          displayItemsInSelector(items);
        }
      } catch (error) {
        console.error('Error loading items:', error);
        document.getElementById('item-selector-list').innerHTML = 
          '<div style="text-align: center; padding: 2rem; color: #dc3545;">Failed to load items</div>';
      }
    }
    
    function displayItemsInSelector(items) {
      const listDiv = document.getElementById('item-selector-list');
      if (items.length === 0) {
        listDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No items found</div>';
        return;
      }
      
      listDiv.innerHTML = items.map(item => `
        <div class="item-selector-item" onclick="selectItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')"
             style="padding: 0.75rem; border-bottom: 1px solid #444; cursor: pointer; transition: background 0.2s;"
             onmouseover="this.style.background='#3a3a3a'" onmouseout="this.style.background='transparent'">
          <div style="display: flex; justify-content: between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              ${item.icon_type === 'emoji' ? 
                `<span style="font-size: 1.5rem;">${item.icon_value}</span>` :
                `<iconify-icon icon="${item.icon_value}" width="24"></iconify-icon>`
              }
              <div>
                <strong>${item.name}</strong>
                <span style="color: #666; margin-left: 0.5rem;">ID: ${item.id}</span>
              </div>
            </div>
            <div style="color: #999; font-size: 0.85rem;">
              ${item.slot || 'No slot'} - ${item.item_type || 'Unknown type'}
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function filterItemsInSelector() {
      const search = document.getElementById('item-selector-search').value.toLowerCase();
      const items = document.querySelectorAll('.item-selector-item');
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? 'block' : 'none';
      });
    }
    
    function selectItem(id, name) {
      if (currentPOIForItem && currentPOIRowForItem) {
        // Update the input display
        const itemInput = currentPOIRowForItem.querySelector('[data-field="item_id"]');
        if (itemInput) {
          itemInput.value = `${name} (${id})`;
          itemInput.dataset.itemId = id;
          stagePOIChange(currentPOIForItem, 'item_id', id);
          
          // Add clear button if not already present
          const container = itemInput.parentElement;
          if (!container.querySelector('button[title="Clear Item"]')) {
            const clearBtn = document.createElement('button');
            clearBtn.innerHTML = '❌';
            clearBtn.title = 'Clear Item';
            clearBtn.style.cssText = 'padding: 2px 6px; font-size: 0.8rem; cursor: pointer; background: #3a3a3a; border: 1px solid #555; border-radius: 3px; color: #e0e0e0; transition: all 0.2s;';
            clearBtn.onmouseover = () => { clearBtn.style.background = '#5a3a3a'; clearBtn.style.borderColor = '#666'; };
            clearBtn.onmouseout = () => { clearBtn.style.background = '#3a3a3a'; clearBtn.style.borderColor = '#555'; };
            clearBtn.onclick = () => {
              itemInput.value = '';
              itemInput.dataset.itemId = '';
              stagePOIChange(currentPOIForItem, 'item_id', null);
              clearBtn.remove();
            };
            container.appendChild(clearBtn);
          }
          
          // Clear npc_id if set
          const npcInput = currentPOIRowForItem.querySelector('[data-field="npc_id"]');
          if (npcInput && npcInput.value) {
            npcInput.value = '';
            npcInput.dataset.npcId = '';
            stagePOIChange(currentPOIForItem, 'npc_id', null);
            // Remove NPC clear button
            const npcClearBtn = npcInput.parentElement.querySelector('button[title="Clear NPC"]');
            if (npcClearBtn) npcClearBtn.remove();
          }
        }
      }
      closeItemSelector();
    }
    
    function closeItemSelector() {
      const modal = document.getElementById('item-selector-modal');
      if (modal) modal.remove();
      currentPOIForItem = null;
      currentPOIRowForItem = null;
    }
    window.closeItemSelector = closeItemSelector;
    window.filterItemsInSelector = filterItemsInSelector;
    window.selectItem = selectItem;
  </script>

  <!-- Create Proposal Modal -->
  <div id="create-proposal-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Create Change Proposal</h2>
        <button class="close-btn" onclick="closeCreateProposalModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Change Type</label>
          <select id="proposal-change-type" class="form-control" onchange="updateProposalForm()">
            <option value="">Select a type...</option>
            <option value="edit_poi">Edit POI</option>
            <option value="add_npc">New NPC</option>
            <option value="edit_npc">Edit NPC</option>
            <option value="add_item">New Item</option>
            <option value="edit_item">Edit Item</option>
          </select>
        </div>
        
        <div id="proposal-form-content" style="display: none;">
          <!-- Dynamic form content based on change type -->
        </div>
        
        <div class="form-group" style="margin-top: 1rem;">
          <label>Notes / Reason for Change</label>
          <textarea id="proposal-notes" class="form-control" rows="3" placeholder="Explain why this change should be made..."></textarea>
        </div>
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
          <button class="btn secondary-btn" onclick="closeCreateProposalModal()">Cancel</button>
          <button class="btn btn-primary" onclick="submitProposal()">Submit Proposal</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Proposal Review Modal -->
  <div id="admin-proposal-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>Admin Review - Change Proposal</h2>
        <button class="close-btn" onclick="closeAdminProposalModal()">&times;</button>
      </div>
      <div class="modal-body" id="admin-proposal-content">
        <!-- Content loaded dynamically -->
      </div>
    </div>
  </div>
  
  <!-- Custom Confirmation Dialog -->
  <div id="confirmDialog" class="confirm-dialog-overlay" style="display: none;">
    <div class="confirm-dialog">
      <h3 class="confirm-dialog-title">Confirm Action</h3>
      <p class="confirm-dialog-message"></p>
      <div class="confirm-dialog-buttons">
        <button class="confirm-dialog-btn confirm-dialog-btn-cancel">Cancel</button>
        <button class="confirm-dialog-btn confirm-dialog-btn-confirm">Confirm</button>
      </div>
    </div>
  </div>
</body>
</html>