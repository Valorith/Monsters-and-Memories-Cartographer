<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accept Shared POI - MMC</title>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FS1GD2527L"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FS1GD2527L');
  </script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .share-container {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 3rem;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    h1 {
      font-family: 'Cinzel', serif;
      font-size: 2rem;
      background: linear-gradient(135deg, #FFD700, #FFA500, #FF8C00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 2rem;
    }
    
    .loading {
      color: #999;
      font-size: 1.1rem;
    }
    
    .poi-info {
      background: #3a3a3a;
      border-radius: 6px;
      padding: 2rem;
      margin: 2rem 0;
    }
    
    .poi-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .poi-name {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #FFD700;
    }
    
    .poi-owner {
      color: #999;
      margin-bottom: 1rem;
    }
    
    .btn {
      background: #4a7c59;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      margin: 0.5rem;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn:hover {
      background: #3a6249;
    }
    
    .btn-secondary {
      background: #666;
    }
    
    .btn-secondary:hover {
      background: #777;
    }
    
    .error {
      background: #dc3545;
      color: white;
      padding: 1rem;
      border-radius: 6px;
      margin: 2rem 0;
    }
    
    .success {
      background: #4a7c59;
      color: white;
      padding: 1rem;
      border-radius: 6px;
      margin: 2rem 0;
    }
  </style>
  <script src="/safe-html.js"></script>
  <script src="/csrf-helper.js"></script>
</head>
<body>
  <div class="share-container">
    <h1>Shared POI</h1>
    
    <div id="loading" class="loading">
      Loading share information...
    </div>
    
    <div id="content" style="display: none;">
      <div id="poi-info" class="poi-info" style="display: none;">
        <div id="poi-icon" class="poi-icon"></div>
        <div id="poi-name" class="poi-name"></div>
        <div id="poi-owner" class="poi-owner"></div>
      </div>
      
      <div id="message"></div>
      
      <div id="actions" style="display: none;">
        <button id="accept-btn" class="btn" onclick="acceptShare()">Accept Share</button>
        <a href="/" class="btn btn-secondary">Go to Maps</a>
      </div>
      
      <div id="login-prompt" style="display: none;">
        <p style="margin-bottom: 2rem;">Please sign in to accept this shared POI.</p>
        <a href="/auth/google" class="btn">Sign In with Google</a>
      </div>
    </div>
  </div>

  <script>
    const shareCode = window.location.pathname.split('/').pop();
    let isAuthenticated = false;
    let poiData = null;

    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        isAuthenticated = data.authenticated;
        return data.authenticated;
      } catch (error) {
        return false;
      }
    }

    async function loadShareInfo() {
      // Parse the share code to get POI info
      const [poiId] = shareCode.split('-');
      
      if (!poiId || isNaN(poiId)) {
        showError('Invalid share link');
        return;
      }

      // For now, show basic info
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      
      if (isAuthenticated) {
        document.getElementById('actions').style.display = 'block';
        if (window.setInnerHTML) {
          window.setInnerHTML('message', '<p>Click "Accept Share" to add this POI to your account.</p>');
        } else {
          document.getElementById('message').innerHTML = '<p>Click "Accept Share" to add this POI to your account.</p>';
        }
      } else {
        document.getElementById('login-prompt').style.display = 'block';
      }
    }

    async function acceptShare() {
      document.getElementById('accept-btn').disabled = true;
      
      try {
        const response = await fetchWithCSRF(`/api/share/${shareCode}/accept`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showSuccess(data.message);
          if (window.setInnerHTML) {
            window.setInnerHTML('actions', `
              <a href="/account" class="btn">View in Account</a>
              <a href="/" class="btn btn-secondary">Go to Maps</a>
            `);
          } else {
            // Fallback - this HTML is safe as it's hardcoded
            document.getElementById('actions').innerHTML = `
              <a href="/account" class="btn">View in Account</a>
              <a href="/" class="btn btn-secondary">Go to Maps</a>
            `;
          }
        } else {
          showError(data.error);
          document.getElementById('accept-btn').disabled = false;
        }
      } catch (error) {
        showError('Failed to accept share');
        document.getElementById('accept-btn').disabled = false;
      }
    }

    function showError(message) {
      const messageEl = document.getElementById('message');
      if (window.escapeHTML) {
        messageEl.innerHTML = `<div class="error">${window.escapeHTML(message)}</div>`;
      } else {
        // Fallback - create elements safely
        messageEl.innerHTML = '';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        messageEl.appendChild(errorDiv);
      }
    }

    function showSuccess(message) {
      const messageEl = document.getElementById('message');
      if (window.escapeHTML) {
        messageEl.innerHTML = `<div class="success">${window.escapeHTML(message)}</div>`;
      } else {
        // Fallback - create elements safely
        messageEl.innerHTML = '';
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message;
        messageEl.appendChild(successDiv);
      }
    }

    // Initialize
    (async () => {
      await checkAuth();
      await loadShareInfo();
    })();
  </script>
</body>
</html>